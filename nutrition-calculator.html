<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrition Calculator - LongevityPath</title>

    <!-- Shared Brand Styles (includes Inter font) -->
    <link rel="stylesheet" href="brand.css">

    <!-- Lucide Icons (consistent with rest of app) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* ===========================================
           Calculator-specific styles
           Uses brand.css variables & classes as base
           =========================================== */

        /* Input Grid Layouts */
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .input-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .input-row-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .input-row-4 { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 600px) {
            .input-row, .input-row-3, .input-row-4 { grid-template-columns: 1fr; }
        }

        /* Form Groups */
        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-size: 0.9rem;
            color: var(--color-text);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .input-hint {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            margin-top: 4px;
        }

        .help-link-inline {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: var(--color-teal);
            color: white;
            border-radius: var(--radius-full);
            font-size: 0.7rem;
            font-weight: 600;
            text-decoration: none;
            vertical-align: middle;
            margin-left: 4px;
        }

        .help-link-inline:hover {
            opacity: 0.85;
            text-decoration: none;
        }

        .help-link-inline.help-link-lg {
            width: 30px;
            height: 30px;
            font-size: 1rem;
            background: var(--color-teal);
            color: white;
        }

        .help-link-inline.help-link-lg:hover {
            opacity: 0.85;
        }

        /* Results Section */
        .results-card {
            display: none;
        }

        .results-card.visible {
            display: block;
        }

        .results-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .results-header h2 {
            color: var(--color-text);
            margin-bottom: 12px;
        }

        /* Badges */
        .goal-badge {
            display: inline-block;
            background: var(--color-teal);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .timeline-badge {
            display: inline-block;
            background: var(--color-orange);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        /* Results Grid */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        @media (max-width: 500px) {
            .results-grid { grid-template-columns: 1fr; }
        }

        .result-box {
            background: var(--color-bg);
            padding: 20px;
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .result-box.highlight {
            background: var(--color-teal-light);
            border: 2px solid var(--color-teal);
        }

        .result-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--color-teal);
        }

        .result-unit {
            font-size: 1rem;
            color: var(--color-text-muted);
        }

        .result-label {
            font-size: 0.85rem;
            color: var(--color-text-muted);
            margin-top: 4px;
        }

        /* Body Composition Summary */
        .composition-summary {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: center;
            background: var(--color-bg);
            padding: 20px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .composition-summary {
                grid-template-columns: 1fr;
                text-align: center;
            }
            .composition-arrow { transform: rotate(90deg); }
        }

        .composition-box { text-align: center; }

        .composition-box .label {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            margin-bottom: 4px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .composition-box .weight {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--color-teal);
        }

        .composition-box .detail {
            font-size: 0.82rem;
            color: var(--color-text-muted);
        }

        .composition-arrow {
            font-size: 2rem;
            color: var(--color-orange);
        }

        /* Change Summary */
        .change-summary {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .change-item {
            text-align: center;
            padding: 8px 16px;
            border-radius: var(--radius-xs);
        }

        .change-item.fat-loss {
            background: var(--color-teal-light);
            color: var(--color-teal);
        }

        .change-item.muscle-gain {
            background: var(--color-teal-light);
            color: var(--color-teal);
        }

        .change-item .value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .change-item .label {
            font-size: 0.8rem;
        }

        /* Meal Breakdown */
        .meal-breakdown {
            background: var(--color-bg);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
        }

        .meal-breakdown h4 {
            color: var(--color-text);
            margin-bottom: 12px;
        }

        .meal-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--color-border);
            font-size: 0.9rem;
        }

        .meal-row:last-child { border-bottom: none; }

        .meal-row.shake {
            background: var(--color-orange-light);
            margin: 4px -8px;
            padding: 10px 8px;
            border-radius: var(--radius-xs);
        }

        /* Calculation Details */
        .calculation-details {
            background: var(--color-bg);
            padding: 20px;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
        }

        .calculation-details h4 {
            color: var(--color-text);
            margin-bottom: 16px;
        }

        .calc-section {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-border);
        }

        .calc-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .calc-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-text);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .calc-section-title .step-num {
            background: var(--color-orange);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: var(--radius-full);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            flex-shrink: 0;
        }

        .calc-line {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            padding-left: 34px;
            color: var(--color-text);
            font-size: 0.85rem;
        }

        .calc-line.formula {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 8px 12px;
            border-radius: var(--radius-xs);
            margin: 6px 0 6px 34px;
            font-size: 0.82rem;
        }

        .calc-line.total {
            border-top: 2px solid var(--color-border);
            margin-top: 10px;
            padding-top: 10px;
            font-weight: 600;
        }

        .calc-line.result {
            background: var(--color-teal);
            color: white;
            padding: 10px 14px;
            border-radius: var(--radius-xs);
            margin: 10px 0 10px 34px;
            font-weight: 600;
        }

        /* Info Box (for recomp explanation) â€” extends brand .info-box */
        .info-box-calc {
            padding: 16px;
            background: var(--color-teal-light);
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--color-teal);
            margin-top: 16px;
            font-size: 0.9rem;
            color: var(--color-text);
            line-height: 1.6;
        }

        .info-box-calc strong {
            color: var(--color-teal);
        }

        /* Privacy Notice */
        .privacy-notice {
            text-align: center;
            font-size: 0.8rem;
            color: var(--color-text-muted);
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        /* Swipe-back indicator */
        .swipe-hint {
            position: fixed;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to right, var(--color-teal), transparent);
            opacity: 0.5;
            z-index: 100;
            pointer-events: none;
        }

        @media (min-width: 768px) {
            .swipe-hint { display: none; }
        }

        /* Mobile header with back button â€” matches body-fat-guide pattern */
        .mobile-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 0;
            margin-bottom: 8px;
            border-bottom: 1px solid var(--color-border);
        }

        .back-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            background: var(--color-bg);
            border-radius: var(--radius-full);
            color: var(--color-teal);
            text-decoration: none;
        }

        .back-btn:hover {
            background: var(--color-teal-light);
            text-decoration: none;
        }

        .mobile-header-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text);
        }

        /* FAQ link */
        .faq-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--color-teal);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .faq-link:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="swipe-hint"></div>
    <div class="container">
        <div class="mobile-header">
            <a href="index.html" class="back-btn">
                <i data-lucide="arrow-left" style="width:20px;height:20px;"></i>
            </a>
            <span class="mobile-header-title">Nutrition Calculator</span>
            <a href="nutrition-calculator-faq.html" class="help-link-inline help-link-lg" title="How does this calculator work?">?</a>
        </div>

        <p class="text-muted mb-16" style="font-size: 0.9rem;">Enter your details below to get science-based calorie and protein targets tailored to your body and goals.</p>

        <!-- No JavaScript Fallback -->
        <noscript>
            <div class="warning-box">
                <strong>JavaScript Required</strong>
                <p>This calculator requires JavaScript. Please enable JavaScript or use our <a href="protein-calculator.html#noscript">manual calculation tables</a>.</p>
            </div>
        </noscript>

        <!-- Input Form: Body -->
        <div class="card mb-16">
            <div class="section-header">
                <span class="step-number">1</span>
                <span class="section-title">Your Body Composition</span>
            </div>

            <div class="input-row-4">
                <div class="input-group">
                    <label for="weight">Current Weight (kg)</label>
                    <input type="number" id="weight" placeholder="e.g., 85" min="30" max="300" step="0.1">
                </div>
                <div class="input-group">
                    <label for="bodyfat">Current Body Fat %</label>
                    <input type="number" id="bodyfat" placeholder="e.g., 25" min="3" max="60" step="0.1">
                </div>
                <div class="input-group">
                    <label for="targetWeight">Target Weight (kg)</label>
                    <input type="number" id="targetWeight" placeholder="e.g., 80" min="30" max="300" step="0.1">
                </div>
                <div class="input-group">
                    <label for="targetBodyfat">Target Body Fat %</label>
                    <input type="number" id="targetBodyfat" placeholder="e.g., 18" min="3" max="60" step="0.1">
                </div>
            </div>
            <p class="input-hint">Don't know your body fat? Use a DEXA scan, calipers, or smart scale. <a href="body-fat-guide.html" class="help-link-inline">?</a></p>

            <div class="input-row-3" style="margin-top: 16px;">
                <div class="input-group">
                    <label for="height">Height (cm)</label>
                    <input type="number" id="height" placeholder="e.g., 175" min="100" max="250">
                </div>
                <div class="input-group">
                    <label for="age">Age</label>
                    <input type="number" id="age" placeholder="e.g., 45" min="18" max="120">
                </div>
                <div class="input-group">
                    <label for="sex">Sex</label>
                    <select id="sex">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label for="diet">Diet Type</label>
                <select id="diet">
                    <option value="omnivore">Omnivore</option>
                    <option value="vegetarian">Vegetarian</option>
                    <option value="vegan">Vegan</option>
                </select>
                <p class="input-hint">Vegan protein targets are adjusted +25% to compensate for lower bioavailability. Vegetarian diets with dairy/eggs need no adjustment.</p>
            </div>
        </div>

        <!-- Input Form: Activity -->
        <div class="card mb-16">
            <div class="section-header">
                <span class="step-number">2</span>
                <span class="section-title">Your Activity Level</span>
            </div>

            <div class="input-group">
                <label for="activityLevel">Activity Level</label>
                <select id="activityLevel">
                    <option value="1.2">Sedentary â€” desk job, little movement</option>
                    <option value="1.375">Lightly Active â€” easy exercise 1-3 days/week</option>
                    <option value="1.55" selected>Moderately Active â€” exercise 3-5 days/week</option>
                    <option value="1.725">Very Active â€” hard training 6-7 days/week</option>
                    <option value="1.9">Extremely Active â€” intense daily training + physical job</option>
                </select>
            </div>

            <div class="input-group">
                <label for="hasResistance">Resistance Training</label>
                <select id="hasResistance">
                    <option value="no">No â€” I don't lift weights</option>
                    <option value="yes">Yes â€” I train with weights regularly</option>
                </select>
                <p class="input-hint">Resistance training is key for building and preserving lean mass â€” targets adjust accordingly.</p>
            </div>
        </div>

        <!-- Input Form: Meals -->
        <div class="card mb-16">
            <div class="section-header">
                <span class="step-number">3</span>
                <span class="section-title">Meal Distribution</span>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label for="mealsPerDay">Meals Per Day</label>
                    <select id="mealsPerDay">
                        <option value="1">1 meal (OMAD)</option>
                        <option value="2">2 meals</option>
                        <option value="3" selected>3 meals</option>
                        <option value="4">4 meals</option>
                        <option value="5">5 meals</option>
                        <option value="6">6 meals</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="proteinShakes">Protein Shakes Per Day</label>
                    <select id="proteinShakes">
                        <option value="0" selected>0 shakes</option>
                        <option value="1">1 shake</option>
                        <option value="2">2 shakes</option>
                    </select>
                    <p class="input-hint">Each shake meets your age-adjusted minimum dose for optimal muscle protein synthesis. Remaining protein is split evenly across meals.</p>
                </div>
            </div>

            <button class="btn btn-primary btn-full mt-16" onclick="calculateNutrition()">
                <i data-lucide="calculator" style="width:18px;height:18px;"></i>
                Calculate My Targets
            </button>

            <p class="privacy-notice">
                <i data-lucide="lock" style="width:14px;height:14px;"></i>
                All calculations happen in your browser. No data is sent or stored.
            </p>
        </div>

        <!-- Results Section -->
        <div class="results-card" id="results">
            <div class="card mb-16">
                <div class="results-header">
                    <h2>Your Personalized Targets</h2>
                    <div class="goal-badge" id="goalBadge">â€” Mode</div>
                    <br><br>
                    <div class="timeline-badge" id="timeline">â€” weeks to goal</div>
                </div>

                <!-- Body Composition Summary -->
                <div class="composition-summary" id="compositionSummary">
                    <div class="composition-box">
                        <div class="label">CURRENT</div>
                        <div class="weight" id="currentWeightDisplay">85 kg</div>
                        <div class="detail" id="currentCompDisplay">25% BF â€¢ 21.3 kg fat â€¢ 63.7 kg lean</div>
                    </div>
                    <div class="composition-arrow">
                        <i data-lucide="arrow-right" style="width:24px;height:24px;"></i>
                    </div>
                    <div class="composition-box">
                        <div class="label">TARGET</div>
                        <div class="weight" id="targetWeightDisplay">80 kg</div>
                        <div class="detail" id="targetCompDisplay">18% BF â€¢ 14.4 kg fat â€¢ 65.6 kg lean</div>
                    </div>
                </div>

                <div class="change-summary" id="changeSummary">
                    <div class="change-item fat-loss">
                        <div class="value" id="fatChangeValue">-6.9 kg</div>
                        <div class="label">Fat Loss</div>
                    </div>
                    <div class="change-item muscle-gain">
                        <div class="value" id="muscleChangeValue">+1.9 kg</div>
                        <div class="label">Lean Mass</div>
                    </div>
                </div>
            </div>

            <div class="card mb-16">
                <div class="results-grid">
                    <div class="result-box highlight">
                        <div class="result-value" id="dailyCalories">â€”</div>
                        <div class="result-unit">kcal/day</div>
                        <div class="result-label">Daily Calories</div>
                    </div>
                    <div class="result-box highlight">
                        <div class="result-value" id="dailyProtein">â€”</div>
                        <div class="result-unit">g/day</div>
                        <div class="result-label">Daily Protein</div>
                    </div>
                    <div class="result-box">
                        <div class="result-value" id="proteinPercent">â€”</div>
                        <div class="result-unit">%</div>
                        <div class="result-label">Protein (% of calories)</div>
                    </div>
                    <div class="result-box">
                        <div class="result-value" id="deficit">â€”</div>
                        <div class="result-unit">kcal/day</div>
                        <div class="result-label" id="deficitLabel">Calorie Deficit</div>
                    </div>
                </div>

                <div class="meal-breakdown" id="mealBreakdown">
                    <h4>Daily Meal Plan</h4>
                    <!-- Filled by JavaScript -->
                </div>
            </div>

            <div class="card mb-16">
                <div class="calculation-details" id="calculationDetails">
                    <h4>How Your Targets Were Calculated</h4>
                    <!-- Filled by JavaScript -->
                </div>

                <div style="margin-top: 12px; text-align: center;">
                    <a href="nutrition-calculator-faq.html" class="faq-link">
                        <i data-lucide="book-open" style="width:16px;height:16px;"></i>
                        Learn the science behind each step
                    </a>
                </div>
            </div>

            <div class="warning-box" id="warningBox" style="display: none; margin-bottom: 16px;">
                <!-- Warnings displayed here -->
            </div>

            <div class="info-box-calc" id="infoBox" style="display: none;">
                <!-- Info displayed here -->
            </div>
        </div>

        <p class="text-center text-muted" style="font-size: 0.82rem; margin-top: 32px; margin-bottom: 24px;">
            Last updated: February 2026 &bull; Based on peer-reviewed research
        </p>
    </div>

    <script>
        // ============================================
        // CONSTANTS
        // ============================================

        const KCAL_PER_KG_FAT = 7700;
        const SHAKE_KCAL_PER_GRAM_PROTEIN = 5;
        const RECOMP_DEFICIT = 250;

        const PROTEIN_MULTIPLIERS = {
            maintain: 1.6,
            recomp: 2.4,
            mildDeficit: 2.0,
            moderateDeficit: 2.2,
            aggressiveDeficit: 2.4,
            bulk: 2.0
        };

        // FFMI reference values
        // Kouri et al. 1995: natural male mean 21.8, ceiling ~25
        // Women: ~3-4 points lower (Schutz et al. 2002)
        const FFMI_UNTRAINED_MALE = 18.5;
        const FFMI_UNTRAINED_FEMALE = 15.0;
        const FFMI_NATURAL_CEILING_MALE = 25.0;
        const FFMI_NATURAL_CEILING_FEMALE = 21.0;

        // Beginner max gain rate (kg/month) at full proximity
        // McDonald Year-1 model: ~10 kg/yr for males = ~0.83 kg/month
        // Aragon model: 1-1.5% BW/month for beginners
        // Using 1.0 kg/month as optimistic-but-evidence-based peak
        const MAX_MONTHLY_GAIN_MALE = 1.0;
        const MAX_MONTHLY_GAIN_FEMALE = 0.5;

        // ============================================
        // FFMI & MUSCLE GAIN FUNCTIONS
        // ============================================

        // Fat-Free Mass Index: Kouri et al. 1995
        function calculateFFMI(lbm, heightCm) {
            const heightM = heightCm / 100;
            return lbm / (heightM * heightM);
        }

        // Height-adjusted FFMI: Kouri normalization to 1.80m reference
        function calculateAdjustedFFMI(ffmi, heightCm) {
            const heightM = heightCm / 100;
            return ffmi + 6.1 * (1.80 - heightM);
        }

        // Individual FFMI ceiling
        // Men:  McDonald height model (maxLBM = hÃ—0.407+8.6), floored at 24.5 FFMI
        //       Works well at average heights (~25 FFMI), slightly low for tall men
        // Women: Constant FFMI ceiling of 21.0 (Kouri-equivalent female research)
        //       McDonald's linear formula gives inverted height scaling for women
        //       (shorter women get higher FFMI than taller â€” physically incorrect)
        //       so we use the evidence-based constant instead
        function getFFMICeiling(heightCm, sex, age) {
            const heightM = heightCm / 100;
            let ceiling;

            if (sex === 'male') {
                const maxLBM = heightCm * 0.407 + 8.6;
                ceiling = maxLBM / (heightM * heightM);
                // Floor: prevent unrealistically low ceilings for tall men
                ceiling = Math.max(ceiling, 24.5);
            } else {
                // Constant FFMI ceiling for women (evidence-based)
                // Schutz et al., Abe et al.: natural female ceiling ~20-21 FFMI
                ceiling = FFMI_NATURAL_CEILING_FEMALE; // 21.0
            }

            // Age-adjusted ceiling: sarcopenia reduces achievable maximum
            // Mitchell et al. 2012: ~0.5%/yr muscle loss after 50; we use a conservative
            // FFMI reduction: Males ~0.3 pts/decade, Females ~0.15 pts/decade after 40
            if (age > 40) {
                const decadesOver40 = (age - 40) / 10;
                const ageReduction = sex === 'male' ? decadesOver40 * 0.3 : decadesOver40 * 0.15;
                ceiling -= ageReduction;
            }
            return ceiling;
        }

        // Proximity to genetic ceiling (0 = at ceiling, 1 = untrained baseline)
        function getProximityToCeiling(currentFFMI, ceilingFFMI, sex) {
            const baseline = sex === 'male' ? FFMI_UNTRAINED_MALE : FFMI_UNTRAINED_FEMALE;
            const range = ceilingFFMI - baseline;
            if (range <= 0) return 0;
            const proximity = (ceilingFFMI - currentFFMI) / range;
            return Math.max(0, Math.min(1, proximity));
        }

        // FFMI-based muscle gain rate (kg/month)
        // Combines proximity-to-ceiling (Aragon/McDonald) with age modifier
        function getMuscleGainRate(age, hasResistance, sex, currentLBM, heightCm) {
            const currentFFMI = calculateFFMI(currentLBM, heightCm);
            const ceilingFFMI = getFFMICeiling(heightCm, sex, age);
            const proximity = getProximityToCeiling(currentFFMI, ceilingFFMI, sex);

            // Base rate from proximity: exponential curve matching McDonald/Aragon year-by-year data
            // At proximity 1.0 (untrained): full beginner rate
            // At proximity 0.5 (intermediate): ~50% of beginner rate
            // At proximity 0.1 (advanced): ~10% of beginner rate
            const maxRate = sex === 'male' ? MAX_MONTHLY_GAIN_MALE : MAX_MONTHLY_GAIN_FEMALE;
            let baseRate = maxRate * proximity;

            // Age modifier: hormonal decline reduces muscle protein synthesis efficiency
            // Kumar et al. 2009: ~30% reduced MPS at age 70 vs young adults
            let ageModifier;
            if (age < 30) ageModifier = 1.0;
            else if (age < 40) ageModifier = 0.85;
            else if (age < 50) ageModifier = 0.70;
            else if (age < 60) ageModifier = 0.55;
            else if (age < 70) ageModifier = 0.40;
            else ageModifier = 0.25;

            baseRate *= ageModifier;

            // Training modifier
            if (!hasResistance) baseRate *= 0.3;

            // Floor: even near ceiling, some gain possible with optimal conditions
            const floor = 0.05 * ageModifier * (hasResistance ? 1 : 0.3);
            baseRate = Math.max(baseRate, floor);

            return {
                rate: baseRate,
                currentFFMI: currentFFMI,
                ceilingFFMI: ceilingFFMI,
                proximity: proximity,
                ageModifier: ageModifier
            };
        }

        // Fat loss rate: BF%-scaled formula (BF% Ã· 20 = % BW loss/week)
        // Based on Alpert 2005: fat stores release max ~31 kcal/lb fat/day
        // BF%Ã·20 is a practical approximation of this energy transfer limit
        function getFatLossRate(weight, bodyfat, goalType) {
            // BF% Ã· 20 = target % BW loss per week (Alpert-derived)
            // e.g., 20% BF â†’ 1.0%/week â†’ 0.85 kg/week for 85kg person
            // e.g., 30% BF â†’ 1.5%/week â†’ 0.98 kg/week for 65kg person
            const weeklyPercent = bodyfat / 20;
            const weeklyKg = weight * (weeklyPercent / 100);

            if (goalType === 'recomp' || goalType === 'recomp-weight-change') {
                // Recomp: cap at 0.5 kg/week to preserve muscle building environment
                return Math.min(0.5, weeklyKg);
            }
            // Fat loss: cap at 1.0 kg/week for safety, floor at 0.25
            return Math.min(1.0, Math.max(0.25, weeklyKg));
        }

        function getBulkingMultiplier(age) {
            if (age >= 60) return 2.4;
            if (age >= 40) return 2.2;
            return 2.0;
        }

        function getPerMealFactor(age) {
            if (age >= 70) return 0.60;
            if (age >= 60) return 0.55;
            if (age >= 50) return 0.50;
            if (age >= 40) return 0.40;
            return 0.30;
        }

        // Diet adjustment: only vegans need a protein uplift.
        // Lacto-ovo vegetarians have access to whey, eggs, casein (DIAAS â‰¥ 1.0)
        // so no adjustment is needed when dairy/eggs are part of the diet.
        function getDietFactor(diet) {
            if (diet === 'vegan') return 1.25;
            return 1.0;
        }

        function getAgeCategory(age) {
            if (age >= 70) return { name: '70+', resistance: 'severe anabolic resistance', perMeal: '~40g+ per meal for MPS' };
            if (age >= 60) return { name: '60s', resistance: 'significant anabolic resistance', perMeal: '~35g+ per meal for MPS' };
            if (age >= 50) return { name: '50s', resistance: 'moderate anabolic resistance', perMeal: '~30g+ per meal for MPS' };
            if (age >= 40) return { name: '40s', resistance: 'mild anabolic resistance', perMeal: '~25g+ per meal for MPS' };
            return { name: 'under 40', resistance: 'optimal anabolic response', perMeal: '~20g+ per meal for MPS' };
        }

        // ============================================
        // BMR CALCULATIONS
        // ============================================

        function calculateBMR_KatchMcArdle(lbm) {
            return 370 + (21.6 * lbm);
        }

        // ============================================
        // MAIN CALCULATION
        // ============================================

        function calculateNutrition() {
            const weight = parseFloat(document.getElementById('weight').value);
            const bodyfat = parseFloat(document.getElementById('bodyfat').value);
            const targetWeight = parseFloat(document.getElementById('targetWeight').value);
            const targetBodyfat = parseFloat(document.getElementById('targetBodyfat').value);
            const height = parseFloat(document.getElementById('height').value);
            const age = parseInt(document.getElementById('age').value);
            const sex = document.getElementById('sex').value;
            const diet = document.getElementById('diet').value;
            const activityLevel = parseFloat(document.getElementById('activityLevel').value);
            const hasResistance = document.getElementById('hasResistance').value === 'yes';
            const mealsPerDay = parseInt(document.getElementById('mealsPerDay').value);
            const proteinShakes = parseInt(document.getElementById('proteinShakes').value);

            // Validation
            if (!weight || !height || !age) {
                alert('Please enter your weight, height, and age.');
                return;
            }
            if (!bodyfat || bodyfat <= 0) {
                alert('Please enter your current body fat %. See the estimation guide below.');
                return;
            }
            if (!targetWeight) {
                alert('Please enter your target weight.');
                return;
            }
            if (!targetBodyfat || targetBodyfat <= 0) {
                alert('Please enter your target body fat %. This is needed to calculate body composition changes.');
                return;
            }

            // STEP 1: Body Composition
            const currentFatMass = weight * (bodyfat / 100);
            const currentLBM = weight - currentFatMass;
            const targetFatMass = targetWeight * (targetBodyfat / 100);
            const targetLBM = targetWeight - targetFatMass;
            const fatChange = targetFatMass - currentFatMass;
            const lbmChange = targetLBM - currentLBM;
            const weightChange = targetWeight - weight;

            // STEP 2: Goal Type
            let goalType;
            const isLosingFat = fatChange < -0.5;
            const isGainingMuscle = lbmChange > 0.5;
            const isSameWeight = Math.abs(weightChange) <= 0.5;

            if (isSameWeight && isLosingFat && isGainingMuscle) {
                goalType = 'recomp';
            } else if (isLosingFat && isGainingMuscle) {
                goalType = 'recomp-weight-change';
            } else if (isLosingFat && !isGainingMuscle) {
                goalType = 'fat-loss';
            } else if (isGainingMuscle && !isLosingFat) {
                goalType = 'muscle-gain';
            } else if (Math.abs(fatChange) < 0.5 && Math.abs(lbmChange) < 0.5) {
                goalType = 'maintain';
            } else {
                goalType = 'recomp';
            }

            // STEP 3: BMR & TDEE
            const bmr = calculateBMR_KatchMcArdle(currentLBM);
            const tdee = bmr * activityLevel;

            // STEP 4: Timeline (FFMI-based muscle gain + Alpert-derived fat loss)
            const muscleData = getMuscleGainRate(age, hasResistance, sex, currentLBM, height);
            const muscleGainRate = muscleData.rate;
            let weeksForFatLoss = 0;
            let weeksForMuscleGain = 0;
            let limitingFactor = '';
            let fatLossRate = 0;

            if (isLosingFat) {
                const fatToLose = Math.abs(fatChange);
                fatLossRate = getFatLossRate(weight, bodyfat, goalType);
                weeksForFatLoss = fatToLose / fatLossRate;
            }

            if (isGainingMuscle) {
                const muscleToGain = lbmChange;
                const monthsForMuscle = muscleToGain / muscleGainRate;
                weeksForMuscleGain = monthsForMuscle * 4.33;
            }

            let totalWeeks;
            if (goalType === 'maintain') {
                totalWeeks = 0;
                limitingFactor = 'Maintenance mode';
            } else if (weeksForMuscleGain > weeksForFatLoss) {
                totalWeeks = Math.ceil(weeksForMuscleGain);
                limitingFactor = 'muscle gain rate';
            } else if (weeksForFatLoss > 0) {
                totalWeeks = Math.ceil(weeksForFatLoss);
                limitingFactor = 'fat loss rate';
            } else {
                totalWeeks = Math.ceil(weeksForMuscleGain);
                limitingFactor = 'muscle gain rate';
            }

            // STEP 5: Calories â€” target-weight-aligned approach
            // Key principle: surplus/deficit is derived FROM the body composition targets
            // so that over the timeline, calorie balance matches intended weight change.
            //
            // Energy costs per kg of tissue change:
            //   Muscle: ~2500 kcal/kg (tissue + protein synthesis overhead)
            //   Fat:    ~7700 kcal/kg (standard energy density)
            // Metabolic overhead factor: Ã—1.4 (thermic effect, futile cycling, adaptation)
            //
            // References:
            //   Helms (lean bulk): 200-300 kcal surplus for beginners
            //   Israetel: surplus scales with growth potential
            //   Hall (energy balance): surplus must match intended tissue accretion rate

            const ENERGY_PER_KG_MUSCLE = 2500;
            const ENERGY_PER_KG_FAT = 7700;
            const METABOLIC_OVERHEAD = 1.4;

            let targetCalories;
            let dailyDeficit = 0;
            let dailySurplus = 0;
            let hitFloor = false;
            const minCalories = sex === 'male' ? 1500 : 1200;

            if (goalType === 'maintain') {
                targetCalories = Math.round(tdee);

            } else if (goalType === 'recomp') {
                // Same weight: fat loss provides energy for muscle building
                // No surplus needed â€” fat stores are the energy source
                // High protein + resistance training drive the recomposition
                // Maintenance calories prevent unwanted weight change
                targetCalories = Math.round(tdee);

            } else if (goalType === 'recomp-weight-change') {
                // Losing weight while recomping
                // Deficit derived from net weight change over timeline
                if (totalWeeks > 0 && weightChange < 0) {
                    // Net tissue change: losing fat, possibly gaining some muscle
                    const fatEnergy = Math.abs(fatChange) * ENERGY_PER_KG_FAT;
                    const muscleEnergy = Math.max(0, lbmChange) * ENERGY_PER_KG_MUSCLE;
                    // Net energy to liberate = fat energy released - muscle energy needed
                    const netEnergy = fatEnergy - muscleEnergy;
                    dailyDeficit = Math.round(netEnergy / (totalWeeks * 7));
                    // Cap deficit for safety (Alpert-derived: BF%/20 rate)
                    const maxSafeDeficit = (fatLossRate * KCAL_PER_KG_FAT) / 7;
                    dailyDeficit = Math.min(dailyDeficit, maxSafeDeficit);
                    dailyDeficit = Math.max(0, dailyDeficit); // never negative
                }
                const isLean = (sex === 'male' && bodyfat <= 15) || (sex === 'female' && bodyfat <= 22);
                if (isLean && dailyDeficit > 200) {
                    // Lean individuals: limit deficit to preserve muscle building
                    dailyDeficit = Math.min(dailyDeficit, 200);
                }
                targetCalories = Math.round(tdee - dailyDeficit);

            } else if (goalType === 'fat-loss') {
                dailyDeficit = (fatLossRate * KCAL_PER_KG_FAT) / 7;
                targetCalories = Math.round(tdee - dailyDeficit);

            } else if (goalType === 'muscle-gain') {
                // Surplus derived from expected tissue accretion rate
                // This ensures surplus matches muscle gain rate â€” no excess becomes fat
                // Energy needed = (muscle gain rate Ã— energy cost) Ã— overhead
                if (totalWeeks > 0) {
                    const weeklyMuscleGain = muscleGainRate / 4.33; // kg/week
                    const weeklyEnergy = weeklyMuscleGain * ENERGY_PER_KG_MUSCLE * METABOLIC_OVERHEAD;
                    dailySurplus = Math.round(weeklyEnergy / 7);
                    // Floor: minimum 50 kcal surplus for anabolic signaling
                    // Ceiling: 500 kcal for very fast beginners
                    dailySurplus = Math.max(50, Math.min(500, dailySurplus));
                } else {
                    dailySurplus = 100;
                }
                targetCalories = Math.round(tdee + dailySurplus);
            }

            if (targetCalories < minCalories) {
                hitFloor = true;
                targetCalories = minCalories;
                dailyDeficit = tdee - targetCalories;
            }

            // STEP 6: Protein
            let proteinMultiplier;
            let proteinRationale;

            if (goalType === 'maintain') {
                proteinMultiplier = PROTEIN_MULTIPLIERS.maintain;
                proteinRationale = 'Maintenance protein for muscle preservation';
            } else if (goalType === 'recomp') {
                proteinMultiplier = PROTEIN_MULTIPLIERS.recomp;
                proteinRationale = 'Maximum protein for recomposition at maintenance';
            } else if (goalType === 'recomp-weight-change') {
                proteinMultiplier = PROTEIN_MULTIPLIERS.recomp;
                const isLean = (sex === 'male' && bodyfat <= 15) || (sex === 'female' && bodyfat <= 22);
                proteinRationale = isLean
                    ? 'Maximum protein for lean recomp at maintenance calories'
                    : 'Maximum protein for recomp in mild deficit (Longland et al. 2016)';
            } else if (goalType === 'fat-loss') {
                if (fatLossRate <= 0.5) {
                    proteinMultiplier = PROTEIN_MULTIPLIERS.mildDeficit;
                    proteinRationale = 'Elevated protein for muscle preservation in mild deficit';
                } else if (fatLossRate <= 0.75) {
                    proteinMultiplier = PROTEIN_MULTIPLIERS.moderateDeficit;
                    proteinRationale = 'High protein for muscle preservation in moderate deficit';
                } else {
                    proteinMultiplier = PROTEIN_MULTIPLIERS.aggressiveDeficit;
                    proteinRationale = 'Maximum protein for muscle preservation in aggressive deficit';
                }
            } else if (goalType === 'muscle-gain') {
                proteinMultiplier = getBulkingMultiplier(age);
                proteinRationale = `Age-adjusted protein for muscle building (${age >= 60 ? 'compensating for anabolic resistance' : age >= 40 ? 'moderate anabolic resistance' : 'optimal response'})`;
            }

            const dietFactor = getDietFactor(diet);
            const dailyProtein = Math.round(currentLBM * proteinMultiplier * dietFactor);

            // STEP 7: Per-Meal Distribution
            const perMealFactor = getPerMealFactor(age);
            const proteinPerShake = Math.round(currentLBM * perMealFactor * dietFactor);
            const shakeCalories = proteinPerShake * SHAKE_KCAL_PER_GRAM_PROTEIN;

            const proteinFromShakes = proteinShakes * proteinPerShake;
            const proteinFromMeals = Math.max(0, dailyProtein - proteinFromShakes);

            const caloriesForMeals = targetCalories - (proteinShakes * shakeCalories);
            const perMealCalories = mealsPerDay > 0 ? Math.round(caloriesForMeals / mealsPerDay) : 0;
            const perMealProtein = mealsPerDay > 0 ? Math.round(proteinFromMeals / mealsPerDay) : 0;

            const proteinCalories = dailyProtein * 4;
            const proteinPercent = Math.round((proteinCalories / targetCalories) * 100);

            const minPerMealProtein = proteinPerShake;
            const perMealProteinOk = perMealProtein >= minPerMealProtein || proteinShakes > 0;

            // ============================================
            // DISPLAY RESULTS
            // ============================================

            const goalLabels = {
                'maintain': 'âš–ï¸ Maintenance',
                'recomp': 'ðŸ”„ Body Recomposition',
                'recomp-weight-change': 'ðŸ”„ Recomp + Weight Loss',
                'fat-loss': 'ðŸ”¥ Fat Loss',
                'muscle-gain': 'ðŸ’ª Muscle Building'
            };
            document.getElementById('goalBadge').textContent = goalLabels[goalType] || goalType;

            document.getElementById('currentWeightDisplay').textContent = `${weight} kg`;
            document.getElementById('currentCompDisplay').textContent = `${bodyfat}% BF â€¢ ${currentFatMass.toFixed(1)} kg fat â€¢ ${currentLBM.toFixed(1)} kg lean`;

            document.getElementById('targetWeightDisplay').textContent = `${targetWeight} kg`;
            document.getElementById('targetCompDisplay').textContent = `${targetBodyfat}% BF â€¢ ${targetFatMass.toFixed(1)} kg fat â€¢ ${targetLBM.toFixed(1)} kg lean`;

            document.getElementById('fatChangeValue').textContent = fatChange >= 0 ? `+${fatChange.toFixed(1)} kg` : `${fatChange.toFixed(1)} kg`;
            document.getElementById('muscleChangeValue').textContent = lbmChange >= 0 ? `+${lbmChange.toFixed(1)} kg` : `${lbmChange.toFixed(1)} kg`;

            const fatBox = document.querySelector('.change-item.fat-loss');
            const muscleBox = document.querySelector('.change-item.muscle-gain');

            if (fatChange > 0) {
                fatBox.style.background = 'var(--color-red-light)';
                fatBox.style.color = 'var(--color-red)';
                fatBox.querySelector('.label').textContent = 'Fat Gain';
            } else {
                fatBox.style.background = 'var(--color-teal-light)';
                fatBox.style.color = 'var(--color-teal)';
                fatBox.querySelector('.label').textContent = 'Fat Loss';
            }

            if (lbmChange < 0) {
                muscleBox.style.background = 'var(--color-red-light)';
                muscleBox.style.color = 'var(--color-red)';
                muscleBox.querySelector('.label').textContent = 'Lean Mass Loss';
            } else {
                muscleBox.style.background = 'var(--color-teal-light)';
                muscleBox.style.color = 'var(--color-teal)';
                muscleBox.querySelector('.label').textContent = 'Lean Mass Gain';
            }

            document.getElementById('dailyCalories').textContent = targetCalories.toLocaleString();
            document.getElementById('dailyProtein').textContent = dailyProtein;
            document.getElementById('proteinPercent').textContent = proteinPercent;

            const deficitLabel = document.getElementById('deficitLabel');
            if (dailySurplus > 0) {
                document.getElementById('deficit').textContent = '+' + Math.round(dailySurplus);
                deficitLabel.textContent = 'Calorie Surplus';
            } else if (dailyDeficit > 0) {
                document.getElementById('deficit').textContent = Math.round(dailyDeficit);
                deficitLabel.textContent = 'Calorie Deficit';
            } else {
                document.getElementById('deficit').textContent = '0';
                deficitLabel.textContent = 'Calorie Balance';
            }

            if (goalType === 'maintain') {
                document.getElementById('timeline').textContent = 'Maintenance mode - no timeline';
            } else {
                const months = Math.round(totalWeeks / 4.33);
                if (months >= 12) {
                    const years = (months / 12).toFixed(1);
                    document.getElementById('timeline').textContent = `~${years} years (${totalWeeks} weeks) â€¢ Limited by ${limitingFactor}`;
                } else if (months >= 2) {
                    document.getElementById('timeline').textContent = `~${months} months (${totalWeeks} weeks) â€¢ Limited by ${limitingFactor}`;
                } else {
                    document.getElementById('timeline').textContent = `~${totalWeeks} weeks â€¢ Limited by ${limitingFactor}`;
                }
            }

            // Meal breakdown
            let mealHtml = '';
            for (let i = 1; i <= mealsPerDay; i++) {
                mealHtml += `<div class="meal-row"><span>Meal ${i}</span><span><strong>${perMealProtein}g protein</strong> â€¢ ${perMealCalories} kcal</span></div>`;
            }
            if (proteinShakes > 0) {
                for (let i = 1; i <= proteinShakes; i++) {
                    mealHtml += `<div class="meal-row shake"><span>ðŸ¥¤ Protein Shake ${i}</span><span><strong>${proteinPerShake}g protein</strong> â€¢ ~${Math.round(shakeCalories)} kcal</span></div>`;
                }
            }
            document.getElementById('mealBreakdown').innerHTML = `<h4>Daily Meal Plan</h4>${mealHtml}`;

            // Calculation details
            const activityLabels = {
                '1.2': 'Sedentary (Ã—1.2)',
                '1.375': 'Lightly Active (Ã—1.375)',
                '1.55': 'Moderately Active (Ã—1.55)',
                '1.725': 'Very Active (Ã—1.725)',
                '1.9': 'Extremely Active (Ã—1.9)'
            };
            const activityLabel = activityLabels[activityLevel.toString()] || `Ã—${activityLevel}`;
            const ageCategory = getAgeCategory(age);

            let calculationHtml = `
                <h4>How We Calculated This</h4>

                <div class="calc-section">
                    <div class="calc-section-title"><span class="step-num">1</span> Body Composition Analysis</div>
                    <div class="calc-line"><span>Current weight</span><span>${weight} kg</span></div>
                    <div class="calc-line"><span>Current body fat</span><span>${bodyfat}%</span></div>
                    <div class="calc-line formula">Fat mass = ${weight} Ã— ${bodyfat}% = ${currentFatMass.toFixed(2)} kg</div>
                    <div class="calc-line formula">Lean body mass = ${weight} âˆ’ ${currentFatMass.toFixed(2)} = ${currentLBM.toFixed(2)} kg</div>
                    <div class="calc-line"><span>Target weight</span><span>${targetWeight} kg</span></div>
                    <div class="calc-line"><span>Target body fat</span><span>${targetBodyfat}%</span></div>
                    <div class="calc-line formula">Target fat = ${targetWeight} Ã— ${targetBodyfat}% = ${targetFatMass.toFixed(2)} kg</div>
                    <div class="calc-line formula">Target LBM = ${targetWeight} âˆ’ ${targetFatMass.toFixed(2)} = ${targetLBM.toFixed(2)} kg</div>
                    <div class="calc-line total"><span>Fat change</span><span><strong>${fatChange >= 0 ? '+' : ''}${fatChange.toFixed(2)} kg</strong></span></div>
                    <div class="calc-line total"><span>Lean mass change</span><span><strong>${lbmChange >= 0 ? '+' : ''}${lbmChange.toFixed(2)} kg</strong></span></div>
                    <div class="calc-line result"><span>Goal Type</span><span>${goalLabels[goalType]}</span></div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title"><span class="step-num">2</span> BMR (Katch-McArdle)</div>
                    <div class="calc-line formula">BMR = 370 + (21.6 Ã— ${currentLBM.toFixed(1)}) = ${Math.round(bmr)} kcal</div>
                    <div class="calc-line"><span>Activity multiplier</span><span>${activityLabel}</span></div>
                    <div class="calc-line formula">TDEE = ${Math.round(bmr)} Ã— ${activityLevel} = ${Math.round(tdee)} kcal</div>
                    <div class="calc-line result"><span>TDEE</span><span>${Math.round(tdee)} kcal/day</span></div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title"><span class="step-num">3</span> FFMI & Muscle Potential (Kouri/Aragon)</div>
                    <div class="calc-line"><span>Current FFMI</span><span>${muscleData.currentFFMI.toFixed(1)} (${sex === 'male'
                        ? (muscleData.currentFFMI < 20 ? 'beginner range' : muscleData.currentFFMI < 22 ? 'intermediate' : muscleData.currentFFMI < 24 ? 'advanced' : 'elite natural')
                        : (muscleData.currentFFMI < 16.5 ? 'beginner range' : muscleData.currentFFMI < 18 ? 'intermediate' : muscleData.currentFFMI < 20 ? 'advanced' : 'elite natural')
                    })</span></div>
                    <div class="calc-line"><span>Your FFMI ceiling</span><span>${muscleData.ceilingFFMI.toFixed(1)} (McDonald height model${age > 40 ? ', age-adjusted' : ''})</span></div>
                    <div class="calc-line"><span>Proximity to ceiling</span><span>${(muscleData.proximity * 100).toFixed(0)}% remaining potential</span></div>
                    <div class="calc-line"><span>Age modifier</span><span>${(muscleData.ageModifier * 100).toFixed(0)}% (age ${age})</span></div>
                    <div class="calc-line formula">Gain rate = ${sex === 'male' ? '1.0' : '0.5'} kg/mo Ã— ${(muscleData.proximity).toFixed(2)} proximity Ã— ${muscleData.ageModifier.toFixed(2)} age${!hasResistance ? ' Ã— 0.30 (no training)' : ''} = ${muscleGainRate.toFixed(2)} kg/mo</div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title"><span class="step-num">4</span> Timeline (Biology-Limited)</div>
                    ${isLosingFat ? `<div class="calc-line"><span>Fat loss rate</span><span>${fatLossRate.toFixed(2)} kg/week (BF${bodyfat}% Ã· 20 = ${(bodyfat/20).toFixed(1)}%/week)</span></div><div class="calc-line formula">Fat loss time = ${Math.abs(fatChange).toFixed(2)} kg Ã· ${fatLossRate.toFixed(2)} kg/wk = ${weeksForFatLoss.toFixed(1)} weeks</div>` : ''}
                    ${isGainingMuscle ? `<div class="calc-line"><span>Muscle to gain</span><span>${lbmChange.toFixed(2)} kg at ${muscleGainRate.toFixed(2)} kg/month</span></div><div class="calc-line formula">Muscle time = ${(lbmChange / muscleGainRate).toFixed(1)} months = ${weeksForMuscleGain.toFixed(1)} weeks</div>` : ''}
                    <div class="calc-line result"><span>Timeline</span><span>${totalWeeks} weeks â€¢ ${limitingFactor}</span></div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title"><span class="step-num">5</span> Daily Calories</div>
                    <div class="calc-line"><span>TDEE</span><span>${Math.round(tdee)} kcal</span></div>
                    ${dailyDeficit > 0 ? `<div class="calc-line"><span>Deficit</span><span>âˆ’${Math.round(dailyDeficit)} kcal</span></div>` : ''}
                    ${goalType === 'recomp' ? `<div class="calc-line"><span>Recomp strategy</span><span>Maintenance â€” fat stores fuel muscle building</span></div>` : ''}
                    ${dailySurplus > 0 && goalType === 'muscle-gain' ? `<div class="calc-line"><span>Surplus (rate-matched)</span><span>+${Math.round(dailySurplus)} kcal (matched to ${muscleGainRate.toFixed(2)} kg/mo gain rate)</span></div>` : ''}
                    ${goalType === 'recomp-weight-change' && dailyDeficit === 0 ? `<div class="calc-line"><span>Lean recomp</span><span>Maintenance (no deficit at ${bodyfat}% BF)</span></div>` : ''}
                    ${hitFloor ? `<div class="calc-line" style="color: var(--color-red);"><span>âš ï¸ Safety floor applied</span><span>${minCalories} kcal</span></div>` : ''}
                    <div class="calc-line result"><span>Target Calories</span><span>${targetCalories} kcal/day</span></div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title"><span class="step-num">6</span> Daily Protein (Age-Adjusted)</div>
                    <div class="calc-line"><span>Age category</span><span>${ageCategory.name} (${ageCategory.resistance})</span></div>
                    <div class="calc-line"><span>Protein multiplier</span><span>${proteinMultiplier} g/kg LBM</span></div>
                    ${dietFactor > 1 ? `<div class="calc-line"><span>Diet adjustment (${diet})</span><span>Ã—${dietFactor}</span></div>` : ''}
                    <div class="calc-line formula">Protein = ${currentLBM.toFixed(1)} Ã— ${proteinMultiplier}${dietFactor > 1 ? ` Ã— ${dietFactor}` : ''} = ${dailyProtein}g</div>
                    <div class="calc-line result"><span>Target Protein</span><span>${dailyProtein}g/day (${proteinPercent}% of kcal)</span></div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title"><span class="step-num">7</span> Per-Meal Distribution</div>
                    <div class="calc-line"><span>Age-based threshold</span><span>${ageCategory.perMeal}</span></div>
                    <div class="calc-line"><span>Min per meal</span><span>${proteinPerShake}g protein</span></div>
                    ${proteinShakes > 0 ? `<div class="calc-line"><span>From ${proteinShakes} shake(s)</span><span>${proteinFromShakes}g</span></div><div class="calc-line"><span>From ${mealsPerDay} meal(s)</span><span>${proteinFromMeals}g</span></div>` : ''}
                    <div class="calc-line result"><span>Per Meal</span><span>${perMealProtein}g protein â€¢ ${perMealCalories} kcal</span></div>
                </div>
            `;
            document.getElementById('calculationDetails').innerHTML = calculationHtml;

            // Warnings
            let warnings = [];

            if (hitFloor) warnings.push(`âš ï¸ Calories hit safety minimum (${minCalories} kcal). Timeline may be longer.`);
            if (!perMealProteinOk && proteinShakes === 0) warnings.push(`âš ï¸ Per-meal protein (${perMealProtein}g) below age-optimal (${minPerMealProtein}g). Consider shakes or fewer meals.`);
            if (!hasResistance && isGainingMuscle) warnings.push(`âš ï¸ Without resistance training, muscle gain is ~30% of potential. Most surplus becomes fat.`);
            if (!hasResistance && (goalType === 'recomp' || goalType === 'recomp-weight-change')) warnings.push(`âš ï¸ Recomposition requires resistance training to build muscle.`);
            if (proteinPercent > 40) warnings.push(`â„¹ï¸ Protein is ${proteinPercent}% of caloriesâ€”sustainable but limited room for carbs/fats.`);
            if (mealsPerDay === 1 && proteinShakes === 0 && dailyProtein > 80) warnings.push(`âš ï¸ OMAD: Hard to get ${dailyProtein}g in one meal. Add shakes.`);
            if (totalWeeks > 104) warnings.push(`â„¹ï¸ Goal takes >2 years. Consider intermediate targets.`);
            if (targetBodyfat < 10 && sex === 'male') warnings.push(`âš ï¸ <10% body fat is hard to maintain and may affect hormones.`);
            if (targetBodyfat < 18 && sex === 'female') warnings.push(`âš ï¸ <18% body fat for women may affect hormones.`);

            const warningBox = document.getElementById('warningBox');
            if (warnings.length > 0) {
                warningBox.innerHTML = `<strong>Important Notes:</strong><br><br>` + warnings.join('<br><br>');
                warningBox.style.display = 'block';
            } else {
                warningBox.style.display = 'none';
            }

            // Info box for recomp
            const infoBox = document.getElementById('infoBox');
            if (goalType === 'recomp') {
                // Same weight recomp - slight surplus
                infoBox.innerHTML = `
                    <strong>Body Recomposition (Same Weight):</strong> You're replacing fat with muscle at ${weight} kg. This requires:
                    <br>â€¢ <strong>Maintenance calories (TDEE)</strong> â€” your fat stores provide the energy for muscle building
                    <br>â€¢ <strong>High protein (2.4 g/kg LBM)</strong> â€” maximizes muscle protein synthesis
                    <br>â€¢ <strong>Progressive resistance training</strong> â€” the primary driver of recomposition
                    <br>â€¢ <strong>Patience</strong> â€” recomp takes time (${muscleGainRate.toFixed(2)} kg muscle/month at FFMI ${muscleData.currentFFMI.toFixed(1)}, age ${age})
                    <br><br><em>Science: Your FFMI is ${muscleData.currentFFMI.toFixed(1)} of a ${muscleData.ceilingFFMI.toFixed(1)} ceiling â€” ${(muscleData.proximity * 100).toFixed(0)}% growth potential remains. No surplus is needed because your ${currentFatMass.toFixed(1)} kg of fat stores provide ample energy for the muscle-building process (Longland et al. 2016).</em>
                `;
                infoBox.style.display = 'block';
            } else if (goalType === 'recomp-weight-change') {
                const isLean = (sex === 'male' && bodyfat <= 15) || (sex === 'female' && bodyfat <= 22);
                if (isLean) {
                    infoBox.innerHTML = `
                        <strong>Lean Recomposition:</strong> At ${bodyfat}% body fat, you're already lean. This requires:
                        <br>â€¢ <strong>Maintenance calories</strong> â€” no deficit; your body can use stored fat while building muscle
                        <br>â€¢ <strong>High protein (2.4 g/kg LBM)</strong> â€” maximizes muscle protein synthesis
                        <br>â€¢ <strong>Progressive resistance training</strong> â€” the primary driver of recomposition
                        <br>â€¢ <strong>Patience</strong> â€” lean recomp is slower (${muscleGainRate.toFixed(2)} kg/month at FFMI ${muscleData.currentFFMI.toFixed(1)}, age ${age})
                        <br><br><em>Science: Your FFMI is ${muscleData.currentFFMI.toFixed(1)} of ${muscleData.ceilingFFMI.toFixed(1)} ceiling. For lean individuals, a deficit impairs muscle building. Maintenance + high protein + training = optimal.</em>
                    `;
                } else {
                    infoBox.innerHTML = `
                        <strong>Recomposition + Weight Loss:</strong> Losing fat while preserving/building muscle. This requires:
                        <br>â€¢ <strong>High protein (2.4 g/kg LBM)</strong> â€” the highest recommendation
                        <br>â€¢ <strong>Small deficit (${RECOMP_DEFICIT} kcal)</strong> â€” your fat stores can fuel the process
                        <br>â€¢ <strong>Resistance training</strong> â€” essential for muscle stimulus
                        <br>â€¢ <strong>Patience</strong> â€” muscle builds slowly (${muscleGainRate.toFixed(2)} kg/month at FFMI ${muscleData.currentFFMI.toFixed(1)}, age ${age})
                        <br><br><em>Research: Longland et al. (2016) showed 2.4g/kg protein enabled +1.2kg muscle while losing 4.8kg fat. Your FFMI ${muscleData.currentFFMI.toFixed(1)} of ${muscleData.ceilingFFMI.toFixed(1)} ceiling means ${(muscleData.proximity * 100).toFixed(0)}% growth potential remains.</em>
                    `;
                }
                infoBox.style.display = 'block';
            } else {
                infoBox.style.display = 'none';
            }

            document.getElementById('results').classList.add('visible');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') calculateNutrition();
            });
        });

        // Swipe-back gesture (left edge swipe to go back to index)
        let touchStartX = 0;
        let touchStartY = 0;
        let touchCurrentX = 0;

        document.addEventListener('touchstart', (e) => {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            touchCurrentX = e.touches[0].clientX;
            const diffX = touchCurrentX - touchStartX;
            const diffY = Math.abs(e.touches[0].clientY - touchStartY);

            // Only trigger if horizontal swipe from left edge
            if (diffX > 0 && diffX > diffY && touchStartX < 50) {
                document.body.style.transform = `translateX(${Math.min(diffX, 100)}px)`;
                document.body.style.transition = 'none';
            }
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            const diffX = touchCurrentX - touchStartX;

            document.body.style.transition = 'transform 0.3s ease-out';

            if (diffX > 80 && touchStartX < 50) {
                // Swipe completed - navigate back
                document.body.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 200);
            } else {
                document.body.style.transform = '';
            }

            touchStartX = 0;
            touchCurrentX = 0;
        }, { passive: true });

        // Initialize Lucide icons
        lucide.createIcons();
    </script>
</body>
</html>
