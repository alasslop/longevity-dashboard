<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrition Calculator - LongevityPath</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <!-- Shared Brand Styles -->
    <link rel="stylesheet" href="brand.css">

    <style>
        /* Calculator-specific styles using brand variables */

        /* Input Grid Layouts */
        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .input-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
        }

        .input-row-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .input-row-4 { grid-template-columns: 1fr 1fr; }
        }

        @media (max-width: 600px) {
            .input-row, .input-row-3, .input-row-4 { grid-template-columns: 1fr; }
        }

        /* Form Groups */
        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-family: var(--font-heading);
            font-size: 0.95rem;
            color: var(--color-teal);
            margin-bottom: 6px;
            font-weight: 500;
        }

        .input-hint {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            margin-top: 4px;
        }

        /* Calculate Button */
        .calculate-btn {
            width: 100%;
            padding: 16px 24px;
            background: var(--color-orange);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-family: var(--font-heading);
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 16px;
        }

        .calculate-btn:hover {
            background: #E08C4A;
        }

        /* Results Section */
        .results-card {
            display: none;
            background: var(--color-card);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-card);
        }

        .results-card.visible {
            display: block;
        }

        .results-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .results-header h2 {
            color: var(--color-teal);
            margin-bottom: 12px;
        }

        /* Badges */
        .goal-badge {
            display: inline-block;
            background: var(--color-teal);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .timeline-badge {
            display: inline-block;
            background: var(--color-accent);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.95rem;
            font-weight: 600;
        }

        /* Results Grid */
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 500px) {
            .results-grid { grid-template-columns: 1fr; }
        }

        .result-box {
            background: var(--color-bg);
            padding: 20px;
            border-radius: var(--radius-sm);
            text-align: center;
        }

        .result-box.highlight {
            background: var(--color-accent-light);
            border: 2px solid var(--color-accent);
        }

        .result-value {
            font-family: var(--font-heading);
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--color-teal);
        }

        .result-unit {
            font-size: 1rem;
            color: var(--color-text-muted);
        }

        .result-label {
            font-size: 0.9rem;
            color: var(--color-text-muted);
            margin-top: 4px;
        }

        /* Body Composition Summary */
        .composition-summary {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 16px;
            align-items: center;
            background: var(--color-bg);
            padding: 20px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .composition-summary {
                grid-template-columns: 1fr;
                text-align: center;
            }
            .composition-arrow { transform: rotate(90deg); }
        }

        .composition-box { text-align: center; }

        .composition-box .label {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            margin-bottom: 4px;
            font-weight: 600;
        }

        .composition-box .weight {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--color-teal);
        }

        .composition-box .detail {
            font-size: 0.85rem;
            color: var(--color-text-muted);
        }

        .composition-arrow {
            font-size: 2rem;
            color: var(--color-accent);
        }

        /* Change Summary */
        .change-summary {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .change-item {
            text-align: center;
            padding: 8px 16px;
            border-radius: var(--radius-xs);
        }

        .change-item.fat-loss {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .change-item.muscle-gain {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .change-item .value {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .change-item .label {
            font-size: 0.8rem;
        }

        /* Meal Breakdown */
        .meal-breakdown {
            background: var(--color-bg);
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
        }

        .meal-breakdown h4 {
            color: var(--color-teal);
            margin-bottom: 12px;
            font-family: var(--font-heading);
        }

        .meal-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--color-border);
        }

        .meal-row:last-child { border-bottom: none; }

        .meal-row.shake {
            background: var(--color-accent-light);
            margin: 4px -8px;
            padding: 10px 8px;
            border-radius: var(--radius-xs);
        }

        /* Calculation Details */
        .calculation-details {
            background: var(--color-bg);
            padding: 20px;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
        }

        .calculation-details h4 {
            color: var(--color-teal);
            margin-bottom: 16px;
            font-family: var(--font-heading);
        }

        .calc-section {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-border);
        }

        .calc-section:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .calc-section-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-teal);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .calc-section-title .step-num {
            background: var(--color-teal);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .calc-line {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            padding-left: 34px;
            color: var(--color-text);
        }

        .calc-line.formula {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 8px 12px;
            border-radius: var(--radius-xs);
            margin: 6px 0 6px 34px;
            font-size: 0.85rem;
        }

        .calc-line.total {
            border-top: 2px solid var(--color-border);
            margin-top: 10px;
            padding-top: 10px;
            font-weight: 600;
        }

        .calc-line.result {
            background: var(--color-accent);
            color: white;
            padding: 10px 14px;
            border-radius: var(--radius-xs);
            margin: 10px 0 10px 34px;
            font-weight: 600;
        }

        /* Privacy Notice */
        .privacy-notice {
            text-align: center;
            font-size: 0.8rem;
            color: var(--color-text-muted);
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .privacy-notice svg {
            width: 14px;
            height: 14px;
        }

        /* Info Box (for recomp explanation) */
        .info-box-calc {
            background: #e3f2fd;
            padding: 16px;
            border-radius: var(--radius-sm);
            margin-top: 16px;
            font-size: 0.9rem;
            color: var(--color-text);
        }

        .info-box-calc strong {
            color: var(--color-teal);
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="index.html" class="back-link">‚Üê Back to Assessment</a>

        <h1>Nutrition Calculator</h1>
        <p class="subtitle">Personalized calories and protein based on your goals</p>

        <!-- No JavaScript Fallback -->
        <noscript>
            <div class="warning-box">
                <strong>JavaScript Required</strong>
                <p>This calculator requires JavaScript. Please enable JavaScript or use our <a href="protein-calculator.html#noscript">manual calculation tables</a>.</p>
            </div>
        </noscript>

        <!-- Input Form: Body -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-icon">1</div>
                <div class="section-title">Your Body Composition</div>
            </div>

            <div class="input-row-4">
                <div class="input-group">
                    <label for="weight">Current Weight (kg)</label>
                    <input type="number" id="weight" placeholder="e.g., 85" min="30" max="300" step="0.1">
                </div>
                <div class="input-group">
                    <label for="bodyfat">Current Body Fat %</label>
                    <input type="number" id="bodyfat" placeholder="e.g., 25" min="3" max="60" step="0.1">
                </div>
                <div class="input-group">
                    <label for="targetWeight">Target Weight (kg)</label>
                    <input type="number" id="targetWeight" placeholder="e.g., 80" min="30" max="300" step="0.1">
                </div>
                <div class="input-group">
                    <label for="targetBodyfat">Target Body Fat %</label>
                    <input type="number" id="targetBodyfat" placeholder="e.g., 18" min="3" max="60" step="0.1">
                </div>
            </div>
            <p class="input-hint">Body fat from DEXA, calipers, or smart scale. <a href="body-fat-guide.html" class="help-link-inline">?</a></p>

            <div class="input-row-3" style="margin-top: 16px;">
                <div class="input-group">
                    <label for="height">Height (cm)</label>
                    <input type="number" id="height" placeholder="e.g., 175" min="100" max="250">
                </div>
                <div class="input-group">
                    <label for="age">Age</label>
                    <input type="number" id="age" placeholder="e.g., 45" min="18" max="120">
                </div>
                <div class="input-group">
                    <label for="sex">Sex</label>
                    <select id="sex">
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label for="diet">Diet Type</label>
                <select id="diet">
                    <option value="omnivore">Omnivore</option>
                    <option value="vegetarian">Vegetarian</option>
                    <option value="vegan">Vegan</option>
                </select>
                <p class="input-hint">Plant-based diets need ~10-25% more protein for equivalent muscle protein synthesis</p>
            </div>
        </div>

        <!-- Input Form: Activity -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-icon">2</div>
                <div class="section-title">Your Activity Level</div>
            </div>

            <div class="input-group">
                <label for="activityLevel">Activity Level</label>
                <select id="activityLevel">
                    <option value="1.2">Sedentary (little or no exercise, desk job)</option>
                    <option value="1.375">Lightly Active (light exercise 1-3 days/week)</option>
                    <option value="1.55" selected>Moderately Active (moderate exercise 3-5 days/week)</option>
                    <option value="1.725">Very Active (hard exercise 6-7 days/week)</option>
                    <option value="1.9">Extremely Active (hard daily exercise + physical job)</option>
                </select>
            </div>

            <div class="input-group">
                <label for="hasResistance">Resistance Training</label>
                <select id="hasResistance">
                    <option value="no">No resistance training</option>
                    <option value="yes">Yes, I do resistance training</option>
                </select>
                <p class="input-hint">Essential for muscle gain and preservation. Without it, muscle building is severely limited.</p>
            </div>
        </div>

        <!-- Input Form: Meals -->
        <div class="section-card">
            <div class="section-header">
                <div class="section-icon">3</div>
                <div class="section-title">Meal Distribution</div>
            </div>

            <div class="input-row">
                <div class="input-group">
                    <label for="mealsPerDay">Meals Per Day</label>
                    <select id="mealsPerDay">
                        <option value="1">1 meal (OMAD)</option>
                        <option value="2">2 meals</option>
                        <option value="3" selected>3 meals</option>
                        <option value="4">4 meals</option>
                        <option value="5">5 meals</option>
                        <option value="6">6 meals</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="proteinShakes">Protein Shakes Per Day</label>
                    <select id="proteinShakes">
                        <option value="0" selected>0 shakes</option>
                        <option value="1">1 shake</option>
                        <option value="2">2 shakes</option>
                    </select>
                    <p class="input-hint">Shake protein calculated by age. Rest distributed across meals.</p>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateNutrition()">Calculate My Targets</button>

            <p class="privacy-notice">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                All calculations happen in your browser. No data is sent or stored.
            </p>
        </div>

        <!-- Results Section -->
        <div class="results-card" id="results">
            <div class="results-header">
                <h2>Your Personalized Targets</h2>
                <div class="goal-badge" id="goalBadge">‚Äî Mode</div>
                <br><br>
                <div class="timeline-badge" id="timeline">‚Äî weeks to goal</div>
            </div>

            <!-- Body Composition Summary -->
            <div class="composition-summary" id="compositionSummary">
                <div class="composition-box">
                    <div class="label">CURRENT</div>
                    <div class="weight" id="currentWeightDisplay">85 kg</div>
                    <div class="detail" id="currentCompDisplay">25% BF ‚Ä¢ 21.3 kg fat ‚Ä¢ 63.7 kg lean</div>
                </div>
                <div class="composition-arrow">‚Üí</div>
                <div class="composition-box">
                    <div class="label">TARGET</div>
                    <div class="weight" id="targetWeightDisplay">80 kg</div>
                    <div class="detail" id="targetCompDisplay">18% BF ‚Ä¢ 14.4 kg fat ‚Ä¢ 65.6 kg lean</div>
                </div>
            </div>

            <div class="change-summary" id="changeSummary">
                <div class="change-item fat-loss">
                    <div class="value" id="fatChangeValue">‚àí6.9 kg</div>
                    <div class="label">Fat Loss</div>
                </div>
                <div class="change-item muscle-gain">
                    <div class="value" id="muscleChangeValue">+1.9 kg</div>
                    <div class="label">Lean Mass</div>
                </div>
            </div>

            <div class="results-grid" style="margin-top: 24px;">
                <div class="result-box highlight">
                    <div class="result-value" id="dailyCalories">‚Äî</div>
                    <div class="result-unit">kcal/day</div>
                    <div class="result-label">Daily Calories</div>
                </div>
                <div class="result-box highlight">
                    <div class="result-value" id="dailyProtein">‚Äî</div>
                    <div class="result-unit">g/day</div>
                    <div class="result-label">Daily Protein</div>
                </div>
                <div class="result-box">
                    <div class="result-value" id="proteinPercent">‚Äî</div>
                    <div class="result-unit">%</div>
                    <div class="result-label">Protein (% of calories)</div>
                </div>
                <div class="result-box">
                    <div class="result-value" id="deficit">‚Äî</div>
                    <div class="result-unit">kcal/day</div>
                    <div class="result-label" id="deficitLabel">Calorie Deficit</div>
                </div>
            </div>

            <div class="meal-breakdown" id="mealBreakdown">
                <h4>Daily Meal Plan</h4>
                <!-- Filled by JavaScript -->
            </div>

            <div class="calculation-details" id="calculationDetails">
                <h4>How We Calculated This</h4>
                <!-- Filled by JavaScript -->
            </div>

            <div class="warning-box" id="warningBox" style="display: none; margin-top: 16px;">
                <!-- Warnings displayed here -->
            </div>

            <div class="info-box-calc" id="infoBox" style="display: none;">
                <!-- Info displayed here -->
            </div>
        </div>

        <p class="text-center text-muted mt-32" style="font-size: 0.85rem;">
            Last updated: February 2026 ‚Ä¢ Based on peer-reviewed research
        </p>
    </div>

    <script>
        // ============================================
        // CONSTANTS
        // ============================================

        const KCAL_PER_KG_FAT = 7700;
        const SHAKE_KCAL_PER_GRAM_PROTEIN = 5;
        const MAX_FAT_LOSS_PER_WEEK = 1.0;
        const MODERATE_FAT_LOSS_PER_WEEK = 0.5;
        const RECOMP_DEFICIT = 250;

        const PROTEIN_MULTIPLIERS = {
            maintain: 1.6,
            recomp: 2.4,
            mildDeficit: 2.0,
            moderateDeficit: 2.2,
            aggressiveDeficit: 2.4,
            bulk: 2.0
        };

        // ============================================
        // AGE-ADJUSTED FUNCTIONS
        // ============================================

        function getMuscleGainRate(age, hasResistance, sex = 'male') {
            let baseRate;
            if (age < 30) baseRate = 1.0;
            else if (age < 40) baseRate = 0.8;
            else if (age < 50) baseRate = 0.6;
            else if (age < 60) baseRate = 0.4;
            else if (age < 70) baseRate = 0.3;
            else baseRate = 0.2;

            if (sex === 'female') baseRate *= 0.5;
            if (!hasResistance) baseRate *= 0.3;

            return baseRate;
        }

        function getBulkingMultiplier(age) {
            if (age >= 60) return 2.4;
            if (age >= 40) return 2.2;
            return 2.0;
        }

        function getPerMealFactor(age) {
            if (age >= 70) return 0.60;
            if (age >= 60) return 0.55;
            if (age >= 50) return 0.50;
            if (age >= 40) return 0.40;
            return 0.30;
        }

        function getDietFactor(diet) {
            if (diet === 'vegan') return 1.25;
            if (diet === 'vegetarian') return 1.10;
            return 1.0;
        }

        function getAgeCategory(age) {
            if (age >= 70) return { name: '70+', resistance: 'severe anabolic resistance', perMeal: '~40g+ per meal for MPS' };
            if (age >= 60) return { name: '60s', resistance: 'significant anabolic resistance', perMeal: '~35g+ per meal for MPS' };
            if (age >= 50) return { name: '50s', resistance: 'moderate anabolic resistance', perMeal: '~30g+ per meal for MPS' };
            if (age >= 40) return { name: '40s', resistance: 'mild anabolic resistance', perMeal: '~25g+ per meal for MPS' };
            return { name: 'under 40', resistance: 'optimal anabolic response', perMeal: '~20g+ per meal for MPS' };
        }

        // ============================================
        // BMR CALCULATIONS
        // ============================================

        function calculateBMR_KatchMcArdle(lbm) {
            return 370 + (21.6 * lbm);
        }

        // ============================================
        // MAIN CALCULATION
        // ============================================

        function calculateNutrition() {
            const weight = parseFloat(document.getElementById('weight').value);
            const bodyfat = parseFloat(document.getElementById('bodyfat').value);
            const targetWeight = parseFloat(document.getElementById('targetWeight').value);
            const targetBodyfat = parseFloat(document.getElementById('targetBodyfat').value);
            const height = parseFloat(document.getElementById('height').value);
            const age = parseInt(document.getElementById('age').value);
            const sex = document.getElementById('sex').value;
            const diet = document.getElementById('diet').value;
            const activityLevel = parseFloat(document.getElementById('activityLevel').value);
            const hasResistance = document.getElementById('hasResistance').value === 'yes';
            const mealsPerDay = parseInt(document.getElementById('mealsPerDay').value);
            const proteinShakes = parseInt(document.getElementById('proteinShakes').value);

            // Validation
            if (!weight || !height || !age) {
                alert('Please enter your weight, height, and age.');
                return;
            }
            if (!bodyfat || bodyfat <= 0) {
                alert('Please enter your current body fat %. See the estimation guide below.');
                return;
            }
            if (!targetWeight) {
                alert('Please enter your target weight.');
                return;
            }
            if (!targetBodyfat || targetBodyfat <= 0) {
                alert('Please enter your target body fat %. This is needed to calculate body composition changes.');
                return;
            }

            // STEP 1: Body Composition
            const currentFatMass = weight * (bodyfat / 100);
            const currentLBM = weight - currentFatMass;
            const targetFatMass = targetWeight * (targetBodyfat / 100);
            const targetLBM = targetWeight - targetFatMass;
            const fatChange = targetFatMass - currentFatMass;
            const lbmChange = targetLBM - currentLBM;
            const weightChange = targetWeight - weight;

            // STEP 2: Goal Type
            let goalType;
            const isLosingFat = fatChange < -0.5;
            const isGainingMuscle = lbmChange > 0.5;
            const isSameWeight = Math.abs(weightChange) <= 0.5;

            if (isSameWeight && isLosingFat && isGainingMuscle) {
                goalType = 'recomp';
            } else if (isLosingFat && isGainingMuscle) {
                goalType = 'recomp-weight-change';
            } else if (isLosingFat && !isGainingMuscle) {
                goalType = 'fat-loss';
            } else if (isGainingMuscle && !isLosingFat) {
                goalType = 'muscle-gain';
            } else if (Math.abs(fatChange) < 0.5 && Math.abs(lbmChange) < 0.5) {
                goalType = 'maintain';
            } else {
                goalType = 'recomp';
            }

            // STEP 3: BMR & TDEE
            const bmr = calculateBMR_KatchMcArdle(currentLBM);
            const tdee = bmr * activityLevel;

            // STEP 4: Timeline
            const muscleGainRate = getMuscleGainRate(age, hasResistance, sex);
            let weeksForFatLoss = 0;
            let weeksForMuscleGain = 0;
            let limitingFactor = '';
            let fatLossRate = 0;

            if (isLosingFat) {
                const fatToLose = Math.abs(fatChange);
                fatLossRate = (goalType === 'recomp' || goalType === 'recomp-weight-change')
                    ? MODERATE_FAT_LOSS_PER_WEEK
                    : Math.min(MAX_FAT_LOSS_PER_WEEK, fatToLose / 8);
                weeksForFatLoss = fatToLose / fatLossRate;
            }

            if (isGainingMuscle) {
                const muscleToGain = lbmChange;
                const monthsForMuscle = muscleToGain / muscleGainRate;
                weeksForMuscleGain = monthsForMuscle * 4.33;
            }

            let totalWeeks;
            if (goalType === 'maintain') {
                totalWeeks = 0;
                limitingFactor = 'Maintenance mode';
            } else if (weeksForMuscleGain > weeksForFatLoss) {
                totalWeeks = Math.ceil(weeksForMuscleGain);
                limitingFactor = 'muscle gain rate';
            } else if (weeksForFatLoss > 0) {
                totalWeeks = Math.ceil(weeksForFatLoss);
                limitingFactor = 'fat loss rate';
            } else {
                totalWeeks = Math.ceil(weeksForMuscleGain);
                limitingFactor = 'muscle gain rate';
            }

            // STEP 5: Calories
            let targetCalories;
            let dailyDeficit = 0;
            let dailySurplus = 0;
            let hitFloor = false;
            const minCalories = sex === 'male' ? 1500 : 1200;

            if (goalType === 'maintain') {
                targetCalories = Math.round(tdee);
            } else if (goalType === 'recomp') {
                // Same weight recomp: slight surplus to fuel muscle building
                // Muscle is anabolic - needs energy. Plus metabolic rate rises with more muscle.
                dailySurplus = 150;  // Small surplus for muscle synthesis
                targetCalories = Math.round(tdee + dailySurplus);
            } else if (goalType === 'recomp-weight-change') {
                // Losing weight while recomping - depends on body fat level
                const isLean = (sex === 'male' && bodyfat <= 15) || (sex === 'female' && bodyfat <= 22);
                if (isLean) {
                    dailyDeficit = 0;  // Maintenance for lean individuals
                    targetCalories = Math.round(tdee);
                } else {
                    dailyDeficit = RECOMP_DEFICIT;  // Small deficit OK for higher BF
                    targetCalories = Math.round(tdee - dailyDeficit);
                }
            } else if (goalType === 'fat-loss') {
                dailyDeficit = (fatLossRate * KCAL_PER_KG_FAT) / 7;
                targetCalories = Math.round(tdee - dailyDeficit);
            } else if (goalType === 'muscle-gain') {
                dailySurplus = 250 + (muscleGainRate * 100);
                targetCalories = Math.round(tdee + dailySurplus);
            }

            if (targetCalories < minCalories) {
                hitFloor = true;
                targetCalories = minCalories;
                dailyDeficit = tdee - targetCalories;
            }

            // STEP 6: Protein
            let proteinMultiplier;
            let proteinRationale;

            if (goalType === 'maintain') {
                proteinMultiplier = PROTEIN_MULTIPLIERS.maintain;
                proteinRationale = 'Maintenance protein for muscle preservation';
            } else if (goalType === 'recomp') {
                proteinMultiplier = PROTEIN_MULTIPLIERS.recomp;
                proteinRationale = 'Maximum protein for recomposition with slight surplus';
            } else if (goalType === 'recomp-weight-change') {
                proteinMultiplier = PROTEIN_MULTIPLIERS.recomp;
                const isLean = (sex === 'male' && bodyfat <= 15) || (sex === 'female' && bodyfat <= 22);
                proteinRationale = isLean
                    ? 'Maximum protein for lean recomp at maintenance calories'
                    : 'Maximum protein for recomp in mild deficit (Longland et al. 2016)';
            } else if (goalType === 'fat-loss') {
                if (fatLossRate <= 0.5) {
                    proteinMultiplier = PROTEIN_MULTIPLIERS.mildDeficit;
                    proteinRationale = 'Elevated protein for muscle preservation in mild deficit';
                } else if (fatLossRate <= 0.75) {
                    proteinMultiplier = PROTEIN_MULTIPLIERS.moderateDeficit;
                    proteinRationale = 'High protein for muscle preservation in moderate deficit';
                } else {
                    proteinMultiplier = PROTEIN_MULTIPLIERS.aggressiveDeficit;
                    proteinRationale = 'Maximum protein for muscle preservation in aggressive deficit';
                }
            } else if (goalType === 'muscle-gain') {
                proteinMultiplier = getBulkingMultiplier(age);
                proteinRationale = `Age-adjusted protein for muscle building (${age >= 60 ? 'compensating for anabolic resistance' : age >= 40 ? 'moderate anabolic resistance' : 'optimal response'})`;
            }

            const dietFactor = getDietFactor(diet);
            const dailyProtein = Math.round(currentLBM * proteinMultiplier * dietFactor);

            // STEP 7: Per-Meal Distribution
            const perMealFactor = getPerMealFactor(age);
            const proteinPerShake = Math.round(currentLBM * perMealFactor * dietFactor);
            const shakeCalories = proteinPerShake * SHAKE_KCAL_PER_GRAM_PROTEIN;

            const proteinFromShakes = proteinShakes * proteinPerShake;
            const proteinFromMeals = Math.max(0, dailyProtein - proteinFromShakes);

            const caloriesForMeals = targetCalories - (proteinShakes * shakeCalories);
            const perMealCalories = mealsPerDay > 0 ? Math.round(caloriesForMeals / mealsPerDay) : 0;
            const perMealProtein = mealsPerDay > 0 ? Math.round(proteinFromMeals / mealsPerDay) : 0;

            const proteinCalories = dailyProtein * 4;
            const proteinPercent = Math.round((proteinCalories / targetCalories) * 100);

            const minPerMealProtein = proteinPerShake;
            const perMealProteinOk = perMealProtein >= minPerMealProtein || proteinShakes > 0;

            // ============================================
            // DISPLAY RESULTS
            // ============================================

            const goalLabels = {
                'maintain': '‚öñÔ∏è Maintenance',
                'recomp': 'üîÑ Body Recomposition',
                'recomp-weight-change': 'üîÑ Recomp + Weight Loss',
                'fat-loss': 'üî• Fat Loss',
                'muscle-gain': 'üí™ Muscle Building'
            };
            document.getElementById('goalBadge').textContent = goalLabels[goalType] || goalType;

            document.getElementById('currentWeightDisplay').textContent = `${weight} kg`;
            document.getElementById('currentCompDisplay').textContent = `${bodyfat}% BF ‚Ä¢ ${currentFatMass.toFixed(1)} kg fat ‚Ä¢ ${currentLBM.toFixed(1)} kg lean`;

            document.getElementById('targetWeightDisplay').textContent = `${targetWeight} kg`;
            document.getElementById('targetCompDisplay').textContent = `${targetBodyfat}% BF ‚Ä¢ ${targetFatMass.toFixed(1)} kg fat ‚Ä¢ ${targetLBM.toFixed(1)} kg lean`;

            document.getElementById('fatChangeValue').textContent = fatChange >= 0 ? `+${fatChange.toFixed(1)} kg` : `${fatChange.toFixed(1)} kg`;
            document.getElementById('muscleChangeValue').textContent = lbmChange >= 0 ? `+${lbmChange.toFixed(1)} kg` : `${lbmChange.toFixed(1)} kg`;

            const fatBox = document.querySelector('.change-item.fat-loss');
            const muscleBox = document.querySelector('.change-item.muscle-gain');

            if (fatChange > 0) {
                fatBox.style.background = '#ffebee';
                fatBox.style.color = '#c62828';
                fatBox.querySelector('.label').textContent = 'Fat Gain';
            } else {
                fatBox.style.background = '#e8f5e9';
                fatBox.style.color = '#2e7d32';
                fatBox.querySelector('.label').textContent = 'Fat Loss';
            }

            if (lbmChange < 0) {
                muscleBox.style.background = '#ffebee';
                muscleBox.style.color = '#c62828';
                muscleBox.querySelector('.label').textContent = 'Lean Mass Loss';
            } else {
                muscleBox.style.background = '#e8f5e9';
                muscleBox.style.color = '#2e7d32';
                muscleBox.querySelector('.label').textContent = 'Lean Mass Gain';
            }

            document.getElementById('dailyCalories').textContent = targetCalories.toLocaleString();
            document.getElementById('dailyProtein').textContent = dailyProtein;
            document.getElementById('proteinPercent').textContent = proteinPercent;

            const deficitLabel = document.getElementById('deficitLabel');
            if (dailySurplus > 0) {
                document.getElementById('deficit').textContent = '+' + Math.round(dailySurplus);
                deficitLabel.textContent = 'Calorie Surplus';
            } else if (dailyDeficit > 0) {
                document.getElementById('deficit').textContent = Math.round(dailyDeficit);
                deficitLabel.textContent = 'Calorie Deficit';
            } else {
                document.getElementById('deficit').textContent = '0';
                deficitLabel.textContent = 'Calorie Balance';
            }

            if (goalType === 'maintain') {
                document.getElementById('timeline').textContent = 'Maintenance mode - no timeline';
            } else {
                const months = Math.round(totalWeeks / 4.33);
                if (months >= 12) {
                    const years = (months / 12).toFixed(1);
                    document.getElementById('timeline').textContent = `~${years} years (${totalWeeks} weeks) ‚Ä¢ Limited by ${limitingFactor}`;
                } else if (months >= 2) {
                    document.getElementById('timeline').textContent = `~${months} months (${totalWeeks} weeks) ‚Ä¢ Limited by ${limitingFactor}`;
                } else {
                    document.getElementById('timeline').textContent = `~${totalWeeks} weeks ‚Ä¢ Limited by ${limitingFactor}`;
                }
            }

            // Meal breakdown
            let mealHtml = '';
            for (let i = 1; i <= mealsPerDay; i++) {
                mealHtml += `<div class="meal-row"><span>Meal ${i}</span><span><strong>${perMealProtein}g protein</strong> ‚Ä¢ ${perMealCalories} kcal</span></div>`;
            }
            if (proteinShakes > 0) {
                for (let i = 1; i <= proteinShakes; i++) {
                    mealHtml += `<div class="meal-row shake"><span>ü•§ Protein Shake ${i}</span><span><strong>${proteinPerShake}g protein</strong> ‚Ä¢ ~${Math.round(shakeCalories)} kcal</span></div>`;
                }
            }
            document.getElementById('mealBreakdown').innerHTML = `<h4>Daily Meal Plan</h4>${mealHtml}`;

            // Calculation details
            const activityLabels = {
                '1.2': 'Sedentary (√ó1.2)',
                '1.375': 'Lightly Active (√ó1.375)',
                '1.55': 'Moderately Active (√ó1.55)',
                '1.725': 'Very Active (√ó1.725)',
                '1.9': 'Extremely Active (√ó1.9)'
            };
            const activityLabel = activityLabels[activityLevel.toString()] || `√ó${activityLevel}`;
            const ageCategory = getAgeCategory(age);

            let calculationHtml = `
                <h4>How We Calculated This</h4>

                <div class="calc-section">
                    <div class="calc-section-title"><span class="step-num">1</span> Body Composition Analysis</div>
                    <div class="calc-line"><span>Current weight</span><span>${weight} kg</span></div>
                    <div class="calc-line"><span>Current body fat</span><span>${bodyfat}%</span></div>
                    <div class="calc-line formula">Fat mass = ${weight} √ó ${bodyfat}% = ${currentFatMass.toFixed(2)} kg</div>
                    <div class="calc-line formula">Lean body mass = ${weight} ‚àí ${currentFatMass.toFixed(2)} = ${currentLBM.toFixed(2)} kg</div>
                    <div class="calc-line"><span>Target weight</span><span>${targetWeight} kg</span></div>
                    <div class="calc-line"><span>Target body fat</span><span>${targetBodyfat}%</span></div>
                    <div class="calc-line formula">Target fat = ${targetWeight} √ó ${targetBodyfat}% = ${targetFatMass.toFixed(2)} kg</div>
                    <div class="calc-line formula">Target LBM = ${targetWeight} ‚àí ${targetFatMass.toFixed(2)} = ${targetLBM.toFixed(2)} kg</div>
                    <div class="calc-line total"><span>Fat change</span><span><strong>${fatChange >= 0 ? '+' : ''}${fatChange.toFixed(2)} kg</strong></span></div>
                    <div class="calc-line total"><span>Lean mass change</span><span><strong>${lbmChange >= 0 ? '+' : ''}${lbmChange.toFixed(2)} kg</strong></span></div>
                    <div class="calc-line result"><span>Goal Type</span><span>${goalLabels[goalType]}</span></div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title"><span class="step-num">2</span> BMR (Katch-McArdle)</div>
                    <div class="calc-line formula">BMR = 370 + (21.6 √ó ${currentLBM.toFixed(1)}) = ${Math.round(bmr)} kcal</div>
                    <div class="calc-line"><span>Activity multiplier</span><span>${activityLabel}</span></div>
                    <div class="calc-line formula">TDEE = ${Math.round(bmr)} √ó ${activityLevel} = ${Math.round(tdee)} kcal</div>
                    <div class="calc-line result"><span>TDEE</span><span>${Math.round(tdee)} kcal/day</span></div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title"><span class="step-num">3</span> Timeline (Biology-Limited)</div>
                    ${isLosingFat ? `<div class="calc-line"><span>Fat to lose</span><span>${Math.abs(fatChange).toFixed(2)} kg at ${fatLossRate.toFixed(2)} kg/week</span></div><div class="calc-line formula">Fat loss time = ${Math.abs(fatChange).toFixed(2)} √∑ ${fatLossRate.toFixed(2)} = ${weeksForFatLoss.toFixed(1)} weeks</div>` : ''}
                    ${isGainingMuscle ? `<div class="calc-line"><span>Muscle to gain</span><span>${lbmChange.toFixed(2)} kg at ${muscleGainRate.toFixed(2)} kg/month</span></div><div class="calc-line formula">Muscle time = ${(lbmChange / muscleGainRate).toFixed(1)} months = ${weeksForMuscleGain.toFixed(1)} weeks</div>` : ''}
                    <div class="calc-line result"><span>Timeline</span><span>${totalWeeks} weeks ‚Ä¢ ${limitingFactor}</span></div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title"><span class="step-num">4</span> Daily Calories</div>
                    <div class="calc-line"><span>TDEE</span><span>${Math.round(tdee)} kcal</span></div>
                    ${dailyDeficit > 0 ? `<div class="calc-line"><span>Deficit</span><span>‚àí${Math.round(dailyDeficit)} kcal</span></div>` : ''}
                    ${dailySurplus > 0 && goalType === 'recomp' ? `<div class="calc-line"><span>Recomp surplus</span><span>+${Math.round(dailySurplus)} kcal (fuels muscle building)</span></div>` : ''}
                    ${dailySurplus > 0 && goalType === 'muscle-gain' ? `<div class="calc-line"><span>Surplus</span><span>+${Math.round(dailySurplus)} kcal</span></div>` : ''}
                    ${goalType === 'recomp-weight-change' && dailyDeficit === 0 ? `<div class="calc-line"><span>Lean recomp</span><span>Maintenance (no deficit at ${bodyfat}% BF)</span></div>` : ''}
                    ${hitFloor ? `<div class="calc-line" style="color: #c62828;"><span>‚ö†Ô∏è Safety floor applied</span><span>${minCalories} kcal</span></div>` : ''}
                    <div class="calc-line result"><span>Target Calories</span><span>${targetCalories} kcal/day</span></div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title"><span class="step-num">5</span> Daily Protein (Age-Adjusted)</div>
                    <div class="calc-line"><span>Age category</span><span>${ageCategory.name} (${ageCategory.resistance})</span></div>
                    <div class="calc-line"><span>Protein multiplier</span><span>${proteinMultiplier} g/kg LBM</span></div>
                    ${dietFactor > 1 ? `<div class="calc-line"><span>Diet adjustment (${diet})</span><span>√ó${dietFactor}</span></div>` : ''}
                    <div class="calc-line formula">Protein = ${currentLBM.toFixed(1)} √ó ${proteinMultiplier}${dietFactor > 1 ? ` √ó ${dietFactor}` : ''} = ${dailyProtein}g</div>
                    <div class="calc-line result"><span>Target Protein</span><span>${dailyProtein}g/day (${proteinPercent}% of kcal)</span></div>
                </div>

                <div class="calc-section">
                    <div class="calc-section-title"><span class="step-num">6</span> Per-Meal Distribution</div>
                    <div class="calc-line"><span>Age-based threshold</span><span>${ageCategory.perMeal}</span></div>
                    <div class="calc-line"><span>Min per meal</span><span>${proteinPerShake}g protein</span></div>
                    ${proteinShakes > 0 ? `<div class="calc-line"><span>From ${proteinShakes} shake(s)</span><span>${proteinFromShakes}g</span></div><div class="calc-line"><span>From ${mealsPerDay} meal(s)</span><span>${proteinFromMeals}g</span></div>` : ''}
                    <div class="calc-line result"><span>Per Meal</span><span>${perMealProtein}g protein ‚Ä¢ ${perMealCalories} kcal</span></div>
                </div>
            `;
            document.getElementById('calculationDetails').innerHTML = calculationHtml;

            // Warnings
            let warnings = [];

            if (hitFloor) warnings.push(`‚ö†Ô∏è Calories hit safety minimum (${minCalories} kcal). Timeline may be longer.`);
            if (!perMealProteinOk && proteinShakes === 0) warnings.push(`‚ö†Ô∏è Per-meal protein (${perMealProtein}g) below age-optimal (${minPerMealProtein}g). Consider shakes or fewer meals.`);
            if (!hasResistance && isGainingMuscle) warnings.push(`‚ö†Ô∏è Without resistance training, muscle gain is ~30% of potential. Most surplus becomes fat.`);
            if (!hasResistance && (goalType === 'recomp' || goalType === 'recomp-weight-change')) warnings.push(`‚ö†Ô∏è Recomposition requires resistance training to build muscle.`);
            if (proteinPercent > 40) warnings.push(`‚ÑπÔ∏è Protein is ${proteinPercent}% of calories‚Äîsustainable but limited room for carbs/fats.`);
            if (mealsPerDay === 1 && proteinShakes === 0 && dailyProtein > 80) warnings.push(`‚ö†Ô∏è OMAD: Hard to get ${dailyProtein}g in one meal. Add shakes.`);
            if (totalWeeks > 104) warnings.push(`‚ÑπÔ∏è Goal takes >2 years. Consider intermediate targets.`);
            if (targetBodyfat < 10 && sex === 'male') warnings.push(`‚ö†Ô∏è <10% body fat is hard to maintain and may affect hormones.`);
            if (targetBodyfat < 18 && sex === 'female') warnings.push(`‚ö†Ô∏è <18% body fat for women may affect hormones.`);

            const warningBox = document.getElementById('warningBox');
            if (warnings.length > 0) {
                warningBox.innerHTML = `<strong>Important Notes:</strong><br><br>` + warnings.join('<br><br>');
                warningBox.style.display = 'block';
            } else {
                warningBox.style.display = 'none';
            }

            // Info box for recomp
            const infoBox = document.getElementById('infoBox');
            if (goalType === 'recomp') {
                // Same weight recomp - slight surplus
                infoBox.innerHTML = `
                    <strong>Body Recomposition (Same Weight):</strong> You're replacing fat with muscle. This requires:
                    <br>‚Ä¢ <strong>Slight surplus (+150 kcal)</strong> ‚Äî muscle building is anabolic and needs energy
                    <br>‚Ä¢ <strong>High protein (2.4 g/kg LBM)</strong> ‚Äî maximizes muscle protein synthesis
                    <br>‚Ä¢ <strong>Progressive resistance training</strong> ‚Äî the primary driver of recomposition
                    <br>‚Ä¢ <strong>Patience</strong> ‚Äî recomp takes time (${muscleGainRate.toFixed(2)} kg muscle/month at age ${age})
                    <br><br><em>Science: As you gain muscle, your metabolic rate increases. A slight surplus fuels muscle building while your body gradually shifts composition.</em>
                `;
                infoBox.style.display = 'block';
            } else if (goalType === 'recomp-weight-change') {
                const isLean = (sex === 'male' && bodyfat <= 15) || (sex === 'female' && bodyfat <= 22);
                if (isLean) {
                    infoBox.innerHTML = `
                        <strong>Lean Recomposition:</strong> At ${bodyfat}% body fat, you're already lean. This requires:
                        <br>‚Ä¢ <strong>Maintenance calories</strong> ‚Äî no deficit; your body can use stored fat while building muscle
                        <br>‚Ä¢ <strong>High protein (2.4 g/kg LBM)</strong> ‚Äî maximizes muscle protein synthesis
                        <br>‚Ä¢ <strong>Progressive resistance training</strong> ‚Äî the primary driver of recomposition
                        <br>‚Ä¢ <strong>Patience</strong> ‚Äî lean recomp is slower (${muscleGainRate.toFixed(2)} kg/month at age ${age})
                        <br><br><em>Science: For lean individuals, a deficit impairs muscle building. Maintenance + high protein + training = optimal.</em>
                    `;
                } else {
                    infoBox.innerHTML = `
                        <strong>Recomposition + Weight Loss:</strong> Losing fat while preserving/building muscle. This requires:
                        <br>‚Ä¢ <strong>High protein (2.4 g/kg LBM)</strong> ‚Äî the highest recommendation
                        <br>‚Ä¢ <strong>Small deficit (${RECOMP_DEFICIT} kcal)</strong> ‚Äî your fat stores can fuel the process
                        <br>‚Ä¢ <strong>Resistance training</strong> ‚Äî essential for muscle stimulus
                        <br>‚Ä¢ <strong>Patience</strong> ‚Äî muscle builds slowly (${muscleGainRate.toFixed(2)} kg/month at age ${age})
                        <br><br><em>Research: Longland et al. (2016) showed 2.4g/kg protein enabled +1.2kg muscle while losing 4.8kg fat.</em>
                    `;
                }
                infoBox.style.display = 'block';
            } else {
                infoBox.style.display = 'none';
            }

            document.getElementById('results').classList.add('visible');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') calculateNutrition();
            });
        });
    </script>
</body>
</html>
