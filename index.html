<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Longevity Lifestyle Test - Your Results</title>

    <!-- Fonts: Lora (Headlines), Poppins (Body), Raleway (CTAs) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;500;600;700&family=Poppins:wght@300;400;500;600&family=Raleway:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* LongevityPath Brand Colors */
            --color-bg: #F7F4EB;
            --color-card: #FFFBF5;
            --color-text: #0D3137;
            --color-text-muted: #29484C;
            --color-border: #E7E5E4;
            --color-primary: #00905A;
            --color-primary-light: rgba(0, 144, 90, 0.1);
            --color-accent: #F4A261;
            --color-teal: #0D3137;
            --color-teal-accent: #29484C;
            --color-danger: #DC2626;
            --color-danger-light: #FEE2E2;
            --radius: 20px;
            --radius-sm: 12px;
            --radius-button: 30px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 24px 16px;
        }

        /* Header */
        .header {
            text-align: center;
            padding: 24px 24px;
            background: #00905A;
            border-radius: var(--radius);
            color: #FFFBF5;
            margin-bottom: 32px;
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-family: 'Lora', Georgia, serif;
            font-size: 2rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .greeting {
            font-size: 1.25rem;
            margin-bottom: 4px;
            opacity: 0.95;
        }

        /* Score Circle */
        .score-section {
            display: flex;
            justify-content: center;
            margin: -60px 0 32px;
            position: relative;
            z-index: 2;
        }

        .score-circle {
            width: 140px;
            height: 140px;
            background: var(--color-card);
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            border: 4px solid var(--color-primary);
        }

        .score-value {
            font-family: 'Lora', Georgia, serif;
            font-size: 2.5rem;
            color: var(--color-primary);
            line-height: 1;
        }

        .score-label {
            font-size: 0.75rem;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        /* Cards */
        .card {
            background: var(--color-card);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(13, 49, 55, 0.08);
            border: none;
        }

        .card-title {
            font-family: 'Lora', Georgia, serif;
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Section Header */
        .section-header {
            font-family: 'Lora', Georgia, serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-teal);
            margin: 24px 0 16px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--color-border);
        }

        .section-header:first-child {
            margin-top: 0;
        }

        .section-weight {
            font-size: 0.85rem;
            font-weight: 400;
            color: var(--color-text-muted);
        }

        /* Question Items - Editable */
        .question-item {
            padding: 16px;
            background: var(--color-bg);
            border-radius: var(--radius-sm);
            margin-bottom: 12px;
        }

        .question-item:last-child {
            margin-bottom: 0;
        }

        .question-label {
            font-size: 0.95rem;
            color: var(--color-text);
            margin-bottom: 12px;
            font-weight: 500;
        }

        .question-hint {
            font-size: 0.85rem;
            color: var(--color-text-muted);
            margin-bottom: 12px;
            font-style: italic;
        }

        .question-id {
            font-size: 0.8rem;
            color: var(--color-primary);
            font-weight: 600;
            margin-right: 8px;
        }

        /* Intro Section Styles */
        .intro-section {
            padding: 20px;
            background: var(--color-primary-light);
            border-radius: var(--radius-sm);
            border-left: 4px solid var(--color-primary);
            margin-bottom: 16px;
        }

        .intro-section p {
            font-size: 0.95rem;
            color: var(--color-text);
            margin-bottom: 16px;
            line-height: 1.7;
        }

        .intro-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: var(--color-primary);
            color: white;
            text-decoration: none;
            border-radius: var(--radius-button);
            font-family: 'Raleway', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .intro-link:hover {
            background: #007A4D;
            transform: translateY(-1px);
        }

        /* Slider Styles - Mobile Friendly */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .slider-input {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: #E7E5E4;
            border-radius: 4px;
            outline: none;
            cursor: pointer;
        }

        .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            background: var(--color-primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .slider-input::-moz-range-thumb {
            width: 28px;
            height: 28px;
            background: var(--color-primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .slider-value {
            min-width: 50px;
            padding: 8px 12px;
            background: var(--color-primary);
            color: white;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75rem;
            color: var(--color-text-muted);
        }

        /* Radio Button Styles - Mobile Friendly */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 48px;
        }

        .radio-option:hover {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .radio-option.selected {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: var(--color-primary);
            cursor: pointer;
            flex-shrink: 0;
            pointer-events: none;
        }

        .radio-option label {
            flex: 1;
            cursor: pointer;
            font-size: 0.9rem;
            pointer-events: none;
        }

        .radio-points {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            padding: 2px 8px;
            background: var(--color-bg);
            border-radius: 4px;
            white-space: nowrap;
        }

        /* Checkbox Styles */
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: white;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 48px;
        }

        .checkbox-option:hover {
            border-color: var(--color-primary);
        }

        .checkbox-option.selected {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .checkbox-option input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--color-primary);
            cursor: pointer;
            flex-shrink: 0;
            pointer-events: none;
        }

        .checkbox-option label {
            flex: 1;
            cursor: pointer;
            font-size: 0.9rem;
            pointer-events: none;
        }

        .evidence-tag {
            font-size: 0.7rem;
            color: var(--color-primary);
            background: var(--color-primary-light);
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
            font-weight: 500;
        }

        .help-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: var(--color-primary);
            color: white;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            text-decoration: none;
            margin-left: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .help-link:hover {
            background: var(--color-teal);
            transform: scale(1.1);
        }

        /* Number Input */
        .number-input {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .number-input input {
            width: 120px;
            padding: 12px 16px;
            border: 2px solid var(--color-border);
            border-radius: 8px;
            font-size: 1.1rem;
            font-family: 'Poppins', sans-serif;
            text-align: center;
        }

        .number-input input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .number-input span {
            color: var(--color-text-muted);
            font-size: 0.9rem;
        }

        /* Save Button */
        .save-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 14px 24px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-button);
            font-family: 'Raleway', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.2s;
        }

        .save-btn:hover {
            background: #007A4D;
            transform: translateY(-1px);
        }

        .save-btn:active {
            transform: translateY(0);
        }

        .save-btn.saved {
            background: var(--color-accent);
        }

        /* Change Log */
        .changelog-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 12px 0;
            border-bottom: 1px solid var(--color-border);
        }

        .changelog-item:last-child {
            border-bottom: none;
        }

        .changelog-date {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            white-space: nowrap;
        }

        .changelog-details {
            flex: 1;
            margin-left: 16px;
        }

        .changelog-category {
            font-weight: 600;
            color: var(--color-teal);
            font-size: 0.9rem;
        }

        .changelog-change {
            font-size: 0.85rem;
            color: var(--color-text-muted);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--color-bg);
            padding: 4px;
            border-radius: var(--radius-sm);
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--color-text-muted);
        }

        .tab.active {
            background: var(--color-card);
            color: var(--color-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Info Box */
        .info-box {
            background: var(--color-primary-light);
            border-left: 4px solid var(--color-primary);
            padding: 12px 16px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 16px;
            font-size: 0.85rem;
            color: var(--color-text-muted);
        }

        /* Responsive */
        @media (max-width: 640px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .slider-container {
                flex-wrap: wrap;
            }

            .slider-input {
                width: 100%;
                flex: none;
                margin-bottom: 8px;
            }

            .slider-value {
                width: 100%;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                text-align: center;
            }

            .changelog-item {
                flex-direction: column;
            }

            .changelog-details {
                margin-left: 0;
                margin-top: 8px;
            }

            .number-input {
                flex-direction: column;
                align-items: flex-start;
            }

            .number-input input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">

        <!-- Header -->
        <header class="header">
            <p class="greeting">Hello <span id="userName">John Doe</span>,</p>
            <h1>Your Nutrition Score</h1>
            <p>Last updated: <span id="testDate">02/02/2026</span></p>
        </header>

        <!-- Score Circle -->
        <div class="score-section">
            <div class="score-circle">
                <div class="score-value" id="percentage">0%</div>
                <div class="score-label" id="totalPoints">0/10 Points</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('scores')">ðŸ¥— Nutrition</button>
                <button class="tab" onclick="switchTab('history')">ðŸ“ˆ History</button>
            </div>

            <!-- Scores Tab -->
            <div id="scores-tab" class="tab-content active">
                <div class="info-box">
                    Answer the questions honestly. Your score is calculated automatically. Changes are logged.
                </div>
                <div id="nutritionForm"></div>
                <button class="save-btn" onclick="saveAllChanges()">
                    ðŸ’¾ Save All Changes
                </button>
            </div>

            <!-- History Tab -->
            <div id="history-tab" class="tab-content">
                <h3 style="font-family: 'Lora', serif; margin-bottom: 16px;">Change Log</h3>
                <div id="changelogList">
                    <p style="color: var(--color-text-muted); text-align: center; padding: 24px;">
                        No changes logged yet.
                    </p>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ========================================
        // NUTRITION ASSESSMENT - EXACT SEC 0-4
        // ========================================
        const NUTRITION_CONFIG = {
            // SEC 0: Getting Started (intro section, not scored)
            sec0: {
                title: "Getting Started with Nutrition",
                weight: 0, // Not scored
                type: "intro",
                description: "Before tracking your nutrition habits, we recommend using our Nutrition Calculator to determine your personalized calorie and protein targets based on your body composition and goals.",
                link: {
                    text: "â†’ Open Nutrition Calculator",
                    url: "nutrition-calculator.html"
                },
                questions: [] // No questions - intro section only
            },

            // SEC 1: Diet Adherence (25%)
            sec1: {
                title: "Diet Adherence",
                weight: 0.25,
                questions: [
                    {
                        id: "N1_1",
                        question: "How much do you enjoy your food?",
                        hint: "Rate from 1 (not at all) to 10 (always a delight)",
                        type: "slider",
                        min: 1,
                        max: 10,
                        hideLabels: true
                    },
                    {
                        id: "N1_2",
                        question: "In which situations does your diet work well?",
                        type: "checkbox",
                        scoring: "count",
                        options: [
                            { value: "restaurant", label: "Restaurant" },
                            { value: "travel", label: "Travel" },
                            { value: "Family and friends", label: "Family and friends" },
                            { value: "stress", label: "Stressful or time-limited situations" }
                        ]
                    },
                    {
                        id: "N1_3",
                        question: "How full and satisfied do you feel after eating?",
                        type: "radio",
                        options: [
                            { value: "10", label: "Always full, no cravings", points: 10 },
                            { value: "5", label: "Mostly full, rarely hungry", points: 5 },
                            { value: "2", label: "Regularly hungry (2-3 times a week)", points: 2 },
                            { value: "0", label: "Constantly hungry or daily struggle", points: 0 }
                        ]
                    }
                ]
            },

            // SEC 2: Progress (25%)
            sec2: {
                title: "Progress",
                weight: 0.25,
                questions: [
                    {
                        id: "N2_1",
                        question: "How is your progress towards your goals?",
                        type: "radio",
                        options: [
                            { value: "10", label: "Every week is a win - metrics on track, feeling great", points: 10 },
                            { value: "8", label: "Most weeks are successful", points: 8 },
                            { value: "5", label: "Slow but visible progress over months", points: 5 },
                            { value: "2", label: "Stagnation - at least not getting worse", points: 2 },
                            { value: "0", label: "Wrong direction - getting worse", points: 0 }
                        ]
                    }
                ]
            },

            // SEC 3: Protein (25%)
            sec3: {
                title: "Protein",
                weight: 0.25,
                helpLink: "protein-evidence.html",
                questions: [
                    {
                        id: "N3_1",
                        question: "I meet the required protein amount per day for my nutrition goal",
                        type: "radio",
                        options: [
                            { value: "10", label: "Always", points: 10 },
                            { value: "5", label: "Mostly", points: 5 },
                            { value: "0", label: "Rarely or never", points: 0 }
                        ]
                    },
                    {
                        id: "N3_2",
                        question: "How do you distribute your protein intake throughout the day?",
                        type: "radio",
                        options: [
                            { value: "10", label: "4+ meals or shakes above my minimum per-meal amount", points: 10 },
                            { value: "8", label: "3 meals or shakes above my minimum per-meal amount", points: 8 },
                            { value: "4", label: "2 meals or shakes above my minimum per-meal amount", points: 4 },
                            { value: "0", label: "1 or fewer meals above my minimum per-meal amount", points: 0 }
                        ]
                    }
                ]
            },

            // SEC 4: Nutrition Principles (25%) - Simplified checkboxes based on scientific consensus
            sec4: {
                title: "Nutrition Principles",
                weight: 0.25,
                description: "Check the habits you follow most days (7+ out of 10 days). Each habit is backed by strong scientific evidence.",
                questions: [
                    {
                        id: "N4_principles",
                        question: "Which nutrition principles do you consistently follow?",
                        helpLink: "nutrition-evidence.html",
                        type: "checkbox",
                        scoring: "principles", // Each checked = 2 points, max 10
                        options: [
                            { value: "vegetables", label: "I eat 3+ servings of non-starchy vegetables daily", evidence: "13% lower mortality" },
                            { value: "whole_foods", label: "Most of my meals are home-cooked from whole ingredients", evidence: "15% lower mortality" },
                            { value: "healthy_fats", label: "I include healthy fats regularly (olive oil, fish, nuts, avocados)", evidence: "30% less CVD" },
                            { value: "avoid_harmful", label: "I avoid trans fats (fried food, packaged snacks) and processed meats", evidence: "34% mortality reduction" },
                            { value: "alcohol", label: "I drink alcohol moderately or not at all (max 7/week, 2/day)", evidence: "Linear dose-response" }
                        ]
                    }
                ]
            }
        };

        // ========================================
        // DATA MANAGEMENT
        // ========================================
        let currentData = {
            userName: "John Doe",
            answers: {},
            changelog: []
        };

        // Track last saved state for change detection
        let lastSavedAnswers = {};

        // Load from localStorage
        function loadData() {
            const saved = localStorage.getItem('nutritionAssessmentEN');
            if (saved) {
                currentData = JSON.parse(saved);
            } else {
                // Initialize with default values
                Object.keys(NUTRITION_CONFIG).forEach(section => {
                    currentData.answers[section] = {};
                    NUTRITION_CONFIG[section].questions.forEach(q => {
                        if (q.type === 'slider') {
                            currentData.answers[section][q.id] = q.min === 1 ? 5 : 5;
                        } else if (q.type === 'radio') {
                            currentData.answers[section][q.id] = q.options[0].value;
                        } else if (q.type === 'checkbox') {
                            currentData.answers[section][q.id] = [];
                        } else if (q.type === 'number') {
                            currentData.answers[section][q.id] = q.id === 'current_weight' ? 165 : 155;
                        }
                    });
                });
            }
            // Store initial state for change tracking
            lastSavedAnswers = JSON.parse(JSON.stringify(currentData.answers));
        }

        // Save to localStorage
        function saveData() {
            localStorage.setItem('nutritionAssessmentEN', JSON.stringify(currentData));
        }

        // ========================================
        // SCORE CALCULATION
        // ========================================
        function calculateSectionScore(sectionKey) {
            const section = NUTRITION_CONFIG[sectionKey];
            if (section.weight === 0) return null; // SEC 0 is not scored

            const answers = currentData.answers[sectionKey] || {};
            let totalScore = 0;
            let maxScore = 0;

            section.questions.forEach(q => {
                const value = answers[q.id];

                if (q.type === 'slider') {
                    const sliderValue = parseFloat(value) || q.min;
                    if (q.min === 1) {
                        // Convert 1-10 to 0-10 for scoring
                        totalScore += sliderValue - 1;
                        maxScore += 9;
                    } else {
                        totalScore += sliderValue;
                        maxScore += q.max;
                    }
                } else if (q.type === 'radio' && q.options[0].points !== undefined) {
                    totalScore += parseFloat(value) || 0;
                    maxScore += 10;
                } else if (q.type === 'checkbox' && q.scoring === 'count') {
                    // N1.2: 4 situations = 10 points
                    const count = Array.isArray(value) ? value.length : 0;
                    totalScore += (count / 4) * 10;
                    maxScore += 10;
                } else if (q.type === 'checkbox' && q.scoring === 'principles') {
                    // N4: Each principle = 2 points, max 10
                    const count = Array.isArray(value) ? value.length : 0;
                    totalScore += count * 2;
                    maxScore += 10;
                }
            });

            return maxScore > 0 ? (totalScore / maxScore) * 10 : 0;
        }

        function calculateTotalScore() {
            let weightedSum = 0;
            let totalWeight = 0;

            Object.keys(NUTRITION_CONFIG).forEach(sectionKey => {
                const section = NUTRITION_CONFIG[sectionKey];
                if (section.weight > 0) {
                    const score = calculateSectionScore(sectionKey);
                    weightedSum += score * section.weight;
                    totalWeight += section.weight;
                }
            });

            return totalWeight > 0 ? Math.round(weightedSum / totalWeight * 10) / 10 : 0;
        }

        function getScoreClass(value) {
            if (value >= 7) return 'excellent';
            if (value >= 4) return 'good';
            return 'needs-work';
        }

        // ========================================
        // CHANGELOG
        // ========================================
        function logChange(sectionKey, questionId, oldValue, newValue) {
            const section = NUTRITION_CONFIG[sectionKey];
            const question = section.questions.find(q => q.id === questionId);

            // Calculate score change
            const oldScore = calculateTotalScore();

            // Generate meaningful description
            let description = generateChangeDescription(question, oldValue, newValue);

            // Temporarily set old value to calculate old score
            const tempValue = currentData.answers[sectionKey][questionId];
            currentData.answers[sectionKey][questionId] = oldValue;
            const oldTotalScore = calculateTotalScore();
            currentData.answers[sectionKey][questionId] = tempValue;

            const scoreChange = (oldScore - oldTotalScore).toFixed(1);
            const scoreChangeText = scoreChange > 0 ? `+${scoreChange}` : scoreChange;

            const change = {
                date: new Date().toISOString(),
                section: sectionKey,
                sectionTitle: section.title,
                description: description,
                scoreChange: scoreChangeText
            };

            currentData.changelog.unshift(change);
            if (currentData.changelog.length > 100) {
                currentData.changelog = currentData.changelog.slice(0, 100);
            }
        }

        function generateChangeDescription(question, oldValue, newValue) {
            const questionText = question.question;

            if (question.type === 'slider') {
                return `${questionText.split(' - ')[0]}: ${oldValue} â†’ ${newValue}`;
            } else if (question.type === 'radio') {
                const newOpt = question.options.find(o => o.value === newValue);
                return `${questionText.split('?')[0]}: ${newOpt ? newOpt.label : newValue}`;
            } else if (question.type === 'checkbox') {
                const oldArr = Array.isArray(oldValue) ? oldValue : [];
                const newArr = Array.isArray(newValue) ? newValue : [];
                const added = newArr.filter(v => !oldArr.includes(v));
                const removed = oldArr.filter(v => !newArr.includes(v));

                // Shorter labels for principles
                const shortLabels = {
                    'vegetables': 'Vegetables 3x daily',
                    'whole_foods': 'Whole foods focus',
                    'healthy_fats': 'Healthy fats',
                    'avoid_harmful': 'Avoid trans fats',
                    'alcohol': 'Alcohol moderation',
                    'restaurant': 'Restaurant',
                    'travel': 'Travel',
                    'Family and friends': 'Family/friends',
                    'stress': 'Stress situations'
                };

                if (added.length > 0) {
                    const addedLabels = added.map(v => shortLabels[v] || v);
                    return `Added: ${addedLabels.join(', ')}`;
                } else if (removed.length > 0) {
                    const removedLabels = removed.map(v => shortLabels[v] || v);
                    return `Removed: ${removedLabels.join(', ')}`;
                }
            } else if (question.type === 'number') {
                return `${questionText}: ${oldValue} â†’ ${newValue}`;
            }

            return `${questionText}: updated`;
        }

        // ========================================
        // UI RENDERING
        // ========================================
        function renderForm() {
            const form = document.getElementById('nutritionForm');
            form.innerHTML = '';

            Object.keys(NUTRITION_CONFIG).forEach(sectionKey => {
                const section = NUTRITION_CONFIG[sectionKey];
                const answers = currentData.answers[sectionKey] || {};
                const sectionScore = calculateSectionScore(sectionKey);

                // Section Header
                const sectionHelpLink = section.helpLink ? `<a href="${section.helpLink}" target="_blank" class="help-link" title="View scientific evidence">?</a>` : '';
                let headerHTML = `<div class="section-header">
                    ${section.title}${sectionHelpLink}
                    ${section.weight > 0 ? `<span class="section-weight">(${section.weight * 100}% weight) - Score: ${sectionScore !== null ? sectionScore.toFixed(1) + '/10' : 'Not scored'}</span>` : ''}
                </div>`;

                // Handle intro section type
                if (section.type === 'intro') {
                    headerHTML += `
                        <div class="intro-section">
                            <p>${section.description}</p>
                            ${section.link ? `<a href="${section.link.url}" target="_blank" class="intro-link">${section.link.text}</a>` : ''}
                        </div>
                    `;
                    form.innerHTML += headerHTML;
                    return; // Skip questions for intro sections
                }

                if (section.description) {
                    headerHTML += `<p style="font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: 16px;">${section.description}</p>`;
                }

                form.innerHTML += headerHTML;

                // Questions
                section.questions.forEach(q => {
                    const value = answers[q.id];
                    const helpLinkHTML = q.helpLink ? `<a href="${q.helpLink}" target="_blank" class="help-link" title="View scientific evidence">?</a>` : '';
                    let questionHTML = `
                        <div class="question-item" data-section="${sectionKey}" data-question="${q.id}">
                            <div class="question-label">${q.question}${helpLinkHTML}</div>
                    `;

                    if (q.hint) {
                        questionHTML += `<div class="question-hint">${q.hint}</div>`;
                    }

                    if (q.type === 'slider') {
                        const currentValue = value !== undefined ? value : q.min;
                        questionHTML += `
                            <div class="slider-container">
                                <input type="range" class="slider-input"
                                    min="${q.min}" max="${q.max}" value="${currentValue}"
                                    data-section="${sectionKey}" data-question="${q.id}"
                                    oninput="updateSliderDisplay(this)">
                                <div class="slider-value" id="value-${sectionKey}-${q.id}">${currentValue}</div>
                            </div>
                        `;
                        if (!q.hideLabels && q.labels) {
                            questionHTML += `
                                <div class="slider-labels">
                                    <span>${q.labels[q.min] || q.min}</span>
                                    <span>${q.labels[q.max] || q.max}</span>
                                </div>
                            `;
                        }
                    } else if (q.type === 'radio') {
                        questionHTML += `<div class="radio-group" data-section="${sectionKey}" data-question="${q.id}">`;
                        q.options.forEach(opt => {
                            const isSelected = value === opt.value;
                            const hasPoints = opt.points !== undefined;
                            questionHTML += `
                                <div class="radio-option ${isSelected ? 'selected' : ''}"
                                    onclick="selectRadio('${sectionKey}', '${q.id}', '${opt.value}', this)">
                                    <input type="radio" name="${sectionKey}-${q.id}" value="${opt.value}" ${isSelected ? 'checked' : ''}>
                                    <label>${opt.label}</label>
                                    ${hasPoints ? `<span class="radio-points">${opt.points} pts</span>` : ''}
                                </div>
                            `;
                        });
                        questionHTML += `</div>`;
                    } else if (q.type === 'checkbox') {
                        questionHTML += `<div class="checkbox-group" data-section="${sectionKey}" data-question="${q.id}">`;
                        q.options.forEach(opt => {
                            const isSelected = Array.isArray(value) && value.includes(opt.value);
                            const evidenceTag = opt.evidence ? `<span class="evidence-tag">${opt.evidence}</span>` : '';
                            questionHTML += `
                                <div class="checkbox-option ${isSelected ? 'selected' : ''}"
                                    onclick="toggleCheckbox('${sectionKey}', '${q.id}', '${opt.value}', this)">
                                    <input type="checkbox" value="${opt.value}" ${isSelected ? 'checked' : ''}>
                                    <label>${opt.label}</label>
                                    ${evidenceTag}
                                </div>
                            `;
                        });
                        questionHTML += `</div>`;
                    } else if (q.type === 'number') {
                        questionHTML += `
                            <div class="number-input">
                                <input type="number" value="${value || ''}" min="${q.min}" max="${q.max}"
                                    data-section="${sectionKey}" data-question="${q.id}">
                                <span>${q.unit}</span>
                            </div>
                        `;
                    }

                    questionHTML += `</div>`;
                    form.innerHTML += questionHTML;
                });
            });
        }

        function renderChangelog() {
            const changelogList = document.getElementById('changelogList');

            if (!currentData.changelog || currentData.changelog.length === 0) {
                changelogList.innerHTML = `
                    <p style="color: var(--color-text-muted); text-align: center; padding: 24px;">
                        No changes logged yet.
                    </p>
                `;
                return;
            }

            let html = '';
            currentData.changelog.forEach(change => {
                const date = new Date(change.date);
                const dateStr = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit'
                }) + ', ' + date.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });

                // Handle both old and new changelog formats
                const description = change.description || `${change.questionId}: ${change.oldValue} â†’ ${change.newValue}`;
                const scoreText = change.scoreChange ? ` Score: ${change.scoreChange}` : '';

                html += `
                    <div class="changelog-item">
                        <div class="changelog-date">${dateStr}</div>
                        <div class="changelog-details">
                            <div class="changelog-category">${change.sectionTitle}</div>
                            <div class="changelog-change">
                                ${description}${scoreText}
                            </div>
                        </div>
                    </div>
                `;
            });

            changelogList.innerHTML = html;
        }

        function updateScoreDisplay() {
            const totalScore = calculateTotalScore();
            const percentage = Math.round(totalScore * 10);

            document.getElementById('percentage').textContent = `${percentage}%`;
            document.getElementById('totalPoints').textContent = `${totalScore.toFixed(1)}/10 Points`;
            document.getElementById('userName').textContent = currentData.userName;
            document.getElementById('testDate').textContent = new Date().toLocaleDateString('en-US');
        }

        // ========================================
        // EVENT HANDLERS
        // ========================================
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }

        function updateSliderDisplay(slider) {
            const value = slider.value;
            const section = slider.dataset.section;
            const questionId = slider.dataset.question;
            document.getElementById(`value-${section}-${questionId}`).textContent = value;

            // Update score in real-time
            currentData.answers[section][questionId] = value;
            updateScoreDisplay();
            updateSectionScoreDisplay(section);
        }

        function selectRadio(section, questionId, value, element) {
            const group = element.parentElement;
            group.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            element.querySelector('input').checked = true;

            // Update score in real-time
            currentData.answers[section][questionId] = value;
            updateScoreDisplay();
            updateSectionScoreDisplay(section);
        }

        function toggleCheckbox(section, questionId, value, element) {
            const checkbox = element.querySelector('input');
            const newState = !checkbox.checked;
            checkbox.checked = newState;
            element.classList.toggle('selected', newState);

            // Update score in real-time
            if (!Array.isArray(currentData.answers[section][questionId])) {
                currentData.answers[section][questionId] = [];
            }
            if (newState) {
                currentData.answers[section][questionId].push(value);
            } else {
                currentData.answers[section][questionId] = currentData.answers[section][questionId].filter(v => v !== value);
            }
            updateScoreDisplay();
            updateSectionScoreDisplay(section);
        }

        function updateSectionScoreDisplay(sectionKey) {
            const section = NUTRITION_CONFIG[sectionKey];
            if (section.weight === 0) return; // Goals section not scored

            const sectionScore = calculateSectionScore(sectionKey);
            const headers = document.querySelectorAll('.section-header');

            headers.forEach(header => {
                if (header.textContent.includes(section.title)) {
                    const weightSpan = header.querySelector('.section-weight');
                    if (weightSpan) {
                        weightSpan.textContent = `(${section.weight * 100}% weight) - Score: ${sectionScore.toFixed(1)}/10`;
                    }
                }
            });
        }

        function saveAllChanges() {
            // Compare against last saved state (not current state which updates in real-time)
            Object.keys(NUTRITION_CONFIG).forEach(sectionKey => {
                const section = NUTRITION_CONFIG[sectionKey];

                section.questions.forEach(q => {
                    const newValue = currentData.answers[sectionKey][q.id];
                    const oldValue = lastSavedAnswers[sectionKey]?.[q.id];

                    // Check if value changed since last save
                    const oldStr = Array.isArray(oldValue) ? [...oldValue].sort().join(',') : String(oldValue);
                    const newStr = Array.isArray(newValue) ? [...newValue].sort().join(',') : String(newValue);

                    if (oldStr !== newStr) {
                        logChange(sectionKey, q.id, oldValue, newValue);
                    }
                });
            });

            // Update last saved state
            lastSavedAnswers = JSON.parse(JSON.stringify(currentData.answers));

            saveData();
            updateScoreDisplay();
            renderChangelog();

            // Visual feedback
            const btn = document.querySelector('.save-btn');
            btn.classList.add('saved');
            btn.innerHTML = 'âœ… Saved!';
            setTimeout(() => {
                btn.classList.remove('saved');
                btn.innerHTML = 'ðŸ’¾ Save All Changes';
            }, 2000);
        }

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            renderForm();
            updateScoreDisplay();
            renderChangelog();

            // Add real-time updates for number inputs
            document.querySelectorAll('.number-input input').forEach(input => {
                input.addEventListener('input', function() {
                    const section = this.dataset.section;
                    const questionId = this.dataset.question;
                    currentData.answers[section][questionId] = this.value;
                    updateScoreDisplay();
                    updateSectionScoreDisplay(section);
                });
            });
        });
    </script>
</body>
</html>
