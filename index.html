<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>LongevityPath - Your Longevity Lifestyle Score</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --color-orange: #E9A04E;
            --color-orange-light: #FDF6EC;
            --color-teal: #00905A;
            --color-teal-light: #E8F5F0;
            --color-red: #EF4444;
            --color-red-light: #FEE2E2;
            --color-bg: #FAF9F6;
            --color-card: #FFFFFF;
            --color-text: #1F2937;
            --color-text-muted: #6B7280;
            --color-border: #E5E7EB;
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-family);
            background: var(--color-bg);
            color: var(--color-text);
            min-height: 100vh;
            padding-bottom: 80px;
        }

        /* Tab Content */
        .tab-content { display: none; padding: 20px 16px; max-width: 500px; margin: 0 auto; }
        .tab-content.active { display: block; }

        /* Score Header */
        .score-header { text-align: center; padding: 24px 0 32px; }
        .greeting { color: var(--color-text-muted); font-size: 0.95rem; margin-bottom: 20px; }

        .score-ring-container { position: relative; width: 180px; height: 180px; margin: 0 auto 16px; }
        .score-ring { transform: rotate(-90deg); }
        .score-ring-bg { fill: none; stroke: var(--color-border); stroke-width: 12; }
        .score-ring-progress { fill: none; stroke: var(--color-teal); stroke-width: 12; stroke-linecap: round; transition: stroke-dashoffset 1s ease-out; }
        .score-value { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; }
        .score-number { font-size: 3rem; font-weight: 700; color: var(--color-text); line-height: 1; }
        .score-max { font-size: 1.1rem; color: var(--color-text-muted); }
        .score-title { font-size: 1.1rem; font-weight: 600; color: var(--color-text); margin-bottom: 4px; }
        .score-date { font-size: 0.85rem; color: var(--color-text-muted); }

        /* Section Title */
        .section-title { font-size: 1rem; font-weight: 600; color: var(--color-text); margin-bottom: 12px; }

        /* CTA Card for new users */
        .cta-card { background: linear-gradient(135deg, var(--color-orange) 0%, #D4902F 100%); border-radius: 16px; padding: 24px; margin-bottom: 24px; color: white; text-align: center; }
        .cta-icon { width: 48px; height: 48px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; }
        .cta-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 8px; }
        .cta-text { font-size: 0.9rem; opacity: 0.95; margin-bottom: 20px; line-height: 1.5; }
        .cta-button { display: inline-flex; align-items: center; gap: 8px; background: white; color: var(--color-orange); padding: 14px 28px; border-radius: 12px; font-weight: 600; font-size: 0.95rem; border: none; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .cta-button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        /* Dimension Cards */
        .dimension-card {
            background: var(--color-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .dimension-card:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .dimension-card:active { transform: scale(0.98); }

        .dimension-icon {
            width: 44px; height: 44px; border-radius: 10px;
            background: var(--color-teal-light);
            display: flex; align-items: center; justify-content: center;
            color: var(--color-teal); flex-shrink: 0;
        }
        .dimension-info { flex: 1; }
        .dimension-name { font-weight: 500; font-size: 0.95rem; color: var(--color-text); }
        .dimension-score { display: flex; align-items: center; gap: 8px; }
        .dimension-score-value { font-weight: 600; font-size: 0.95rem; color: var(--color-text); }
        .dimension-score-max { color: var(--color-text-muted); font-size: 0.85rem; }
        .dimension-trend { display: flex; align-items: center; gap: 2px; font-size: 0.8rem; font-weight: 500; }
        .trend-up { color: var(--color-teal); }
        .trend-down { color: var(--color-red); }
        .trend-neutral { color: var(--color-text-muted); }

        /* Habits Tab */
        .habits-stats {
            display: flex; justify-content: space-around;
            background: var(--color-card); border-radius: 12px;
            padding: 20px; margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .stat-item { text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--color-text); }
        .stat-label { font-size: 0.75rem; color: var(--color-text-muted); margin-top: 2px; }

        .habit-card {
            background: var(--color-card); border-radius: 12px;
            padding: 14px 16px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .habit-checkbox {
            width: 24px; height: 24px;
            border: 2px solid var(--color-border); border-radius: 6px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s; flex-shrink: 0;
        }
        .habit-checkbox.checked { background: var(--color-teal); border-color: var(--color-teal); color: white; }
        .habit-info { flex: 1; }
        .habit-name { font-weight: 500; font-size: 0.9rem; color: var(--color-text); }
        .habit-meta { font-size: 0.75rem; color: var(--color-text-muted); display: flex; align-items: center; gap: 8px; margin-top: 2px; }
        .habit-streak { display: flex; align-items: center; gap: 4px; color: var(--color-orange); font-weight: 500; }

        .habit-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 14px 20px; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; }
        .btn-outline { background: transparent; border: 2px solid var(--color-orange); color: var(--color-orange); }
        .btn-outline:hover { background: var(--color-orange-light); }
        .btn-primary { background: var(--color-orange); border: 2px solid var(--color-orange); color: white; }
        .btn-primary:hover { background: #D4902F; border-color: #D4902F; }

        /* Community Tab */
        .coach-card { background: var(--color-card); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .coach-label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--color-text-muted); margin-bottom: 12px; }
        .coach-info { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .coach-avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--color-teal); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1rem; }
        .coach-name { font-weight: 600; font-size: 1rem; color: var(--color-text); }
        .coach-title { font-size: 0.85rem; color: var(--color-text-muted); }
        .coach-datetime { display: flex; align-items: center; gap: 16px; font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: 16px; }
        .coach-datetime span { display: flex; align-items: center; gap: 6px; }
        .btn-full { width: 100%; padding: 14px; border-radius: 10px; font-size: 0.95rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; background: var(--color-orange); border: none; color: white; margin-bottom: 12px; }
        .btn-full:hover { background: #D4902F; }
        .coach-actions { display: flex; gap: 10px; }
        .btn-secondary { flex: 1; padding: 10px; border-radius: 8px; font-size: 0.85rem; font-weight: 500; cursor: pointer; background: transparent; border: 1px solid var(--color-border); color: var(--color-text); }
        .btn-secondary:hover { background: var(--color-bg); }

        .qa-card { background: var(--color-card); border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .qa-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .qa-avatar { width: 32px; height: 32px; border-radius: 50%; background: var(--color-border); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 600; color: var(--color-text-muted); }
        .qa-user { font-weight: 500; font-size: 0.85rem; }
        .qa-time { font-size: 0.75rem; color: var(--color-text-muted); }
        .qa-question { font-size: 0.9rem; line-height: 1.5; color: var(--color-text); margin-bottom: 12px; }
        .qa-tags { display: flex; gap: 6px; margin-bottom: 12px; }
        .qa-tag { padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 500; }
        .tag-nutrition { background: var(--color-teal-light); color: var(--color-teal); }
        .tag-fasting { background: var(--color-orange-light); color: var(--color-orange); }
        .tag-sleep { background: #EDE9FE; color: #7C3AED; }
        .tag-exercise { background: #DBEAFE; color: #2563EB; }
        .qa-footer { display: flex; align-items: center; gap: 16px; font-size: 0.8rem; color: var(--color-text-muted); }
        .qa-footer span { display: flex; align-items: center; gap: 4px; }

        /* Bottom Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--color-card); border-top: 1px solid var(--color-border); display: flex; justify-content: space-around; padding: 8px 0 20px; z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px 20px; cursor: pointer; color: var(--color-text-muted); transition: color 0.2s; background: none; border: none; font-family: inherit; }
        .nav-item.active { color: var(--color-orange); }
        .nav-item:hover { color: var(--color-orange); }
        .nav-label { font-size: 0.7rem; font-weight: 500; }

        /* Detail View */
        .detail-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--color-bg); z-index: 2000; transform: translateX(100%); transition: transform 0.3s ease-out; overflow-y: auto; }
        .detail-view.active { transform: translateX(0); }
        .detail-header { position: sticky; top: 0; background: var(--color-card); padding: 16px 20px; display: flex; align-items: center; gap: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); z-index: 10; }
        .back-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--color-bg); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--color-text); }
        .detail-title { font-weight: 600; font-size: 1.1rem; }
        .detail-content { padding: 20px; }
        .swipe-hint { position: fixed; left: 0; top: 0; width: 4px; height: 100%; background: linear-gradient(to right, var(--color-teal), transparent); opacity: 0.5; z-index: 2001; pointer-events: none; }

        /* Assessment Styles */
        .assessment-section { margin-bottom: 24px; }
        .section-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        .step-number { display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; background: var(--color-orange); color: white; border-radius: 50%; font-size: 0.85rem; font-weight: 600; flex-shrink: 0; }
        .section-title-text { font-weight: 600; font-size: 1rem; color: var(--color-text); }
        .section-score { font-size: 0.8rem; color: var(--color-text-muted); margin-left: auto; }
        .help-link { display: inline-flex; align-items: center; justify-content: center; width: 20px; height: 20px; background: var(--color-teal); color: white; border-radius: 50%; font-size: 0.65rem; font-weight: 600; text-decoration: none; margin-left: 6px; }

        .question-item { padding: 16px; background: var(--color-card); border-radius: 12px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .question-label { font-size: 0.95rem; color: var(--color-text); margin-bottom: 12px; font-weight: 500; }
        .question-hint { font-size: 0.85rem; color: var(--color-text-muted); margin-bottom: 12px; font-style: italic; }

        .slider-container { display: flex; align-items: center; gap: 16px; }
        .slider-input { flex: 1; -webkit-appearance: none; appearance: none; height: 8px; background: var(--color-border); border-radius: 4px; outline: none; cursor: pointer; }
        .slider-input::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 28px; height: 28px; background: var(--color-orange); border-radius: 50%; cursor: pointer; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .slider-value { min-width: 36px; padding: 6px 10px; background: var(--color-bg); color: var(--color-text); border: 2px solid var(--color-border); border-radius: 6px; text-align: center; font-weight: 600; font-size: 1rem; }

        .radio-group, .checkbox-group { display: flex; flex-direction: column; gap: 8px; }
        .radio-option, .checkbox-option { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: white; border: 2px solid var(--color-border); border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .radio-option:hover, .checkbox-option:hover { border-color: var(--color-orange); background: var(--color-orange-light); }
        .radio-option.selected, .checkbox-option.selected { border-color: var(--color-orange); background: var(--color-orange-light); }
        .radio-option input, .checkbox-option input { width: 20px; height: 20px; accent-color: var(--color-orange); cursor: pointer; flex-shrink: 0; pointer-events: none; }
        .radio-option label, .checkbox-option label { flex: 1; cursor: pointer; font-size: 0.9rem; }
        .radio-points { font-size: 0.75rem; color: var(--color-text-muted); }
        .evidence-tag { font-size: 0.7rem; color: var(--color-teal); background: var(--color-teal-light); padding: 2px 8px; border-radius: 10px; }

        .intro-section { padding: 16px; background: var(--color-orange-light); border-radius: 12px; border-left: 4px solid var(--color-orange); margin-bottom: 16px; }
        .intro-section p { font-size: 0.9rem; color: var(--color-text); margin-bottom: 12px; line-height: 1.6; }
        .intro-link { display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: var(--color-orange); color: white; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 0.9rem; }
        .intro-link:hover { background: #D4902F; }

        /* Section Breakdown Card */
        .section-breakdown { background: var(--color-card); border-radius: 12px; padding: 16px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .section-breakdown-title { font-size: 0.85rem; font-weight: 600; color: var(--color-text-muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        .section-breakdown-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--color-border); }
        .section-breakdown-item:last-child { border-bottom: none; }
        .section-breakdown-number { width: 24px; height: 24px; background: var(--color-orange); color: white; border-radius: 50%; font-size: 0.75rem; font-weight: 600; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .section-breakdown-info { flex: 1; min-width: 0; }
        .section-breakdown-name { font-size: 0.9rem; font-weight: 500; color: var(--color-text); margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
        .section-breakdown-bar { height: 6px; background: var(--color-border); border-radius: 3px; overflow: hidden; }
        .section-breakdown-fill { height: 100%; border-radius: 3px; transition: width 0.3s ease; background: var(--color-text-muted); }
        .section-breakdown-score { font-size: 0.85rem; font-weight: 600; color: var(--color-text); min-width: 60px; text-align: right; }
        .room-to-grow { font-size: 0.7rem; font-weight: 500; color: var(--color-red); background: var(--color-red-light); padding: 2px 8px; border-radius: 10px; }
        .not-started { font-size: 0.7rem; font-weight: 500; color: var(--color-text-muted); background: var(--color-border); padding: 2px 8px; border-radius: 10px; }

        /* Sub-score rows (Cardiovascular / Metabolic) */
        .subscore-group { padding-left: 36px; }
        .subscore-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; }
        .subscore-item:not(:last-child) { border-bottom: 1px solid color-mix(in srgb, var(--color-border) 50%, transparent); }
        .subscore-icon { width: 20px; height: 20px; flex-shrink: 0; color: var(--color-teal); }
        .subscore-info { flex: 1; min-width: 0; }
        .subscore-name { font-size: 0.82rem; font-weight: 500; color: var(--color-text); margin-bottom: 3px; display: flex; align-items: center; gap: 6px; }
        .subscore-name .help-link { display: inline-flex; align-items: center; justify-content: center; width: 18px; height: 18px; background: var(--color-teal); color: white; border-radius: 50%; font-size: 0.6rem; font-weight: 700; text-decoration: none; flex-shrink: 0; }
        .subscore-bar { height: 5px; background: var(--color-border); border-radius: 3px; overflow: hidden; }
        .subscore-fill { height: 100%; border-radius: 3px; transition: width 0.3s ease; }
        .subscore-fill.cardio { background: #e57373; }
        .subscore-fill.metabolic { background: #64b5f6; }
        .subscore-score { font-size: 0.8rem; font-weight: 600; color: var(--color-text); min-width: 42px; text-align: right; }

        /* Detail CTA for empty assessments */
        .detail-cta { background: var(--color-orange-light); border-radius: 12px; padding: 20px; margin-bottom: 20px; border-left: 4px solid var(--color-orange); }
        .detail-cta-title { font-size: 1rem; font-weight: 600; color: var(--color-orange); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .detail-cta-text { font-size: 0.9rem; color: var(--color-text); line-height: 1.5; }

        /* Updated Section Header with weighted scores */
        .section-score-weighted { font-size: 0.85rem; color: var(--color-text); font-weight: 600; margin-left: auto; display: flex; align-items: center; gap: 6px; }
        .section-score-weighted .current { color: var(--color-text); }
        .section-score-weighted .max { color: var(--color-text-muted); }
        .section-score-weighted.score-red .current { color: #d32f2f; }
        .section-score-weighted.score-amber .current { color: #f57c00; }
        .section-score-weighted.score-yellow-green .current { color: #7cb342; }
        .section-score-weighted.score-green .current { color: #43a047; }
        .section-score-weighted.not-started .current { color: var(--color-text-muted); }

        /* Number Input */
        .number-input-group { display: flex; align-items: center; gap: 12px; }
        .number-input { flex: 1; padding: 12px 14px; border: 2px solid var(--color-border); border-radius: 10px; font-size: 1rem; font-weight: 600; font-family: var(--font-family); color: var(--color-text); background: white; transition: border-color 0.2s, box-shadow 0.2s; -moz-appearance: textfield; }
        .number-input::-webkit-outer-spin-button, .number-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .number-input:focus { outline: none; border-color: var(--color-orange); box-shadow: 0 0 0 3px rgba(233,160,78,0.15); }
        .number-input::placeholder { font-weight: 400; color: var(--color-text-muted); font-size: 0.9rem; }
        .number-unit { font-size: 0.8rem; color: var(--color-text-muted); min-width: 60px; }
        .norm-rating { padding: 12px 16px; border-radius: 10px; border-left: 4px solid var(--color-teal); background: var(--color-teal-light); margin-top: 12px; }
        .norm-rating-label { font-size: 0.8rem; color: var(--color-text-muted); margin-bottom: 2px; }
        .norm-rating-value { font-size: 1.1rem; font-weight: 700; color: var(--color-teal); }
        .norm-rating.low { border-left-color: var(--color-red); background: var(--color-red-light); }
        .norm-rating.low .norm-rating-value { color: var(--color-red); }
        .norm-rating.medium { border-left-color: var(--color-orange); background: var(--color-orange-light); }
        .norm-rating.medium .norm-rating-value { color: #B45309; }
        .demographics-prompt { padding: 12px 16px; background: var(--color-orange-light); border-radius: 10px; border-left: 4px solid var(--color-orange); margin-top: 12px; font-size: 0.85rem; color: var(--color-text); display: flex; align-items: center; gap: 8px; }
        .age-hidden { display: none; }
        .cooper-calc { background: var(--color-card); border: 2px dashed var(--color-border); border-radius: 12px; padding: 16px; margin-top: 12px; }
        .cooper-calc-title { font-size: 0.85rem; font-weight: 600; color: var(--color-text); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
        .cooper-calc-row { display: flex; align-items: center; gap: 10px; }
        .cooper-calc-btn { padding: 10px 16px; background: var(--color-teal); color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer; white-space: nowrap; font-family: var(--font-family); }
        .cooper-calc-btn:hover { background: #007A4D; }
        .cooper-calc-result { margin-top: 10px; font-size: 0.9rem; color: var(--color-teal); font-weight: 600; display: none; }
        .fitness-age { margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.06); font-size: 0.95rem; }
        .fitness-age strong { font-size: 1.3rem; font-weight: 700; }
        .fitness-age.positive { color: var(--color-teal); }
        .fitness-age.negative { color: var(--color-red); }
        .fitness-age.neutral { color: var(--color-text-muted); }
    </style>
</head>
<body>

    <!-- TAB 1: MY SCORE -->
    <div class="tab-content active" id="tab-score">
        <div class="score-header">
            <p class="greeting">Hello <span id="userName">Alexander</span></p>
            <div class="score-ring-container">
                <svg class="score-ring" width="180" height="180" viewBox="0 0 180 180">
                    <circle class="score-ring-bg" cx="90" cy="90" r="78"/>
                    <circle class="score-ring-progress" id="scoreRingProgress" cx="90" cy="90" r="78" stroke-dasharray="490" stroke-dashoffset="490"/>
                </svg>
                <div class="score-value">
                    <div class="score-number" id="totalScoreValue">0</div>
                    <div class="score-max">/100</div>
                </div>
            </div>
            <div class="score-title">Your Longevity Lifestyle Score</div>
            <div class="score-date">Last updated: <span id="lastUpdated">Feb 6, 2026</span></div>
        </div>
        <div id="ctaCard" class="cta-card">
            <div class="cta-icon"><i data-lucide="sparkles" style="width:24px;height:24px;"></i></div>
            <div class="cta-title">Discover Your Longevity Score</div>
            <div class="cta-text">Just 2 minutes to complete. Get personalized insights into how your lifestyle supports a longer, healthier life.</div>
            <button class="cta-button" onclick="openDimension('nutrition')"><i data-lucide="play" style="width:18px;height:18px;"></i> Start Now</button>
        </div>
        <h2 class="section-title">Health Dimensions</h2>
        <div id="dimensionsList"></div>
    </div>

    <!-- TAB 2: HABITS -->
    <div class="tab-content" id="tab-habits">
        <h2 class="section-title" style="margin-bottom: 16px;">My Habits</h2>
        <div class="habits-stats">
            <div class="stat-item"><div class="stat-value">12</div><div class="stat-label">Active</div></div>
            <div class="stat-item"><div class="stat-value">87%</div><div class="stat-label">This Week</div></div>
            <div class="stat-item"><div class="stat-value">45</div><div class="stat-label">Day Streak</div></div>
        </div>
        <h3 class="section-title">Today's Check-in</h3>
        <div id="habitsList">
            <div class="habit-card">
                <div class="habit-checkbox" onclick="toggleHabit(this)"><i data-lucide="check" style="width:16px;height:16px;display:none;"></i></div>
                <div class="habit-info"><div class="habit-name">Morning walk (20 min)</div><div class="habit-meta"><span class="habit-streak"><i data-lucide="flame" style="width:12px;height:12px;"></i> 55 days</span><span>• Improves Energy</span></div></div>
            </div>
            <div class="habit-card">
                <div class="habit-checkbox" onclick="toggleHabit(this)"><i data-lucide="check" style="width:16px;height:16px;display:none;"></i></div>
                <div class="habit-info"><div class="habit-name">Meditation (10 min)</div><div class="habit-meta"><span class="habit-streak"><i data-lucide="flame" style="width:12px;height:12px;"></i> 12 days</span><span>• Improves Mindset</span></div></div>
            </div>
            <div class="habit-card">
                <div class="habit-checkbox checked" onclick="toggleHabit(this)"><i data-lucide="check" style="width:16px;height:16px;"></i></div>
                <div class="habit-info"><div class="habit-name">Protein intake (30g breakfast)</div><div class="habit-meta"><span class="habit-streak"><i data-lucide="flame" style="width:12px;height:12px;"></i> 24 days</span><span>• Improves Nutrition</span></div></div>
            </div>
            <div class="habit-card">
                <div class="habit-checkbox" onclick="toggleHabit(this)"><i data-lucide="check" style="width:16px;height:16px;display:none;"></i></div>
                <div class="habit-info"><div class="habit-name">Hydration (2L water)</div><div class="habit-meta"><span class="habit-streak"><i data-lucide="flame" style="width:12px;height:12px;"></i> 89 days</span><span>• Improves Energy</span></div></div>
            </div>
        </div>
        <div class="habit-buttons">
            <button class="btn btn-outline"><i data-lucide="plus" style="width:18px;height:18px;"></i> Add Habit</button>
            <button class="btn btn-primary"><i data-lucide="sparkles" style="width:18px;height:18px;"></i> AI Suggest</button>
        </div>
    </div>

    <!-- TAB 3: COMMUNITY -->
    <div class="tab-content" id="tab-community">
        <div class="coach-card">
            <div class="coach-label">Next Session</div>
            <div class="coach-info">
                <div class="coach-avatar">SC</div>
                <div><div class="coach-name">Dr. Sarah Chen</div><div class="coach-title">Longevity Coach</div></div>
            </div>
            <div class="coach-datetime">
                <span><i data-lucide="calendar" style="width:14px;height:14px;"></i> Feb 8, 2026</span>
                <span><i data-lucide="clock" style="width:14px;height:14px;"></i> 3:00 PM</span>
            </div>
            <button class="btn-full"><i data-lucide="video" style="width:18px;height:18px;"></i> Join Video Call</button>
            <div class="coach-actions">
                <button class="btn-secondary">Book Session</button>
                <button class="btn-secondary">Past Sessions</button>
            </div>
        </div>
        <h2 class="section-title">Community Q&A</h2>
        <div class="qa-card">
            <div class="qa-header"><div class="qa-avatar">ER</div><span class="qa-user">Emily R.</span><span class="qa-time">2h ago</span></div>
            <p class="qa-question">Has anyone tried time-restricted eating (16:8 fasting)? I'm curious about the longevity benefits and how it affected your energy levels.</p>
            <div class="qa-tags"><span class="qa-tag tag-nutrition">Nutrition</span><span class="qa-tag tag-fasting">Fasting</span></div>
            <div class="qa-footer"><span><i data-lucide="arrow-up" style="width:14px;height:14px;"></i> 24</span><span><i data-lucide="message-circle" style="width:14px;height:14px;"></i> 8 answers</span></div>
        </div>
        <div class="qa-card">
            <div class="qa-header"><div class="qa-avatar">MT</div><span class="qa-user">Marcus T.</span><span class="qa-time">5h ago</span></div>
            <p class="qa-question">What's the optimal zone 2 cardio duration for someone over 40? My coach suggested 150 min/week but I'm seeing conflicting research.</p>
            <div class="qa-tags"><span class="qa-tag tag-exercise">Exercise</span></div>
            <div class="qa-footer"><span><i data-lucide="arrow-up" style="width:14px;height:14px;"></i> 18</span><span><i data-lucide="message-circle" style="width:14px;height:14px;"></i> 12 answers</span></div>
        </div>
        <div class="qa-card">
            <div class="qa-header"><div class="qa-avatar">JL</div><span class="qa-user">Jessica L.</span><span class="qa-time">1d ago</span></div>
            <p class="qa-question">Best supplements for improving sleep quality? I've been tracking my deep sleep and it's consistently low despite good sleep hygiene.</p>
            <div class="qa-tags"><span class="qa-tag tag-sleep">Sleep</span></div>
            <div class="qa-footer"><span><i data-lucide="arrow-up" style="width:14px;height:14px;"></i> 31</span><span><i data-lucide="message-circle" style="width:14px;height:14px;"></i> 15 answers</span></div>
        </div>
    </div>

    <!-- BOTTOM NAVIGATION -->
    <nav class="bottom-nav">
        <button class="nav-item active" onclick="showTab('score', this)"><i data-lucide="home" style="width:22px;height:22px;"></i><span class="nav-label">My Score</span></button>
        <button class="nav-item" onclick="showTab('habits', this)"><i data-lucide="check-circle" style="width:22px;height:22px;"></i><span class="nav-label">Habits</span></button>
        <button class="nav-item" onclick="showTab('community', this)"><i data-lucide="users" style="width:22px;height:22px;"></i><span class="nav-label">Community</span></button>
    </nav>

    <!-- DETAIL VIEW -->
    <div class="detail-view" id="detailView">
        <div class="swipe-hint"></div>
        <div class="detail-header">
            <button class="back-btn" onclick="closeDetailView()"><i data-lucide="arrow-left" style="width:20px;height:20px;"></i></button>
            <div class="detail-title" id="detailTitle">Dimension</div>
        </div>
        <div class="detail-content" id="detailContent"></div>
    </div>

    <script>
        // ========================================
        // DEMOGRAPHICS HELPER
        // ========================================
        function getDemographics() {
            const yob = currentData.answers?.medical?.sec1?.MD1_yob;
            const age = yob ? new Date().getFullYear() - parseInt(yob) : null;
            const sex = currentData.answers?.medical?.sec1?.MD1_sex;
            const country = currentData.answers?.medical?.sec1?.MD1_country;
            const smoking = currentData.answers?.medical?.sec1?.MD1_smoking;
            return { age, yob: yob ? parseInt(yob) : null, sex: sex || null, country: country || null, smoking: smoking || null };
        }

        function getAgeBracket(age, brackets) {
            for (const bracket of brackets) {
                if (bracket.endsWith('+')) {
                    if (age >= parseInt(bracket)) return bracket;
                } else {
                    const [minStr, maxStr] = bracket.split('-');
                    if (age >= parseInt(minStr) && age <= parseInt(maxStr)) return bracket;
                }
            }
            // Fallback: use last bracket for very old ages
            return brackets[brackets.length - 1];
        }

        function lookupNormScore(normTable, sex, age, value) {
            if (!sex || age === null || value === null || value === undefined || isNaN(value)) {
                return { score: 0, category: 'Incomplete', ratingClass: '' };
            }
            const genderTable = normTable[sex];
            if (!genderTable) return { score: 0, category: 'Invalid', ratingClass: '' };
            const brackets = Object.keys(genderTable);
            const bracket = getAgeBracket(age, brackets);
            if (!bracket || !genderTable[bracket]) return { score: 0, category: 'Outside range', ratingClass: '' };
            const ranges = genderTable[bracket];

            // Find which category the value falls into
            let catIdx = -1;
            for (let i = 0; i < ranges.length; i++) {
                if (value >= ranges[i].min && value <= ranges[i].max) { catIdx = i; break; }
            }
            if (catIdx === -1) return { score: 0, category: 'Below minimum', ratingClass: 'low' };

            const r = ranges[catIdx];
            // Build boundary scores for interpolation
            // Entry boundary = avg of this category's points and previous category's points
            // Exit boundary = avg of this category's points and next category's points
            const prevPts = catIdx > 0 ? ranges[catIdx - 1].points : 0;
            const nextPts = catIdx < ranges.length - 1 ? ranges[catIdx + 1].points : r.points;
            const entryScore = (prevPts + r.points) / 2;
            const exitScore = (r.points + nextPts) / 2;

            // Interpolate within the category range
            let score;
            if (r.max >= 999) {
                // Top category: linear from entryScore toward points, cap at 10
                const spread = 10; // points above threshold to reach max
                score = Math.min(10, entryScore + (value - r.min) / spread * (r.points - entryScore));
            } else {
                const range = r.max - r.min;
                const fraction = range > 0 ? (value - r.min) / range : 0.5;
                score = entryScore + fraction * (exitScore - entryScore);
            }

            const cls = score <= 1.0 ? 'low' : score <= 5.0 ? 'medium' : '';
            return { score: score, category: r.category, ratingClass: cls };
        }

        // ========================================
        // FITNESS AGE CALCULATION
        // ========================================
        function calculateFitnessAge(normTable, sex, value) {
            if (!sex || value === null || value === undefined || isNaN(value)) return null;
            const genderTable = normTable[sex];
            if (!genderTable) return null;
            const pts = [];
            for (const bracket of Object.keys(genderTable)) {
                let ageMid;
                if (bracket.endsWith('+')) { ageMid = parseInt(bracket) + 5; }
                else { const p = bracket.split('-'); ageMid = (parseInt(p[0]) + parseInt(p[1])) / 2; }
                const avg = genderTable[bracket].find(r => r.category === 'Fair' || r.category === 'Average');
                if (!avg) continue;
                pts.push({ age: ageMid, avg: (avg.min + avg.max) / 2 });
            }
            if (pts.length < 2) return null;
            pts.sort((a, b) => a.age - b.age);
            // Higher value → younger fitness age (averages decline with age)
            if (value >= pts[0].avg) {
                const s = (pts[1].age - pts[0].age) / (pts[0].avg - pts[1].avg);
                return Math.max(18, Math.round(pts[0].age - (value - pts[0].avg) * s));
            }
            const last = pts[pts.length - 1], prev = pts[pts.length - 2];
            if (value <= last.avg) {
                const s = (last.age - prev.age) / (prev.avg - last.avg);
                return Math.min(100, Math.round(last.age + (last.avg - value) * s));
            }
            for (let i = 0; i < pts.length - 1; i++) {
                if (value <= pts[i].avg && value >= pts[i + 1].avg) {
                    const ratio = (pts[i].avg - value) / (pts[i].avg - pts[i + 1].avg);
                    return Math.round(pts[i].age + ratio * (pts[i + 1].age - pts[i].age));
                }
            }
            return null;
        }

        function buildNormRatingHTML(q, table, demo, value) {
            const result = lookupNormScore(table, demo.sex, demo.age, parseFloat(value));
            let ageHTML = '';
            if (q.fitnessAgeLabel && demo.age !== null) {
                const fa = calculateFitnessAge(table, demo.sex, parseFloat(value));
                if (fa !== null) {
                    const diff = demo.age - fa;
                    const label = q.fitnessAgeLabel;
                    if (diff > 2) ageHTML = '<div class="fitness-age positive">' + label + ': <strong>' + fa + '</strong> (' + diff + ' years younger)</div>';
                    else if (diff < -2) ageHTML = '<div class="fitness-age negative">' + label + ': <strong>' + fa + '</strong> (' + Math.abs(diff) + ' years older — trainable at any age)</div>';
                    else ageHTML = '<div class="fitness-age neutral">' + label + ': <strong>' + fa + '</strong> (matches your age)</div>';
                }
            }

            return '<div class="norm-rating ' + result.ratingClass + '">' +
                '<div class="norm-rating-label">Your rating (' + demo.sex + ', age ' + demo.age + ')</div>' +
                '<div class="norm-rating-value">' + result.category + ' — ' + Math.round(result.score * 10) + '%</div>' +
                ageHTML + '</div>';
        }

        /**
         * Build a dynamic coaching line for norm-table questions.
         * Only shows when there's a previous answer to compare against.
         * References the actual score delta, category, and a concrete nudge.
         */
        // ========================================
        // COOPER INSTITUTE VO2MAX NORMS
        // ========================================
        const VO2MAX_NORMS = {
            male: {
                '20-29': [{min:0,max:38.2,points:0,category:'Very Poor'},{min:38.3,max:41.9,points:1,category:'Poor'},{min:42.0,max:45.5,points:5,category:'Fair'},{min:45.6,max:51.0,points:7,category:'Good'},{min:51.1,max:55.9,points:9,category:'Excellent'},{min:56.0,max:999,points:10,category:'Superior'}],
                '30-39': [{min:0,max:34.4,points:0,category:'Very Poor'},{min:34.5,max:38.3,points:1,category:'Poor'},{min:38.4,max:42.3,points:5,category:'Fair'},{min:42.4,max:47.3,points:7,category:'Good'},{min:47.4,max:52.4,points:9,category:'Excellent'},{min:52.5,max:999,points:10,category:'Superior'}],
                '40-49': [{min:0,max:30.7,points:0,category:'Very Poor'},{min:30.8,max:34.5,points:1,category:'Poor'},{min:34.6,max:38.3,points:5,category:'Fair'},{min:38.4,max:44.1,points:7,category:'Good'},{min:44.2,max:49.9,points:9,category:'Excellent'},{min:50.0,max:999,points:10,category:'Superior'}],
                '50-59': [{min:0,max:27.0,points:0,category:'Very Poor'},{min:27.1,max:30.8,points:1,category:'Poor'},{min:30.9,max:35.1,points:5,category:'Fair'},{min:35.2,max:40.9,points:7,category:'Good'},{min:41.0,max:45.8,points:9,category:'Excellent'},{min:45.9,max:999,points:10,category:'Superior'}],
                '60-69': [{min:0,max:23.3,points:0,category:'Very Poor'},{min:23.4,max:27.1,points:1,category:'Poor'},{min:27.2,max:31.4,points:5,category:'Fair'},{min:31.5,max:37.2,points:7,category:'Good'},{min:37.3,max:43.0,points:9,category:'Excellent'},{min:43.1,max:999,points:10,category:'Superior'}],
                '70+': [{min:0,max:19.6,points:0,category:'Very Poor'},{min:19.7,max:23.3,points:1,category:'Poor'},{min:23.4,max:27.6,points:5,category:'Fair'},{min:27.7,max:33.4,points:7,category:'Good'},{min:33.5,max:39.2,points:9,category:'Excellent'},{min:39.3,max:999,points:10,category:'Superior'}]
            },
            female: {
                '20-29': [{min:0,max:27.9,points:0,category:'Very Poor'},{min:28.0,max:31.3,points:1,category:'Poor'},{min:31.4,max:35.1,points:5,category:'Fair'},{min:35.2,max:40.9,points:7,category:'Good'},{min:41.0,max:45.8,points:9,category:'Excellent'},{min:45.9,max:999,points:10,category:'Superior'}],
                '30-39': [{min:0,max:26.4,points:0,category:'Very Poor'},{min:26.5,max:29.8,points:1,category:'Poor'},{min:29.9,max:33.7,points:5,category:'Fair'},{min:33.8,max:39.4,points:7,category:'Good'},{min:39.5,max:44.2,points:9,category:'Excellent'},{min:44.3,max:999,points:10,category:'Superior'}],
                '40-49': [{min:0,max:24.3,points:0,category:'Very Poor'},{min:24.4,max:27.6,points:1,category:'Poor'},{min:27.7,max:31.4,points:5,category:'Fair'},{min:31.5,max:37.2,points:7,category:'Good'},{min:37.3,max:42.3,points:9,category:'Excellent'},{min:42.4,max:999,points:10,category:'Superior'}],
                '50-59': [{min:0,max:22.6,points:0,category:'Very Poor'},{min:22.7,max:25.9,points:1,category:'Poor'},{min:26.0,max:29.7,points:5,category:'Fair'},{min:29.8,max:35.6,points:7,category:'Good'},{min:35.7,max:40.9,points:9,category:'Excellent'},{min:41.0,max:999,points:10,category:'Superior'}],
                '60-69': [{min:0,max:20.0,points:0,category:'Very Poor'},{min:20.1,max:23.4,points:1,category:'Poor'},{min:23.5,max:27.2,points:5,category:'Fair'},{min:27.3,max:33.0,points:7,category:'Good'},{min:33.1,max:37.9,points:9,category:'Excellent'},{min:38.0,max:999,points:10,category:'Superior'}],
                '70+': [{min:0,max:17.4,points:0,category:'Very Poor'},{min:17.5,max:20.7,points:1,category:'Poor'},{min:20.8,max:24.4,points:5,category:'Fair'},{min:24.5,max:30.2,points:7,category:'Good'},{min:30.3,max:35.1,points:9,category:'Excellent'},{min:35.2,max:999,points:10,category:'Superior'}]
            }
        };

        // ========================================
        // CSEP PUSH-UP NORMS
        // ========================================
        const PUSHUP_NORMS = {
            male: {
                '20-29': [{min:0,max:16,points:0,category:'Poor'},{min:17,max:22,points:2,category:'Below Average'},{min:23,max:28,points:5,category:'Average'},{min:29,max:38,points:8,category:'Good'},{min:39,max:999,points:10,category:'Excellent'}],
                '30-39': [{min:0,max:15,points:0,category:'Poor'},{min:16,max:21,points:2,category:'Below Average'},{min:22,max:28,points:5,category:'Average'},{min:29,max:35,points:8,category:'Good'},{min:36,max:999,points:10,category:'Excellent'}],
                '40-49': [{min:0,max:11,points:0,category:'Poor'},{min:12,max:16,points:2,category:'Below Average'},{min:17,max:21,points:5,category:'Average'},{min:22,max:29,points:8,category:'Good'},{min:30,max:999,points:10,category:'Excellent'}],
                '50-59': [{min:0,max:9,points:0,category:'Poor'},{min:10,max:12,points:2,category:'Below Average'},{min:13,max:16,points:5,category:'Average'},{min:17,max:24,points:8,category:'Good'},{min:25,max:999,points:10,category:'Excellent'}],
                '60-69': [{min:0,max:6,points:0,category:'Poor'},{min:7,max:9,points:2,category:'Below Average'},{min:10,max:12,points:5,category:'Average'},{min:13,max:20,points:8,category:'Good'},{min:21,max:999,points:10,category:'Excellent'}],
                '70+': [{min:0,max:4,points:0,category:'Poor'},{min:5,max:7,points:2,category:'Below Average'},{min:8,max:10,points:5,category:'Average'},{min:11,max:17,points:8,category:'Good'},{min:18,max:999,points:10,category:'Excellent'}]
            },
            female: {
                '20-29': [{min:0,max:11,points:0,category:'Poor'},{min:12,max:17,points:2,category:'Below Average'},{min:18,max:24,points:5,category:'Average'},{min:25,max:34,points:8,category:'Good'},{min:35,max:999,points:10,category:'Excellent'}],
                '30-39': [{min:0,max:9,points:0,category:'Poor'},{min:10,max:16,points:2,category:'Below Average'},{min:17,max:24,points:5,category:'Average'},{min:25,max:33,points:8,category:'Good'},{min:34,max:999,points:10,category:'Excellent'}],
                '40-49': [{min:0,max:7,points:0,category:'Poor'},{min:8,max:13,points:2,category:'Below Average'},{min:14,max:20,points:5,category:'Average'},{min:21,max:28,points:8,category:'Good'},{min:29,max:999,points:10,category:'Excellent'}],
                '50-59': [{min:0,max:5,points:0,category:'Poor'},{min:6,max:10,points:2,category:'Below Average'},{min:11,max:16,points:5,category:'Average'},{min:17,max:24,points:8,category:'Good'},{min:25,max:999,points:10,category:'Excellent'}],
                '60-69': [{min:0,max:4,points:0,category:'Poor'},{min:5,max:9,points:2,category:'Below Average'},{min:10,max:15,points:5,category:'Average'},{min:16,max:22,points:8,category:'Good'},{min:23,max:999,points:10,category:'Excellent'}],
                '70+': [{min:0,max:3,points:0,category:'Poor'},{min:4,max:8,points:2,category:'Below Average'},{min:9,max:14,points:5,category:'Average'},{min:15,max:20,points:8,category:'Good'},{min:21,max:999,points:10,category:'Excellent'}]
            }
        };

        // ========================================
        // CHAIR STAND NORMS (60+ only)
        // ========================================
        const CHAIRSTAND_NORMS = {
            male: {
                '60-64': [{min:0,max:11,points:0,category:'Below Average'},{min:12,max:13,points:2,category:'Average'},{min:14,max:16,points:5,category:'Above Average'},{min:17,max:19,points:8,category:'Good'},{min:20,max:999,points:10,category:'Very Good'}],
                '65-69': [{min:0,max:10,points:0,category:'Below Average'},{min:11,max:12,points:2,category:'Average'},{min:13,max:15,points:5,category:'Above Average'},{min:16,max:18,points:8,category:'Good'},{min:19,max:999,points:10,category:'Very Good'}],
                '70-74': [{min:0,max:9,points:0,category:'Below Average'},{min:10,max:11,points:2,category:'Average'},{min:12,max:14,points:5,category:'Above Average'},{min:15,max:17,points:8,category:'Good'},{min:18,max:999,points:10,category:'Very Good'}],
                '75-79': [{min:0,max:8,points:0,category:'Below Average'},{min:9,max:10,points:2,category:'Average'},{min:11,max:13,points:5,category:'Above Average'},{min:14,max:16,points:8,category:'Good'},{min:17,max:999,points:10,category:'Very Good'}],
                '80-84': [{min:0,max:7,points:0,category:'Below Average'},{min:8,max:9,points:2,category:'Average'},{min:10,max:12,points:5,category:'Above Average'},{min:13,max:15,points:8,category:'Good'},{min:16,max:999,points:10,category:'Very Good'}],
                '85-89': [{min:0,max:6,points:0,category:'Below Average'},{min:7,max:8,points:2,category:'Average'},{min:9,max:11,points:5,category:'Above Average'},{min:12,max:14,points:8,category:'Good'},{min:15,max:999,points:10,category:'Very Good'}],
                '90+': [{min:0,max:5,points:0,category:'Below Average'},{min:6,max:7,points:2,category:'Average'},{min:8,max:10,points:5,category:'Above Average'},{min:11,max:13,points:8,category:'Good'},{min:14,max:999,points:10,category:'Very Good'}]
            },
            female: {
                '60-64': [{min:0,max:10,points:0,category:'Below Average'},{min:11,max:12,points:2,category:'Average'},{min:13,max:15,points:5,category:'Above Average'},{min:16,max:18,points:8,category:'Good'},{min:19,max:999,points:10,category:'Very Good'}],
                '65-69': [{min:0,max:9,points:0,category:'Below Average'},{min:10,max:11,points:2,category:'Average'},{min:12,max:14,points:5,category:'Above Average'},{min:15,max:17,points:8,category:'Good'},{min:18,max:999,points:10,category:'Very Good'}],
                '70-74': [{min:0,max:8,points:0,category:'Below Average'},{min:9,max:10,points:2,category:'Average'},{min:11,max:13,points:5,category:'Above Average'},{min:14,max:16,points:8,category:'Good'},{min:17,max:999,points:10,category:'Very Good'}],
                '75-79': [{min:0,max:7,points:0,category:'Below Average'},{min:8,max:9,points:2,category:'Average'},{min:10,max:12,points:5,category:'Above Average'},{min:13,max:15,points:8,category:'Good'},{min:16,max:999,points:10,category:'Very Good'}],
                '80-84': [{min:0,max:6,points:0,category:'Below Average'},{min:7,max:8,points:2,category:'Average'},{min:9,max:11,points:5,category:'Above Average'},{min:12,max:14,points:8,category:'Good'},{min:15,max:999,points:10,category:'Very Good'}],
                '85-89': [{min:0,max:5,points:0,category:'Below Average'},{min:6,max:7,points:2,category:'Average'},{min:8,max:10,points:5,category:'Above Average'},{min:11,max:13,points:8,category:'Good'},{min:14,max:999,points:10,category:'Very Good'}],
                '90+': [{min:0,max:4,points:0,category:'Below Average'},{min:5,max:6,points:2,category:'Average'},{min:7,max:9,points:5,category:'Above Average'},{min:10,max:12,points:8,category:'Good'},{min:13,max:999,points:10,category:'Very Good'}]
            }
        };

        // ========================================
        // SCREENING GUIDELINES (by country)
        // ========================================
        let SCREENING_GUIDELINES = {
            de: [
                { id: "checkup35", name: "General Health Check-up (Check-up 35)", desc: "Blood pressure, lipids, glucose, kidney function, hepatitis B/C", gender: "all", ageStart: 35, ageEnd: 120, freq: "Every 3 years", source: "GKV / G-BA", helpLink: "medical-evidence.html#q-checkup" },
                { id: "skin", name: "Skin Cancer Screening", desc: "Full-body dermatological exam for melanoma and other skin cancers", gender: "all", ageStart: 35, ageEnd: 120, freq: "Every 2 years", source: "GKV", helpLink: "medical-evidence.html#q-skin" },
                { id: "dental", name: "Dental Check-up", desc: "Oral exam, tartar removal, periodontitis screening", gender: "all", ageStart: 18, ageEnd: 120, freq: "Twice yearly", source: "GKV", helpLink: "medical-evidence.html#q-dental" },
                { id: "cervical", name: "Cervical Cancer Screening", desc: "Pap test (20–34 annually) or Pap + HPV co-test (35+ every 3 yr)", gender: "female", ageStart: 20, ageEnd: 65, freq: "Annual (20–34) / Every 3 yr (35+)", source: "GKV", helpLink: "medical-evidence.html#q-cervical" },
                { id: "breast_exam", name: "Breast Examination", desc: "Annual palpation by physician", gender: "female", ageStart: 30, ageEnd: 120, freq: "Annual", source: "GKV", helpLink: "medical-evidence.html#q-breast" },
                { id: "mammogram", name: "Mammography", desc: "Breast cancer screening X-ray", gender: "female", ageStart: 50, ageEnd: 75, freq: "Every 2 years", source: "GKV", helpLink: "medical-evidence.html#q-breast" },
                { id: "prostate", name: "Prostate &amp; Genital Exam", desc: "Annual prostate palpation", gender: "male", ageStart: 45, ageEnd: 120, freq: "Annual", source: "GKV", helpLink: "medical-evidence.html#q-prostate" },
                { id: "colorectal", name: "Colorectal Cancer Screening", desc: "Annual stool test (50–54) or colonoscopy (from 50 men / 55 women)", gender: "all", ageStart: 50, ageEnd: 120, freq: "Stool test annually / colonoscopy every 10 yr", source: "GKV", helpLink: "medical-evidence.html#q-colorectal" },
                { id: "aaa", name: "Abdominal Aortic Aneurysm Screening", desc: "One-time ultrasound to detect aortic aneurysm", gender: "male", ageStart: 65, ageEnd: 120, freq: "Once", source: "GKV", helpLink: "medical-evidence.html#q-aaa" },
                { id: "eye", name: "Eye Exam", desc: "Comprehensive eye and vision exam (glaucoma, macular degeneration)", gender: "all", ageStart: 40, ageEnd: 120, freq: "Every 2–4 yr (40–54) / Every 1–2 yr (55+)", source: "BVA / AAO", helpLink: "medical-evidence.html#q-eye" }
            ],
            us: [
                { id: "bp", name: "Blood Pressure Screening", desc: "Check for hypertension — the leading modifiable cardiovascular risk factor", gender: "all", ageStart: 18, ageEnd: 120, freq: "Every 2 years (annual if elevated)", source: "USPSTF / ACC/AHA", helpLink: "medical-evidence.html#q-bp" },
                { id: "lipid", name: "Lipid Panel (Cholesterol)", desc: "Total cholesterol, LDL, HDL, triglycerides", gender: "all", ageStart: 20, ageEnd: 120, freq: "Every 4–6 years (every 3 yr if near threshold)", source: "USPSTF / AHA", helpLink: "medical-evidence.html#q-lipid" },
                { id: "glucose", name: "Blood Glucose / Diabetes Screening", desc: "Fasting glucose or HbA1c for prediabetes and diabetes", gender: "all", ageStart: 35, ageEnd: 120, freq: "Every 3 years (if overweight)", source: "USPSTF", helpLink: "medical-evidence.html#q-glucose" },
                { id: "dental", name: "Dental Check-up", desc: "Oral exam and cleaning", gender: "all", ageStart: 18, ageEnd: 120, freq: "Every 6–12 months", source: "ADA", helpLink: "medical-evidence.html#q-dental" },
                { id: "eye", name: "Eye Exam", desc: "Comprehensive eye and vision exam", gender: "all", ageStart: 40, ageEnd: 120, freq: "Every 2–4 yr (40–54) / Every 1–2 yr (55+)", source: "AAO", helpLink: "medical-evidence.html#q-eye" },
                { id: "cervical", name: "Cervical Cancer Screening", desc: "Pap test every 3 yr (21–29) or HPV test every 5 yr (30–65)", gender: "female", ageStart: 21, ageEnd: 65, freq: "Pap every 3 yr / HPV every 5 yr", source: "USPSTF", helpLink: "medical-evidence.html#q-cervical" },
                { id: "mammogram", name: "Mammography", desc: "Breast cancer screening", gender: "female", ageStart: 40, ageEnd: 74, freq: "Every 2 years", source: "USPSTF 2024", helpLink: "medical-evidence.html#q-breast" },
                { id: "colorectal", name: "Colorectal Cancer Screening", desc: "Colonoscopy every 10 yr, or stool-based test annually", gender: "all", ageStart: 45, ageEnd: 85, freq: "Colonoscopy every 10 yr / stool test annually", source: "USPSTF", helpLink: "medical-evidence.html#q-colorectal" },
                { id: "lung", name: "Lung Cancer Screening (LDCT)", desc: "Low-dose CT for current/former heavy smokers (20+ pack-years)", gender: "all", ageStart: 50, ageEnd: 80, freq: "Annual", source: "USPSTF", smoking: "ever", helpLink: "medical-evidence.html#q-lung" },
                { id: "prostate", name: "Prostate Cancer Screening (PSA)", desc: "PSA blood test — shared decision with provider", gender: "male", ageStart: 55, ageEnd: 69, freq: "Shared decision, every 1–2 yr", source: "USPSTF", helpLink: "medical-evidence.html#q-prostate" },
                { id: "aaa", name: "Abdominal Aortic Aneurysm Screening", desc: "One-time ultrasound for men who have ever smoked", gender: "male", ageStart: 65, ageEnd: 75, freq: "Once", source: "USPSTF", smoking: "ever", helpLink: "medical-evidence.html#q-aaa" },
                { id: "dexa", name: "Bone Density (DEXA Scan)", desc: "Osteoporosis screening", gender: "female", ageStart: 65, ageEnd: 120, freq: "Baseline at 65, then per provider", source: "USPSTF", helpLink: "medical-evidence.html#q-dexa" },
                { id: "skin", name: "Skin Cancer Check", desc: "Full-body skin exam by dermatologist", gender: "all", ageStart: 35, ageEnd: 120, freq: "Every 2–3 yr (annual if high risk or 65+)", source: "AAD / Skin Cancer Foundation", helpLink: "medical-evidence.html#q-skin" }
            ],
            eu: [
                { id: "bp", name: "Blood Pressure Screening", desc: "Check for hypertension", gender: "all", ageStart: 18, ageEnd: 120, freq: "Every 2–3 years", source: "ESC 2024", helpLink: "medical-evidence.html#q-bp" },
                { id: "lipid", name: "Lipid Panel (Cholesterol)", desc: "Total cholesterol, LDL, HDL", gender: "all", ageStart: 40, ageEnd: 120, freq: "Every 4–6 years", source: "ESC / National guidelines", helpLink: "medical-evidence.html#q-lipid" },
                { id: "glucose", name: "Blood Glucose / Diabetes Screening", desc: "Fasting glucose or HbA1c", gender: "all", ageStart: 40, ageEnd: 120, freq: "Every 3 years (if overweight or risk factors)", source: "National guidelines", helpLink: "medical-evidence.html#q-glucose" },
                { id: "dental", name: "Dental Check-up", desc: "Oral exam and cleaning", gender: "all", ageStart: 18, ageEnd: 120, freq: "Every 6–12 months", source: "National dental associations", helpLink: "medical-evidence.html#q-dental" },
                { id: "eye", name: "Eye Exam", desc: "Comprehensive eye and vision exam", gender: "all", ageStart: 40, ageEnd: 120, freq: "Every 2–4 yr (40–54) / Every 1–2 yr (55+)", source: "National ophthalmology guidelines", helpLink: "medical-evidence.html#q-eye" },
                { id: "cervical", name: "Cervical Cancer Screening", desc: "HPV-based screening, adjusted for vaccination history", gender: "female", ageStart: 25, ageEnd: 65, freq: "Every 3–5 years (HPV-based)", source: "EU Council 2022", helpLink: "medical-evidence.html#q-cervical" },
                { id: "mammogram", name: "Mammography", desc: "Breast cancer screening", gender: "female", ageStart: 45, ageEnd: 74, freq: "Every 2 years", source: "EU Council 2022", helpLink: "medical-evidence.html#q-breast" },
                { id: "colorectal", name: "Colorectal Cancer Screening", desc: "Stool-based test or colonoscopy", gender: "all", ageStart: 50, ageEnd: 120, freq: "Every 1–2 years (stool) or colonoscopy every 10 yr", source: "EU Council 2022", helpLink: "medical-evidence.html#q-colorectal" },
                { id: "skin", name: "Skin Cancer Check", desc: "Full-body skin exam by dermatologist", gender: "all", ageStart: 35, ageEnd: 120, freq: "Every 2–3 years (per national guidelines)", source: "National guidelines", helpLink: "medical-evidence.html#q-skin" }
            ],
            other: [
                { id: "bp", name: "Blood Pressure Screening", desc: "Check for hypertension", gender: "all", ageStart: 18, ageEnd: 120, freq: "Every 2–3 years", source: "WHO / International consensus", helpLink: "medical-evidence.html#q-bp" },
                { id: "lipid", name: "Lipid Panel (Cholesterol)", desc: "Total cholesterol, LDL, HDL", gender: "all", ageStart: 40, ageEnd: 120, freq: "Every 4–6 years", source: "International consensus", helpLink: "medical-evidence.html#q-lipid" },
                { id: "glucose", name: "Blood Glucose / Diabetes Screening", desc: "Fasting glucose or HbA1c", gender: "all", ageStart: 40, ageEnd: 120, freq: "Every 3 years", source: "International consensus", helpLink: "medical-evidence.html#q-glucose" },
                { id: "dental", name: "Dental Check-up", desc: "Oral exam and cleaning", gender: "all", ageStart: 18, ageEnd: 120, freq: "Every 6–12 months", source: "WHO", helpLink: "medical-evidence.html#q-dental" },
                { id: "eye", name: "Eye Exam", desc: "Comprehensive eye and vision exam", gender: "all", ageStart: 40, ageEnd: 120, freq: "Every 2–4 yr", source: "International consensus", helpLink: "medical-evidence.html#q-eye" },
                { id: "colorectal", name: "Colorectal Cancer Screening", desc: "Stool test or colonoscopy", gender: "all", ageStart: 50, ageEnd: 85, freq: "Per local guidelines", source: "International consensus", helpLink: "medical-evidence.html#q-colorectal" }
            ]
        };

        function getRelevantScreenings(country, age, sex, smoking) {
            if (!country || !age || !sex) return [];
            const list = SCREENING_GUIDELINES[country] || SCREENING_GUIDELINES['other'];
            return list.filter(s => {
                if (age < s.ageStart || age > s.ageEnd) return false;
                if (s.gender !== 'all' && s.gender !== sex) return false;
                if (s.smoking === 'ever' && smoking !== 'current' && smoking !== 'former') return false;
                return true;
            });
        }

        // ========================================
        // CATEGORY CONFIGURATION (6 Dimensions)
        // ========================================
        
        // __QUESTIONS_START__
        const CATEGORIES = {
                "medical": {
                    "name": "Medical",
                    "icon": "heart-pulse",
                    "sections": {
                        "sec1": {
                            "title": "Your Profile",
                            "weight": 0.15,
                            "questions": [
                                {
                                    "id": "MD1_yob",
                                    "question": "What year were you born?",
                                    "hint": "Used for age-specific fitness norms and screening recommendations",
                                    "type": "number",
                                    "min": 1920,
                                    "max": 2008,
                                    "step": 1,
                                    "unit": "year"
                                },
                                {
                                    "id": "MD1_sex",
                                    "question": "What is your biological sex?",
                                    "hint": "Used for sex-specific fitness norms and screening recommendations",
                                    "type": "radio",
                                    "options": [
                                        {
                                            "value": "male",
                                            "label": "Male"
                                        },
                                        {
                                            "value": "female",
                                            "label": "Female"
                                        }
                                    ]
                                },
                                {
                                    "id": "MD1_country",
                                    "question": "Which preventive care system applies to you?",
                                    "hint": "Determines which screening guidelines we show",
                                    "type": "radio",
                                    "options": [
                                        {
                                            "value": "de",
                                            "label": "Germany (GKV)",
                                            "helpLink": "medical-evidence.html#q-system-de"
                                        },
                                        {
                                            "value": "us",
                                            "label": "United States",
                                            "helpLink": "medical-evidence.html#q-system-us"
                                        },
                                        {
                                            "value": "eu",
                                            "label": "EU (other)",
                                            "helpLink": "medical-evidence.html#q-system-eu"
                                        },
                                        {
                                            "value": "other",
                                            "label": "Other / Not sure",
                                            "helpLink": "medical-evidence.html#q-system-other"
                                        }
                                    ]
                                },
                                {
                                    "id": "MD1_smoking",
                                    "question": "What is your smoking status?",
                                    "hint": "Some screenings (e.g. lung cancer, aortic aneurysm) depend on smoking history",
                                    "type": "radio",
                                    "options": [
                                        {
                                            "value": "never",
                                            "label": "Never smoked"
                                        },
                                        {
                                            "value": "former",
                                            "label": "Former smoker"
                                        },
                                        {
                                            "value": "current",
                                            "label": "Current smoker"
                                        }
                                    ]
                                },
                                {
                                    "id": "MD1_1",
                                    "question": "When was your last comprehensive health checkup?",
                                    "type": "radio",
                                    "helpLink": "medical-evidence.html#q-checkup",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Within the last year",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "1-2 years ago",
                                            "points": 7
                                        },
                                        {
                                            "value": "4",
                                            "label": "2-3 years ago",
                                            "points": 4
                                        },
                                        {
                                            "value": "0",
                                            "label": "More than 3 years ago",
                                            "points": 0
                                        }
                                    ]
                                },
                                {
                                    "id": "MD1_2",
                                    "question": "Do you know your key health numbers? (Blood pressure, cholesterol, blood sugar)",
                                    "type": "radio",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Yes, all of them",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "Most of them",
                                            "points": 7
                                        },
                                        {
                                            "value": "4",
                                            "label": "Some of them",
                                            "points": 4
                                        },
                                        {
                                            "value": "0",
                                            "label": "No, I don't know them",
                                            "points": 0
                                        }
                                    ]
                                },
                                {
                                    "id": "MD1_whr",
                                    "question": "What is your waist-to-hip ratio?",
                                    "hint": "Measure waist at navel, hips at widest point. Divide waist by hips. Leave blank if unknown.",
                                    "type": "number",
                                    "min": 0.5,
                                    "max": 1.5,
                                    "step": 0.01,
                                    "genderScoring": {
                                        "male": {
                                            "inputMin": 0.95,
                                            "inputMax": 0.8
                                        },
                                        "female": {
                                            "inputMin": 0.85,
                                            "inputMax": 0.7
                                        }
                                    },
                                    "helpLink": "cardiometabolic-evidence.html#q-whr"
                                }
                            ]
                        },
                        "sec2": {
                            "title": "Recommended Screenings",
                            "weight": 0.35,
                            "description": "Based on your profile, here are the screenings recommended for you. Check the ones you are up to date on.",
                            "dynamic": "screenings",
                            "questions": []
                        },
                        "sec3": {
                            "title": "Blood Markers",
                            "weight": 0.5,
                            "description": "Enter your blood test results below. These markers are used to calculate both your Cardiovascular Health Score and your Metabolic Health Score.",
                            "subScores": {
                                "cardiovascular": {
                                    "label": "Cardiovascular Health",
                                    "icon": "heart",
                                    "helpLink": "cardiovascular-evidence.html#q-attia"
                                },
                                "metabolic": {
                                    "label": "Metabolic Health",
                                    "icon": "activity",
                                    "helpLink": "metabolic-evidence.html#q-means"
                                }
                            },
                            "questions": [
                                // --- Cardiovascular only ---
                                {
                                    "id": "MD3_apob",
                                    "question": "What is your ApoB level?",
                                    "hint": "Found on advanced lipid panel (mg/dL). Leave blank if not tested.",
                                    "type": "number",
                                    "min": 20,
                                    "max": 250,
                                    "step": 1,
                                    "unit": "mg/dL",
                                    "inputMin": 130,
                                    "inputMax": 60,
                                    "edgeFloor": 30,
                                    "edgeFloorLabel": "ApoB below 30 mg/dL is unusually low — verify with your lab.",
                                    "cardiovascularWeight": 0.3,
                                    "metabolicWeight": 0,
                                    "helpLink": "cardiovascular-evidence.html#q-apob",
                                    "group": "cardiovascular"
                                },
                                {
                                    "id": "MD3_bp",
                                    "question": "What is your systolic blood pressure?",
                                    "hint": "The top number, e.g. 120 in 120/80 (mmHg). Leave blank if unknown.",
                                    "type": "number",
                                    "min": 70,
                                    "max": 220,
                                    "step": 1,
                                    "unit": "mmHg",
                                    "inputMin": 130,
                                    "inputMax": 110,
                                    "edgeFloor": 100,
                                    "edgeFloorLabel": "Systolic BP below 100 mmHg (hypotension) may indicate a health issue.",
                                    "cardiovascularWeight": 0.25,
                                    "metabolicWeight": 0,
                                    "helpLink": "cardiovascular-evidence.html#q-bp",
                                    "group": "cardiovascular"
                                },
                                {
                                    "id": "MD3_lpa",
                                    "question": "What is your Lp(a) level?",
                                    "hint": "Specialized test, usually in nmol/L. Leave blank if not tested.",
                                    "type": "number",
                                    "min": 0,
                                    "max": 500,
                                    "step": 1,
                                    "unit": "nmol/L",
                                    "inputMin": 125,
                                    "inputMax": 30,
                                    "cardiovascularWeight": 0.15,
                                    "metabolicWeight": 0,
                                    "helpLink": "cardiovascular-evidence.html#q-lpa",
                                    "group": "cardiovascular"
                                },
                                // --- Shared (CV + Metabolic) ---
                                {
                                    "id": "MD3_hdl",
                                    "question": "What is your HDL cholesterol?",
                                    "hint": "Found on standard lipid panel (mg/dL). Leave blank if not tested.",
                                    "type": "number",
                                    "min": 10,
                                    "max": 150,
                                    "step": 1,
                                    "unit": "mg/dL",
                                    "genderScoring": {
                                        "male": {
                                            "inputMin": 40,
                                            "inputMax": 60
                                        },
                                        "female": {
                                            "inputMin": 50,
                                            "inputMax": 70
                                        }
                                    },
                                    "edgeCeiling": 100,
                                    "edgeCeilingLabel": "HDL above 100 mg/dL may paradoxically increase mortality risk (Madsen et al. 2017) — discuss with your doctor.",
                                    "cardiovascularWeight": 0.15,
                                    "metabolicWeight": 0.25,
                                    "helpLink": "cardiovascular-evidence.html#q-hdl",
                                    "group": "shared"
                                },
                                {
                                    "id": "MD3_trig",
                                    "question": "What are your triglycerides?",
                                    "hint": "Found on standard lipid panel (mg/dL). Leave blank if not tested.",
                                    "type": "number",
                                    "min": 20,
                                    "max": 500,
                                    "step": 1,
                                    "unit": "mg/dL",
                                    "inputMin": 150,
                                    "inputMax": 70,
                                    "edgeFloor": 30,
                                    "edgeFloorLabel": "Triglycerides below 30 mg/dL are very unusual — verify with your lab.",
                                    "cardiovascularWeight": 0.15,
                                    "metabolicWeight": 0.25,
                                    "helpLink": "cardiovascular-evidence.html#q-trig",
                                    "group": "shared"
                                },
                                // --- Metabolic only ---
                                {
                                    "id": "MD3_insulin",
                                    "question": "What is your fasting insulin level?",
                                    "hint": "Found on metabolic panel (µIU/mL). Leave blank if not tested.",
                                    "type": "number",
                                    "min": 0,
                                    "max": 80,
                                    "step": 0.1,
                                    "unit": "µIU/mL",
                                    "inputMin": 25,
                                    "inputMax": 5,
                                    "edgeFloor": 1,
                                    "edgeFloorLabel": "Fasting insulin below 1 µIU/mL is very unusual — verify with your lab.",
                                    "cardiovascularWeight": 0,
                                    "metabolicWeight": 0.25,
                                    "helpLink": "metabolic-evidence.html#q-insulin",
                                    "group": "metabolic"
                                },
                                {
                                    "id": "MD3_glucose",
                                    "question": "What is your fasting blood glucose?",
                                    "hint": "Found on basic metabolic panel (mg/dL). Leave blank if not tested.",
                                    "type": "number",
                                    "min": 40,
                                    "max": 400,
                                    "step": 1,
                                    "unit": "mg/dL",
                                    "inputMin": 100,
                                    "inputMax": 80,
                                    "edgeFloor": 55,
                                    "edgeFloorLabel": "Fasting glucose below 55 mg/dL (hypoglycemia) may indicate a health issue.",
                                    "cardiovascularWeight": 0,
                                    "metabolicWeight": 0.25,
                                    "helpLink": "metabolic-evidence.html#q-glucose",
                                    "group": "metabolic"
                                }
                            ]
                        }
                    }
                },
                "nutrition": {
                    "name": "Nutrition",
                    "icon": "apple",
                    "sections": {
                        "sec1": {
                            "title": "Diet Adherence",
                            "weight": 0.25,
                            "questions": [
                                {
                                    "id": "N1_1",
                                    "question": "How much do you enjoy your food?",
                                    "hint": "Rate from 1 (not at all) to 10 (always a delight)",
                                    "type": "slider",
                                    "min": 1,
                                    "max": 10,
                                    "helpLink": "nutrition-evidence.html#q8"
                                },
                                {
                                    "id": "N1_2",
                                    "question": "In which situations does your diet work well?",
                                    "type": "checkbox",
                                    "scoring": "count",
                                    "helpLink": "nutrition-evidence.html#q9",
                                    "options": [
                                        {
                                            "value": "restaurant",
                                            "label": "Restaurant"
                                        },
                                        {
                                            "value": "travel",
                                            "label": "Travel"
                                        },
                                        {
                                            "value": "family",
                                            "label": "Family and friends"
                                        },
                                        {
                                            "value": "stress",
                                            "label": "Stressful situations"
                                        }
                                    ]
                                },
                                {
                                    "id": "N1_3",
                                    "question": "How satisfied do you feel after eating?",
                                    "type": "radio",
                                    "helpLink": "nutrition-evidence.html#q10",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Always full, no cravings",
                                            "points": 10
                                        },
                                        {
                                            "value": "5",
                                            "label": "Mostly full, rarely hungry",
                                            "points": 5
                                        },
                                        {
                                            "value": "2",
                                            "label": "Regularly hungry",
                                            "points": 2
                                        },
                                        {
                                            "value": "0",
                                            "label": "Constantly hungry",
                                            "points": 0
                                        }
                                    ]
                                }
                            ]
                        },
                        "sec2": {
                            "title": "Progress",
                            "weight": 0.25,
                            "questions": [
                                {
                                    "id": "N2_1",
                                    "question": "How is your progress towards your goals?",
                                    "type": "radio",
                                    "helpLink": "nutrition-evidence.html#q11",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Every week is a win",
                                            "points": 10
                                        },
                                        {
                                            "value": "8",
                                            "label": "Most weeks successful",
                                            "points": 8
                                        },
                                        {
                                            "value": "5",
                                            "label": "Slow but visible progress",
                                            "points": 5
                                        },
                                        {
                                            "value": "2",
                                            "label": "Stagnation",
                                            "points": 2
                                        },
                                        {
                                            "value": "0",
                                            "label": "Getting worse",
                                            "points": 0
                                        }
                                    ]
                                }
                            ]
                        },
                        "sec3": {
                            "title": "Protein",
                            "weight": 0.25,
                            "footerLink": {
                                "text": "→ Open Nutrition Calculator",
                                "url": "nutrition-calculator.html",
                                "description": "Use nutrition calculator to calculate optimal protein intake according to your goals."
                            },
                            "questions": [
                                {
                                    "id": "N3_1",
                                    "question": "What is your daily protein intake per kg of body weight?",
                                    "type": "radio",
                                    "helpLink": "protein-evidence.html#q1",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "1.6–2.0 g/kg",
                                            "points": 10
                                        },
                                        {
                                            "value": "6",
                                            "label": "1.2–1.5 g/kg",
                                            "points": 6
                                        },
                                        {
                                            "value": "2",
                                            "label": "0.8–1.1 g/kg (RDA)",
                                            "points": 2
                                        },
                                        {
                                            "value": "0",
                                            "label": "Below 0.8 g/kg",
                                            "points": 0
                                        }
                                    ]
                                },
                                {
                                    "id": "N3_2",
                                    "question": "How many meals per day contain the age-related minimum protein per portion?",
                                    "type": "radio",
                                    "helpLink": "protein-evidence.html#q4",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "4 or more meals/snacks",
                                            "points": 10
                                        },
                                        {
                                            "value": "6",
                                            "label": "3 meals",
                                            "points": 6
                                        },
                                        {
                                            "value": "2",
                                            "label": "2 meals",
                                            "points": 2
                                        },
                                        {
                                            "value": "0",
                                            "label": "1 or fewer",
                                            "points": 0
                                        }
                                    ]
                                }
                            ]
                        },
                        "sec4": {
                            "title": "Nutrition Principles",
                            "weight": 0.25,
                            "description": "Check habits you follow 7+ out of 10 days.",
                            "questions": [
                                {
                                    "id": "N4_principles",
                                    "question": "Which nutrition principles do you follow?",
                                    "type": "checkbox",
                                    "scoring": "principles",
                                    "helpLink": "nutrition-evidence.html#q6",
                                    "options": [
                                        {
                                            "value": "vegetables",
                                            "label": "3+ servings vegetables daily",
                                            "evidence": "13% lower mortality"
                                        },
                                        {
                                            "value": "whole_foods",
                                            "label": "Home-cooked whole foods",
                                            "evidence": "15% lower mortality"
                                        },
                                        {
                                            "value": "healthy_fats",
                                            "label": "Healthy fats (olive oil, nuts)",
                                            "evidence": "30% less CVD"
                                        },
                                        {
                                            "value": "avoid_harmful",
                                            "label": "Avoid trans fats & processed meat",
                                            "evidence": "34% reduction"
                                        },
                                        {
                                            "value": "alcohol",
                                            "label": "Moderate alcohol (max 7/week)",
                                            "evidence": "Linear dose-response"
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                },
                "energy": {
                    "name": "Energy & Performance",
                    "icon": "zap",
                    "sections": {
                        "sec1": {
                            "title": "VO2max / Aerobic Capacity",
                            "weight": 0.5,
                            "description": "Cardiorespiratory fitness is one of the strongest predictors of longevity. Enter your VO2max from a wearable, the Cooper Test, or a lab test.",
                            "questions": [
                                {
                                    "id": "E1_vo2",
                                    "question": "What is your VO2max?",
                                    "hint": "Enter in ml/kg/min. Check your fitness watch, or use the Cooper Test calculator below.",
                                    "type": "number",
                                    "min": 5,
                                    "max": 100,
                                    "step": 0.1,
                                    "unit": "ml/kg/min",
                                    "normsTable": "VO2MAX_NORMS",
                                    "cooperCalc": true,
                                    "fitnessAgeLabel": "VO2max age",
                                    "helpLink": "vo2max-evidence.html#q3",
                                    "coaching": {
                                        "impactWeight": 0.95,
                                        "improvability": 0.95,
                                        "benefitType": "short-term",
                                        "benefitTimeline": "2–6 weeks",
                                        "preScoreNudge": "VO2max is the single strongest predictor of longevity — yet most people have never measured theirs. Without knowing your number, you can't see your biggest lever.",
                                        "concreteBenefit": "Every MET you gain gives you more energy for daily life and adds measurable longevity protection.",
                                        "recoveryNudge": "VO2max bounces back quickly — a few weeks of consistent movement will reverse this.",
                                        "messages": {
                                            "q1_initial": {"headline":"Your VO2max puts you in the bottom quartile — but this is where gains come fastest","detail":"People starting here typically gain 1 MET (3.5 ml/kg/min) within 4–6 weeks of regular brisk walking. That means climbing 2–3 flights of stairs without stopping for breath. VO2max is the strongest single predictor of all-cause mortality — and it's highly trainable at any starting point."},
                                            "q1_improved": {"headline":"You're making real progress — every point of VO2max you gain adds measurable daily capacity","detail":"The improvement you've made translates directly to easier movement: less breathlessness on stairs, more energy for daily tasks. Keep this trajectory — research shows the biggest mortality reduction comes from moving out of the bottom 25%."},
                                            "q1_stable": {"headline":"Your VO2max hasn't changed yet — let's find what unlocks movement for you","detail":"Even 10 minutes of brisk walking per day can start shifting VO2max within weeks. The key is consistency, not intensity. Could you add a short walk after one meal each day?"},
                                            "q1_declined": {"headline":"Your VO2max has dipped — this is common and reversible","detail":"VO2max fluctuates with illness, stress, and inactivity. A few weeks of regular movement will recover what you've lost. The important thing is restarting, not where you restart from."},
                                            "q2_initial": {"headline":"You have a solid foundation — the next tier unlocks noticeably easier daily movement","detail":"At your current level, daily activities are manageable but may still feel effortful. Improving by 1 MET means brisk walking feels easy, moderate hikes become enjoyable, and you recover faster from physical tasks. This is achievable in 4–8 weeks."},
                                            "q2_improved": {"headline":"You've crossed into the next tier — can you feel the difference?","detail":"Most people at this stage notice stairs getting easier and energy lasting longer through the afternoon. You're moving away from the risk zone — each additional point compounds your protection."},
                                            "q2_stable": {"headline":"You're holding steady — now is the time to push for the next level","detail":"Consistency brought you here. Adding interval efforts — even short bursts of faster walking — is what drives VO2max from fair toward good. Two sessions per week is enough to see change."},
                                            "q2_declined": {"headline":"Your VO2max has dropped — worth checking what changed","detail":"Common causes: reduced activity during a busy period, illness, or poor sleep. VO2max responds quickly to resumed training. Even 2–3 weeks of regular activity should reverse this decline."},
                                            "q3_initial": {"headline":"You're above average — pushing further puts you in the protective range","detail":"At this level, you can hike, cycle, and handle physically demanding days comfortably. Moving into the top quartile is associated with significantly lower all-cause mortality. You're within reach — structured cardio 3× per week can get you there."},
                                            "q3_improved": {"headline":"Strong progress — you're entering the range where health protection compounds","detail":"Your improvement means more than fitness — it's extending your healthspan. At this level, activities like hill hiking, recreational sports, and active travel become easy. The gap to 'excellent' is smaller than what you've already covered."},
                                            "q3_stable": {"headline":"Good and consistent — the foundation is solid","detail":"Maintaining this level already puts you ahead of most people your age. To push higher, consider adding one high-intensity interval session per week — the most time-efficient way to drive VO2max upward."},
                                            "q3_declined": {"headline":"A small decline from a good base — easy to recover","detail":"You have the fitness foundation to bounce back quickly. Resuming your previous routine should restore your level within 2–3 weeks. Fitness memory works in your favor."},
                                            "q4_initial": {"headline":"Excellent — you're in the top quartile for your age and sex","detail":"Your VO2max puts you in a category associated with dramatically lower mortality risk and high functional independence into older age. Hiking with a heavy pack, vigorous sports, and physically demanding work are all well within your capacity."},
                                            "q4_improved": {"headline":"You've pushed into excellent territory — this is where longevity protection is strongest","detail":"Research shows diminishing returns above this level for mortality — but the functional capacity gains continue. You're building a reserve that pays dividends for decades."},
                                            "q4_stable": {"headline":"Maintaining excellent fitness — this is the goal","detail":"Consistency at this level is more valuable than occasional peaks. Your current routine is working. Focus on sustainability and injury prevention to keep this level for years."},
                                            "q4_declined": {"headline":"A dip from excellent — your base fitness makes recovery fast","detail":"At your level, VO2max fluctuations are normal with training cycles, travel, or seasonal changes. Your cardiovascular system retains adaptations well — a focused 2–3 week block will restore your level."},
                                            "q5_initial": {"headline":"Superior — you're performing at an exceptional level","detail":"Your VO2max places you in the top 3% for your age and sex. This level of cardiovascular fitness is associated with the lowest possible mortality risk. You have the aerobic capacity for mountaineering, competitive endurance sports, and sustained high-output activities."},
                                            "q5_improved": {"headline":"You've reached the highest tier — an extraordinary achievement","detail":"Very few people achieve this level. You're maximizing both longevity protection and functional capacity. The focus now is maintaining this through smart, sustainable training."},
                                            "q5_stable": {"headline":"Maintaining superior fitness — you're in the optimal zone","detail":"At this level, the priority shifts from improvement to longevity of the habit. Injury prevention, recovery quality, and training variety keep you here for years rather than months."},
                                            "q5_declined": {"headline":"A step back from superior — still in excellent range","detail":"Even with a decline, you're likely still in the top 10%. The fitness base you've built retains well. Adjust training load or recovery as needed — you know your body at this level."}
                                        }
                                    }
                                },
                                {
                                    "id": "E1_method",
                                    "question": "How did you measure your VO2max?",
                                    "hint": "Informational only — does not affect your score",
                                    "type": "radio",
                                    "helpLink": "vo2max-evidence.html#q6",
                                    "options": [
                                        {
                                            "value": "wearable",
                                            "label": "Wearable device (Apple Watch, Garmin, etc.)"
                                        },
                                        {
                                            "value": "cooper",
                                            "label": "Cooper 12-minute run test"
                                        },
                                        {
                                            "value": "lab",
                                            "label": "Laboratory test (metabolic cart)"
                                        }
                                    ]
                                }
                            ]
                        },
                        "sec2": {
                            "title": "Muscle Strength",
                            "weight": 0.5,
                            "description": "Muscle strength predicts functional independence and longevity. Complete one or both tests below.",
                            "questions": [
                                {
                                    "id": "E2_pushups",
                                    "question": "How many consecutive push-ups can you complete?",
                                    "hint": "Men: standard (from toes). Women: modified (from knees). Maintain proper form throughout.",
                                    "type": "number",
                                    "min": 0,
                                    "max": 200,
                                    "step": 1,
                                    "unit": "reps",
                                    "normsTable": "PUSHUP_NORMS",
                                    "fitnessAgeLabel": "Strength age",
                                    "helpLink": "muscle-strength-evidence.html#q3"
                                },
                                {
                                    "id": "E2_chair",
                                    "question": "How many chair stands can you do in 30 seconds?",
                                    "hint": "Stand fully from a chair and sit back down. Count complete cycles. This test is for ages 60+.",
                                    "type": "number",
                                    "min": 0,
                                    "max": 50,
                                    "step": 1,
                                    "unit": "reps",
                                    "normsTable": "CHAIRSTAND_NORMS",
                                    "ageMin": 60,
                                    "fitnessAgeLabel": "Functional age",
                                    "helpLink": "muscle-strength-evidence.html#q4"
                                }
                            ]
                        }
                    }
                },
                "sleep": {
                    "name": "Sleep",
                    "icon": "moon",
                    "sections": {
                        "sec1": {
                            "title": "Sleep Duration & Regularity",
                            "weight": 0.35,
                            "questions": [
                                {
                                    "id": "SS1_1",
                                    "question": "How many hours of sleep do you typically get per night?",
                                    "hint": "Average over the past month",
                                    "type": "radio",
                                    "helpLink": "sleep-evidence.html#q4",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "7–8 hours",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "6–7 or 8–9 hours",
                                            "points": 7
                                        },
                                        {
                                            "value": "4",
                                            "label": "5–6 or 9–10 hours",
                                            "points": 4
                                        },
                                        {
                                            "value": "0",
                                            "label": "Less than 5 or more than 10 hours",
                                            "points": 0
                                        }
                                    ]
                                },
                                {
                                    "id": "SS1_2",
                                    "question": "How consistent is your sleep schedule?",
                                    "hint": "Same bedtime and wake time each day",
                                    "type": "radio",
                                    "helpLink": "sleep-evidence.html#q3",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Very consistent (±30 min)",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "Fairly consistent (±1 hour)",
                                            "points": 7
                                        },
                                        {
                                            "value": "4",
                                            "label": "Somewhat irregular (±2 hours)",
                                            "points": 4
                                        },
                                        {
                                            "value": "0",
                                            "label": "Highly irregular (varies widely)",
                                            "points": 0
                                        }
                                    ]
                                }
                            ]
                        },
                        "sec2": {
                            "title": "Sleep Quality",
                            "weight": 0.35,
                            "questions": [
                                {
                                    "id": "SS2_1",
                                    "question": "How would you rate your overall sleep quality?",
                                    "hint": "Over the past month — 1 (terrible) to 10 (excellent)",
                                    "type": "slider",
                                    "min": 1,
                                    "max": 10,
                                    "helpLink": "sleep-evidence.html#q5"
                                },
                                {
                                    "id": "SS2_2",
                                    "question": "How often do you wake up feeling rested and refreshed?",
                                    "type": "radio",
                                    "helpLink": "sleep-evidence.html#q6",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Every day or almost every day",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "Most days",
                                            "points": 7
                                        },
                                        {
                                            "value": "4",
                                            "label": "Some days",
                                            "points": 4
                                        },
                                        {
                                            "value": "0",
                                            "label": "Rarely or never",
                                            "points": 0
                                        }
                                    ]
                                },
                                {
                                    "id": "SS2_3",
                                    "question": "How often do you have trouble falling or staying asleep?",
                                    "type": "radio",
                                    "helpLink": "sleep-evidence.html#q7",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Rarely or never",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "Occasionally (1–2 nights/week)",
                                            "points": 7
                                        },
                                        {
                                            "value": "4",
                                            "label": "Frequently (3–4 nights/week)",
                                            "points": 4
                                        },
                                        {
                                            "value": "0",
                                            "label": "Almost every night",
                                            "points": 0
                                        }
                                    ]
                                }
                            ]
                        },
                        "sec3": {
                            "title": "Wearable Sleep Score",
                            "weight": 0.3,
                            "questions": [
                                {
                                    "id": "SS3_1",
                                    "question": "What is your average wearable sleep score?",
                                    "hint": "30-day average from your wearable app (0–100). Leave blank if you don't use a sleep tracker.",
                                    "type": "number",
                                    "min": 0,
                                    "max": 100,
                                    "unit": "/ 100",
                                    "inputMin": 0,
                                    "inputMax": 100,
                                    "step": 1,
                                    "helpLink": "sleep-evidence.html#q8"
                                }
                            ]
                        }
                    }
                },
                "wellbeing": {
                    "name": "Wellbeing",
                    "icon": "smile",
                    "sections": {
                        "sec1": {
                            "title": "Positive Emotions & Engagement",
                            "weight": 0.3,
                            "questions": [
                                {
                                    "id": "W1_1",
                                    "question": "How often do you experience positive emotions such as joy, gratitude, or contentment?",
                                    "type": "radio",
                                    "helpLink": "wellbeing-evidence.html#q4",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Every day or almost",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "Most days",
                                            "points": 7
                                        },
                                        {
                                            "value": "4",
                                            "label": "Some days",
                                            "points": 4
                                        },
                                        {
                                            "value": "0",
                                            "label": "Rarely",
                                            "points": 0
                                        }
                                    ]
                                },
                                {
                                    "id": "W1_2",
                                    "question": "How often do you get fully absorbed in activities you enjoy?",
                                    "hint": "\"Flow\" — losing track of time while doing something engaging",
                                    "type": "radio",
                                    "helpLink": "wellbeing-evidence.html#q5",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Daily or almost daily",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "Several times a week",
                                            "points": 7
                                        },
                                        {
                                            "value": "4",
                                            "label": "Occasionally",
                                            "points": 4
                                        },
                                        {
                                            "value": "0",
                                            "label": "Rarely or never",
                                            "points": 0
                                        }
                                    ]
                                }
                            ]
                        },
                        "sec2": {
                            "title": "Relationships, Meaning & Accomplishment",
                            "weight": 0.35,
                            "questions": [
                                {
                                    "id": "W2_1",
                                    "question": "How would you rate the quality of your close relationships?",
                                    "type": "radio",
                                    "helpLink": "wellbeing-evidence.html#q6",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Excellent — deep, supportive connections",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "Good — regular meaningful interactions",
                                            "points": 7
                                        },
                                        {
                                            "value": "4",
                                            "label": "Fair — some connections but lacking depth",
                                            "points": 4
                                        },
                                        {
                                            "value": "0",
                                            "label": "Poor — feeling isolated or unsupported",
                                            "points": 0
                                        }
                                    ]
                                },
                                {
                                    "id": "W2_2",
                                    "question": "To what extent do you feel your life has a sense of purpose or meaning?",
                                    "type": "radio",
                                    "helpLink": "wellbeing-evidence.html#q7",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Strong and clear sense of purpose",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "Moderate — I have some direction",
                                            "points": 7
                                        },
                                        {
                                            "value": "4",
                                            "label": "Somewhat unclear",
                                            "points": 4
                                        },
                                        {
                                            "value": "0",
                                            "label": "Lacking direction or purpose",
                                            "points": 0
                                        }
                                    ]
                                },
                                {
                                    "id": "W2_3",
                                    "question": "How often do you feel a sense of accomplishment or progress toward your goals?",
                                    "type": "radio",
                                    "helpLink": "wellbeing-evidence.html#q8",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Regularly — meaningful progress",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "Often — steady but could be more",
                                            "points": 7
                                        },
                                        {
                                            "value": "4",
                                            "label": "Sometimes",
                                            "points": 4
                                        },
                                        {
                                            "value": "0",
                                            "label": "Rarely — I feel stuck",
                                            "points": 0
                                        }
                                    ]
                                }
                            ]
                        },
                        "sec3": {
                            "title": "Stress Balance",
                            "weight": 0.35,
                            "questions": [
                                {
                                    "id": "W3_1",
                                    "question": "Which best describes the stress you typically experience?",
                                    "hint": "Eustress (challenge stress) energizes you; distress drains you",
                                    "type": "radio",
                                    "helpLink": "wellbeing-evidence.html#q9",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Mostly challenge stress — stretched but energized",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "A healthy mix — some motivating, some draining",
                                            "points": 7
                                        },
                                        {
                                            "value": "3",
                                            "label": "Mostly draining — feeling overwhelmed",
                                            "points": 3
                                        },
                                        {
                                            "value": "0",
                                            "label": "Chronic overwhelm affecting health and sleep",
                                            "points": 0
                                        }
                                    ]
                                },
                                {
                                    "id": "W3_2",
                                    "question": "How quickly do you recover after stressful periods?",
                                    "type": "radio",
                                    "helpLink": "wellbeing-evidence.html#q10",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Within hours — effective coping strategies",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "Within a day or two",
                                            "points": 7
                                        },
                                        {
                                            "value": "4",
                                            "label": "It takes weeks",
                                            "points": 4
                                        },
                                        {
                                            "value": "0",
                                            "label": "I rarely feel fully recovered",
                                            "points": 0
                                        }
                                    ]
                                },
                                {
                                    "id": "W3_3",
                                    "question": "Do you regularly practice any stress-management techniques?",
                                    "hint": "e.g. meditation, breathwork, journaling, time in nature, therapy",
                                    "type": "radio",
                                    "helpLink": "wellbeing-evidence.html#q11",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Yes, daily practice",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "Yes, several times a week",
                                            "points": 7
                                        },
                                        {
                                            "value": "4",
                                            "label": "Occasionally",
                                            "points": 4
                                        },
                                        {
                                            "value": "0",
                                            "label": "No regular practice",
                                            "points": 0
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                },
                "mindset": {
                    "name": "Mindset",
                    "icon": "brain",
                    "scoreInsights": {
                        "low": {
                            "title": "Your mindset score needs attention",
                            "text": "Sustained healthy behaviors reduce mortality by 66% — but sticking with them requires the readiness and grit this section measures. Tap to learn what your score means.",
                            "link": "mindset-evidence-v2.html#q1"
                        },
                        "belowAvg": {
                            "title": "Your biggest opportunity: {section}",
                            "text": "You're building awareness — now focus on {section} to unlock the next level. Every improvement here makes your other health habits more sustainable.",
                            "link": "mindset-evidence-v2.html#q8"
                        },
                        "aboveAvg": {
                            "title": "Good foundation — keep building",
                            "text": "You're above average. Strengthening {section} is your highest-leverage next step — small gains here compound across all your health behaviors.",
                            "link": "mindset-evidence-v2.html#q8"
                        },
                        "high": {
                            "title": "Strong mindset — you have the foundation",
                            "text": "Your psychological readiness makes all other health habits sustainable. Tap to see the research behind your advantage.",
                            "link": "mindset-evidence-v2.html#q2"
                        }
                    },
                    "sections": {
                        "sec1": {
                            "title": "Change Readiness",
                            "weight": 0.25,
                            "questions": [
                                {
                                    "id": "M1_1",
                                    "question": "When you think about your long-term health, which of these describe where you are?",
                                    "type": "checkbox",
                                    "scoring": "count",
                                    "helpLink": "mindset-evidence-v2.html#q3",
                                    "options": [
                                        {
                                            "value": "change_needed",
                                            "label": "Something has to change"
                                        },
                                        {
                                            "value": "my_responsibility",
                                            "label": "I'm the one who must change it"
                                        },
                                        {
                                            "value": "can_do_it",
                                            "label": "I believe I can do it"
                                        }
                                    ]
                                }
                            ]
                        },
                        "sec2": {
                            "title": "Grit",
                            "weight": 0.25,
                            "questions": [
                                {
                                    "id": "M2_1",
                                    "question": "How long have you consistently maintained your current health habits?",
                                    "type": "radio",
                                    "helpLink": "mindset-evidence-v2.html#q4",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Over 2 years",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "6 months – 2 years",
                                            "points": 7
                                        },
                                        {
                                            "value": "3",
                                            "label": "Less than 6 months",
                                            "points": 3
                                        },
                                        {
                                            "value": "0",
                                            "label": "I haven't started yet",
                                            "points": 0
                                        }
                                    ]
                                },
                                {
                                    "id": "M2_2",
                                    "question": "When you miss a workout or break a health routine, what do you typically do?",
                                    "type": "radio",
                                    "helpLink": "mindset-evidence-v2.html#q5",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Get back on track the next day",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "Resume within a few days",
                                            "points": 7
                                        },
                                        {
                                            "value": "3",
                                            "label": "It takes weeks to restart",
                                            "points": 3
                                        },
                                        {
                                            "value": "0",
                                            "label": "I usually give up",
                                            "points": 0
                                        }
                                    ]
                                }
                            ]
                        },
                        "sec3": {
                            "title": "Growth Mindset",
                            "weight": 0.25,
                            "questions": [
                                {
                                    "id": "M3_1",
                                    "question": "When you struggle with a health goal, what do you believe?",
                                    "type": "radio",
                                    "helpLink": "mindset-evidence-v2.html#q6",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "I can learn and improve with effort",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "I can improve, but it's hard to change habits",
                                            "points": 7
                                        },
                                        {
                                            "value": "3",
                                            "label": "Some things improve, but my health is mostly genetic",
                                            "points": 3
                                        },
                                        {
                                            "value": "0",
                                            "label": "My health is largely out of my control",
                                            "points": 0
                                        }
                                    ]
                                }
                            ]
                        },
                        "sec4": {
                            "title": "Preventive Health",
                            "weight": 0.25,
                            "questions": [
                                {
                                    "id": "M4_1",
                                    "question": "How do you prioritize preventive health compared to treating problems when they arise?",
                                    "type": "radio",
                                    "helpLink": "mindset-evidence-v2.html#q7",
                                    "options": [
                                        {
                                            "value": "10",
                                            "label": "Prevention is my main focus",
                                            "points": 10
                                        },
                                        {
                                            "value": "7",
                                            "label": "I try to balance both",
                                            "points": 7
                                        },
                                        {
                                            "value": "3",
                                            "label": "I mostly react when issues come up",
                                            "points": 3
                                        },
                                        {
                                            "value": "0",
                                            "label": "I only deal with health when I have to",
                                            "points": 0
                                        }
                                    ]
                                }
                            ]
                        }
                    }
                }
            };
        // __QUESTIONS_END__


        // ========================================
        // DATA MANAGEMENT
        // ========================================
        let currentData = { userName: "Alexander", answers: {}, scores: {}, previousScores: {} };
        let sessionStartScores = {}; // Baseline scores captured once when page loads
        let activeCategory = null;

        function loadData() {
            const saved = localStorage.getItem('longevityPathData');
            if (saved) {
                currentData = JSON.parse(saved);
                // Ensure previousScores and scores exist (for data saved before this update)
                if (!currentData.previousScores) currentData.previousScores = {};
                if (!currentData.scores) currentData.scores = {};
                if (!currentData.answers) currentData.answers = {};
                if (!currentData.previousAnswers) currentData.previousAnswers = {};
            }

            // Migrate MD1_age → MD1_yob for existing users
            if (currentData.answers?.medical?.sec1?.MD1_age && !currentData.answers?.medical?.sec1?.MD1_yob) {
                const oldAge = parseInt(currentData.answers.medical.sec1.MD1_age);
                currentData.answers.medical.sec1.MD1_yob = new Date().getFullYear() - oldAge;
                delete currentData.answers.medical.sec1.MD1_age;
            }

            // Always ensure all questions have default answers (handles new questions added to CATEGORIES)
            Object.keys(CATEGORIES).forEach(catKey => {
                if (!currentData.answers[catKey]) currentData.answers[catKey] = {};
                Object.keys(CATEGORIES[catKey].sections).forEach(secKey => {
                    if (!currentData.answers[catKey][secKey]) currentData.answers[catKey][secKey] = {};
                    CATEGORIES[catKey].sections[secKey].questions.forEach(q => {
                        if (currentData.answers[catKey][secKey][q.id] === undefined) {
                            if (q.type === 'slider') currentData.answers[catKey][secKey][q.id] = 1; // Start at minimum
                            else if (q.type === 'radio') currentData.answers[catKey][secKey][q.id] = null; // No selection
                            else if (q.type === 'checkbox') currentData.answers[catKey][secKey][q.id] = [];
                            else if (q.type === 'number') currentData.answers[catKey][secKey][q.id] = null;
                        }
                    });
                });
            });
            calculateAllScores();
        }

        function saveData() {
            updatePreviousAnswers();
            localStorage.setItem('longevityPathData', JSON.stringify(currentData));
        }

        // ========================================
        // SCORE CALCULATION
        // ========================================

        /**
         * Apply edge barriers to a raw 0-100 score.
         * If value is below edgeFloor → score drops linearly from 100% at edgeFloor to 0% at question.min
         * If value is above edgeCeiling → score drops linearly from 100% at edgeCeiling to 0% at question.max
         * Otherwise returns the raw score unchanged.
         */
        function applyEdgeBarriers(rawScore, value, q, genderBounds) {
            const v = parseFloat(value);
            if (isNaN(v)) return rawScore;
            // Edge floor: values too low are bad (e.g., BP < 100)
            if (q.edgeFloor !== undefined && v < q.edgeFloor) {
                const optimalLow = genderBounds ? genderBounds.inputMax : q.inputMax;
                // Score drops from 100 at edgeFloor to 0 at question.min
                const range = q.edgeFloor - q.min;
                if (range <= 0) return 0;
                return Math.max(0, Math.min(100, ((v - q.min) / range) * 100));
            }
            // Edge ceiling: values too high are bad (e.g., HDL > 120)
            if (q.edgeCeiling !== undefined && v > q.edgeCeiling) {
                const range = q.max - q.edgeCeiling;
                if (range <= 0) return 0;
                return Math.max(0, Math.min(100, ((q.max - v) / range) * 100));
            }
            return rawScore;
        }

        // ========================================
        // COACHING ENGINE
        // ========================================

        /**
         * Determine the score bucket (q1–q5) for a norm-table question.
         * Uses the same lookupNormScore() function the display uses.
         * Returns 'q1'–'q5' or null if insufficient data.
         *
         * Buckets map to Cooper percentile ranges:
         *   q1 = <25%  (Very Poor / Poor)
         *   q2 = <50%  (Fair)
         *   q3 = <75%  (Good)
         *   q4 = <97%  (Excellent)
         *   q5 = ≥97%  (Superior)
         */
        function getScoreBucket(q, value) {
            if (value === null || value === undefined || value === '') return null;
            const v = parseFloat(value);
            if (isNaN(v)) return null;

            // Norm-table questions (VO2max, push-ups, chair stand)
            if (q.normsTable) {
                const demo = getDemographics();
                if (!demo.age || !demo.sex) return null;
                const table = q.normsTable === 'VO2MAX_NORMS' ? VO2MAX_NORMS
                    : q.normsTable === 'PUSHUP_NORMS' ? PUSHUP_NORMS
                    : q.normsTable === 'CHAIRSTAND_NORMS' ? CHAIRSTAND_NORMS : null;
                if (!table) return null;
                const result = lookupNormScore(table, demo.sex, demo.age, v);
                const pct = result.score * 10; // 0–100
                if (pct < 25) return 'q1';
                if (pct < 50) return 'q2';
                if (pct < 75) return 'q3';
                if (pct < 97) return 'q4';
                return 'q5';
            }

            // Linear/gender-scored questions — use questionScorePct
            const pct = questionScorePct(q, value);
            if (pct === null) return null;
            if (pct < 25) return 'q1';
            if (pct < 50) return 'q2';
            if (pct < 75) return 'q3';
            if (pct < 97) return 'q4';
            return 'q5';
        }

        /**
         * Determine trajectory for a question by comparing current vs previous answer.
         * Uses previousAnswers from localStorage (set at end of previous session),
         * NOT keystroke-level tracking.
         * Returns 'initial' | 'improved' | 'stable' | 'declined'
         */
        function getTrajectory(qId, currentValue, previousValue) {
            if (previousValue === null || previousValue === undefined) return 'initial';
            const curr = parseFloat(currentValue);
            const prev = parseFloat(previousValue);
            if (isNaN(curr) || isNaN(prev)) return 'initial';
            const diff = curr - prev;
            // Use a small threshold (0.5) to avoid "improved" from measurement noise
            if (diff > 0.5) return 'improved';
            if (diff < -0.5) return 'declined';
            return 'stable';
        }

        /**
         * Get the coaching message for a question based on current score bucket and trajectory.
         * Returns { headline, detail } or null if no coaching data exists.
         */
        function getCoachingMessage(catKey, secKey, qId) {
            const q = CATEGORIES[catKey].sections[secKey].questions.find(x => x.id === qId);
            if (!q || !q.coaching || !q.coaching.messages) return null;

            const value = currentData.answers[catKey]?.[secKey]?.[qId];
            const bucket = getScoreBucket(q, value);
            if (!bucket) return null;

            const prevValue = currentData.previousAnswers?.[qId] ?? null;
            const trajectory = getTrajectory(qId, value, prevValue);

            const key = bucket + '_' + trajectory;
            return q.coaching.messages[key] || null;
        }

        /**
         * Build HTML for coaching message display.
         */
        function buildCoachingHTML(msg) {
            if (!msg) return '';
            return '<div class="coaching-card" style="margin-top:8px;padding:10px 12px;background:linear-gradient(135deg,#f0f9ff 0%,#e8f4f8 100%);border-radius:8px;border-left:3px solid var(--color-teal);font-size:0.82rem;">' +
                '<div style="font-weight:600;color:var(--color-text);margin-bottom:4px;display:flex;align-items:center;gap:6px;">' +
                '<span style="color:var(--color-teal);font-size:0.9rem;">✦</span> ' + msg.headline + '</div>' +
                '<div style="color:var(--color-text-muted);line-height:1.5;">' + msg.detail + '</div>' +
                '</div>';
        }

        /**
         * Update coaching display for a specific question (called after value changes).
         */
        function updateCoachingDisplay(catKey, secKey, qId) {
            const container = document.getElementById('coaching-' + qId);
            if (!container) return;
            const q = CATEGORIES[catKey].sections[secKey].questions.find(x => x.id === qId);
            if (!q || !q.coaching) return;
            const msg = getCoachingMessage(catKey, secKey, qId);
            if (msg) {
                container.innerHTML = buildCoachingHTML(msg);
            } else {
                const value = currentData.answers[catKey]?.[secKey]?.[qId];
                if (q.coaching.preScoreNudge && (value === null || value === undefined || value === '')) {
                    container.innerHTML = '<div class="coaching-nudge" style="margin-top:8px;padding:10px 12px;background:#fafafa;border-radius:8px;border-left:3px solid var(--color-amber);font-size:0.82rem;color:var(--color-text-muted);line-height:1.5;">' +
                        '<span style="color:var(--color-amber);">✦</span> ' + q.coaching.preScoreNudge + '</div>';
                } else {
                    container.innerHTML = '';
                }
            }
        }

        /**
         * Snapshot of answers at session start — used to compute previousAnswers
         * when saving. This avoids keystroke-level tracking that corrupts trajectory.
         */
        let sessionStartAnswers = {};

        /**
         * Take a flat snapshot of all current answers (called once at session start).
         * Format: { 'E1_vo2': 40, 'MD3_bp': 120, ... }
         */
        function snapshotAnswers() {
            const snap = {};
            Object.keys(CATEGORIES).forEach(catKey => {
                Object.keys(CATEGORIES[catKey].sections).forEach(secKey => {
                    const answers = currentData.answers[catKey]?.[secKey] || {};
                    CATEGORIES[catKey].sections[secKey].questions.forEach(q => {
                        const val = answers[q.id];
                        if (val !== null && val !== undefined && val !== '') {
                            snap[q.id] = val;
                        }
                    });
                });
            });
            return snap;
        }

        /**
         * Update previousAnswers from session start snapshot.
         * Called by saveData() — sets previousAnswers to the values the user had
         * when they opened the page (not intermediate keystrokes).
         */
        function updatePreviousAnswers() {
            if (!currentData.previousAnswers) currentData.previousAnswers = {};
            Object.keys(sessionStartAnswers).forEach(qId => {
                // Only overwrite if session start had a real value
                currentData.previousAnswers[qId] = sessionStartAnswers[qId];
            });
        }

        // Traffic light class: maps a 0-100 percentage to a coach color class
        function trafficClass(pct) {
            if (pct < 0) return '';
            if (pct <= 25) return 'score-red';
            if (pct < 50) return 'score-amber';
            if (pct < 75) return 'score-yellow-green';
            return 'score-green';
        }

        // Per-question score as 0-100 percentage (returns null if unanswered)
        function questionScorePct(q, value) {
            if (value === null || value === undefined || value === '') return null;
            if (q.type === 'slider') return ((parseFloat(value) - q.min) / (q.max - q.min)) * 100;
            if (q.type === 'radio' && q.options?.[0]?.points !== undefined) return (parseFloat(value) / 10) * 100;
            if (q.type === 'checkbox' && q.scoring === 'count') {
                const count = Array.isArray(value) ? value.length : 0;
                return (count / q.options.length) * 100;
            }
            if (q.type === 'checkbox' && q.scoring === 'principles') {
                const count = Array.isArray(value) ? value.length : 0;
                return (count * 2 / 10) * 100;
            }
            if (q.type === 'number' && q.inputMin !== undefined && q.inputMax !== undefined) {
                const v = parseFloat(value);
                return Math.max(0, Math.min(100, ((v - q.inputMin) / (q.inputMax - q.inputMin)) * 100));
            }
            if (q.type === 'number' && q.genderScoring) {
                const v = parseFloat(value);
                const sex = getDemographics().sex || 'male';
                const bounds = q.genderScoring[sex] || q.genderScoring['male'];
                return Math.max(0, Math.min(100, ((v - bounds.inputMin) / (bounds.inputMax - bounds.inputMin)) * 100));
            }
            return null;
        }

        function calculateSectionScore(catKey, secKey) {
            const section = CATEGORIES[catKey].sections[secKey];
            const answers = currentData.answers[catKey]?.[secKey] || {};
            let totalScore = 0, maxScore = 0;
            const demo = getDemographics();

            // Dynamic screening section: score = completed / total relevant
            if (section.dynamic === 'screenings') {
                const screenings = getRelevantScreenings(demo.country, demo.age, demo.sex, demo.smoking);
                if (screenings.length === 0) return 0;
                const completed = screenings.filter(s => {
                    const val = answers['screen_' + s.id];
                    return Array.isArray(val) && val.length > 0;
                }).length;
                return (completed / screenings.length) * 10;
            }

            section.questions.forEach(q => {
                const value = answers[q.id];
                if (q.type === 'slider') {
                    totalScore += (parseFloat(value) || q.min) - 1;
                    maxScore += 9;
                } else if (q.type === 'radio' && q.options?.[0]?.points !== undefined) {
                    totalScore += value !== null ? (parseFloat(value) || 0) : 0;
                    maxScore += 10;
                } else if (q.type === 'checkbox' && q.scoring === 'count') {
                    const count = Array.isArray(value) ? value.length : 0;
                    totalScore += (count / q.options.length) * 10;
                    maxScore += 10;
                } else if (q.type === 'checkbox' && q.scoring === 'principles') {
                    const count = Array.isArray(value) ? value.length : 0;
                    totalScore += count * 2;
                    maxScore += 10;
                } else if (q.type === 'number' && q.normsTable) {
                    // Age-gated question: skip entirely if under minimum age
                    if (q.ageMin && demo.age !== null && demo.age < q.ageMin) return;
                    if (q.ageMin && demo.age === null) return; // Can't evaluate without age
                    const table = q.normsTable === 'VO2MAX_NORMS' ? VO2MAX_NORMS : q.normsTable === 'PUSHUP_NORMS' ? PUSHUP_NORMS : q.normsTable === 'CHAIRSTAND_NORMS' ? CHAIRSTAND_NORMS : null;
                    if (table && value !== null && value !== undefined && value !== '') {
                        const result = lookupNormScore(table, demo.sex, demo.age, parseFloat(value));
                        totalScore += result.score;
                        maxScore += 10; // Only count answered tests toward max
                    }
                } else if (q.type === 'number' && q.inputMin !== undefined && q.inputMax !== undefined) {
                    // Linear scoring for 0-100 inputs (e.g. wearable sleep score)
                    if (value !== null && value !== undefined && value !== '') {
                        const v = parseFloat(value);
                        const score = ((v - q.inputMin) / (q.inputMax - q.inputMin)) * 10;
                        totalScore += Math.max(0, Math.min(10, score));
                        maxScore += 10; // Only count if answered
                    }
                } else if (q.type === 'number' && q.genderScoring) {
                    // Gender-specific linear scoring (e.g. HDL, waist-to-hip ratio)
                    if (value !== null && value !== undefined && value !== '') {
                        const v = parseFloat(value);
                        const sex = demo.sex || 'male';
                        const bounds = q.genderScoring[sex] || q.genderScoring['male'];
                        const score = ((v - bounds.inputMin) / (bounds.inputMax - bounds.inputMin)) * 10;
                        totalScore += Math.max(0, Math.min(10, score));
                        maxScore += 10;
                    }
                }
                // radio without points (sex, method) and number without normsTable/inputRange (age) are skipped
            });
            return maxScore > 0 ? (totalScore / maxScore) * 10 : 0;
        }

        function calculateSubScore(catKey, secKey, subType) {
            // subType = 'cardiovascular' or 'metabolic'
            const section = CATEGORIES[catKey].sections[secKey];
            const answers = currentData.answers[catKey]?.[secKey] || {};
            const demo = getDemographics();
            const weightKey = subType + 'Weight'; // e.g. 'cardiovascularWeight'
            let weightedTotal = 0, sumWeights = 0;

            section.questions.forEach(q => {
                const w = q[weightKey];
                if (!w) return; // weight is 0 or undefined → skip
                const value = answers[q.id];
                if (value === null || value === undefined || value === '') return;

                // Skip out-of-range values entirely — don't let them affect score
                if (q.type === 'number') {
                    const v = parseFloat(value);
                    if (isNaN(v) || v < q.min || v > q.max) return;
                }

                let raw = null; // 0-100 scale
                let genderBounds = null;
                if (q.type === 'number' && q.genderScoring) {
                    const v = parseFloat(value);
                    const sex = demo.sex || 'male';
                    genderBounds = q.genderScoring[sex] || q.genderScoring['male'];
                    raw = Math.max(0, Math.min(100, ((v - genderBounds.inputMin) / (genderBounds.inputMax - genderBounds.inputMin)) * 100));
                } else if (q.type === 'number' && q.inputMin !== undefined && q.inputMax !== undefined) {
                    const v = parseFloat(value);
                    raw = Math.max(0, Math.min(100, ((v - q.inputMin) / (q.inputMax - q.inputMin)) * 100));
                }
                if (raw !== null) {
                    raw = applyEdgeBarriers(raw, value, q, genderBounds);
                    weightedTotal += raw * w;
                    sumWeights += w;
                }
            });
            const bloodMarkerScore = sumWeights > 0 ? weightedTotal / sumWeights : -1;

            // Attia's 4 causal drivers of ASCVD — equal 25% each:
            // 1. ApoB-containing lipoproteins (ApoB, Lp(a))
            // 2. Hypertension (systolic BP)
            // 3. Smoking
            // 4. Metabolic health (HDL, Trig, Insulin, Glucose)
            if (subType === 'cardiovascular') {
                const answers_sec = currentData.answers[catKey]?.[secKey] || {};
                const demo = getDemographics();

                // --- Driver 1: Lipoproteins (ApoB + Lp(a)) ---
                let lipoScore = null, lipoW = 0;
                const apobVal = parseFloat(answers_sec['MD3_apob']);
                if (!isNaN(apobVal)) {
                    const q = section.questions.find(q => q.id === 'MD3_apob');
                    if (apobVal >= q.min && apobVal <= q.max) {
                        let s = Math.max(0, Math.min(100, ((apobVal - q.inputMin) / (q.inputMax - q.inputMin)) * 100));
                        s = applyEdgeBarriers(s, apobVal, q, null);
                        lipoScore = (lipoScore || 0) + s * 0.65;
                        lipoW += 0.65;
                    }
                }
                const lpaVal = parseFloat(answers_sec['MD3_lpa']);
                if (!isNaN(lpaVal)) {
                    const q = section.questions.find(q => q.id === 'MD3_lpa');
                    if (lpaVal >= q.min && lpaVal <= q.max) {
                        let s = Math.max(0, Math.min(100, ((lpaVal - q.inputMin) / (q.inputMax - q.inputMin)) * 100));
                        s = applyEdgeBarriers(s, lpaVal, q, null);
                        lipoScore = (lipoScore || 0) + s * 0.35;
                        lipoW += 0.35;
                    }
                }
                if (lipoW > 0) lipoScore = lipoScore / lipoW;

                // --- Driver 2: Hypertension (BP) ---
                let bpScore = null;
                const bpVal = parseFloat(answers_sec['MD3_bp']);
                if (!isNaN(bpVal)) {
                    const q = section.questions.find(q => q.id === 'MD3_bp');
                    if (bpVal >= q.min && bpVal <= q.max) {
                        bpScore = Math.max(0, Math.min(100, ((bpVal - q.inputMin) / (q.inputMax - q.inputMin)) * 100));
                        bpScore = applyEdgeBarriers(bpScore, bpVal, q, null);
                    }
                }

                // --- Driver 3: Smoking ---
                const smoking = currentData.answers?.medical?.sec1?.MD1_smoking;
                let smokingScore = null;
                if (smoking === 'never')   smokingScore = 100;
                else if (smoking === 'former')  smokingScore = 60;
                else if (smoking === 'current') smokingScore = 0;

                // --- Driver 4: Metabolic health (HDL, Trig, Insulin, Glucose) ---
                const metabScore = calculateSubScore(catKey, secKey, 'metabolic');
                const metabFinal = metabScore >= 0 ? metabScore : null;

                // Blend available drivers with equal weight (25% each)
                let blended = 0, totalWeight = 0;
                if (lipoScore !== null)   { blended += lipoScore * 0.25;   totalWeight += 0.25; }
                if (bpScore !== null)     { blended += bpScore * 0.25;     totalWeight += 0.25; }
                if (smokingScore !== null) { blended += smokingScore * 0.25; totalWeight += 0.25; }
                if (metabFinal !== null)  { blended += metabFinal * 0.25;  totalWeight += 0.25; }

                if (totalWeight > 0) return blended / totalWeight;
                return -1;
            }

            return bloodMarkerScore; // -1 means no data
        }

        function calculateCategoryScore(catKey) {
            const category = CATEGORIES[catKey];
            let weightedSum = 0, totalWeight = 0;
            Object.keys(category.sections).forEach(secKey => {
                const section = category.sections[secKey];
                const secScore = calculateSectionScore(catKey, secKey);
                // Only count section if it has at least one answered question
                if (sectionHasAnswers(catKey, secKey)) {
                    weightedSum += secScore * section.weight;
                    totalWeight += section.weight;
                }
            });
            return totalWeight > 0 ? weightedSum / totalWeight : 0;
        }

        function sectionHasAnswers(catKey, secKey) {
            const section = CATEGORIES[catKey].sections[secKey];
            const answers = currentData.answers[catKey]?.[secKey] || {};

            // Dynamic screening section: check if any screening checkbox is checked
            if (section.dynamic === 'screenings') {
                const demo = getDemographics();
                const screenings = getRelevantScreenings(demo.country, demo.age, demo.sex, demo.smoking);
                return screenings.some(s => {
                    const v = answers['screen_' + s.id];
                    return Array.isArray(v) && v.length > 0;
                });
            }

            return section.questions.some(q => {
                const v = answers[q.id];
                if (q.type === 'number') return v !== null && v !== undefined && v !== '';
                if (q.type === 'radio') return v !== null;
                if (q.type === 'slider') return true; // sliders always have a value (min default)
                if (q.type === 'checkbox') return Array.isArray(v) && v.length > 0;
                return false;
            });
        }

        function calculateAllScores() {
            Object.keys(CATEGORIES).forEach(catKey => {
                currentData.scores[catKey] = Math.round(calculateCategoryScore(catKey) * 10) / 10;
            });
        }

        function getTotalScore() {
            const scores = Object.values(currentData.scores);
            return scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length * 10) : 0;
        }

        // ========================================
        // RENDER FUNCTIONS
        // ========================================
        function renderDimensions() {
            const container = document.getElementById('dimensionsList');
            container.innerHTML = '';
            Object.entries(CATEGORIES).forEach(([key, cat]) => {
                const score = currentData.scores[key] || 0;
                const score100 = Math.round(score * 10);
                // Use session start scores for accurate change tracking
                const baselineScore = sessionStartScores[key];
                const hasBaseline = baselineScore !== undefined && baselineScore !== null;
                const baselineScore100 = hasBaseline ? Math.round(baselineScore * 10) : 0;
                const trend = score100 - baselineScore100;
                const trendClass = trend > 0 ? 'trend-up' : trend < 0 ? 'trend-down' : 'trend-neutral';
                const trendIcon = trend > 0 ? 'trending-up' : trend < 0 ? 'trending-down' : '';
                const trendText = trend !== 0 ? (trend > 0 ? `+${trend}` : `${trend}`) : '—';

                container.innerHTML += `
                    <div class="dimension-card" onclick="openDimension('${key}')">
                        <div class="dimension-icon"><i data-lucide="${cat.icon}" style="width:22px;height:22px;"></i></div>
                        <div class="dimension-info"><div class="dimension-name">${cat.name}</div></div>
                        <div class="dimension-score">
                            <span class="dimension-score-value">${score100}</span>
                            <span class="dimension-score-max">/100</span>
                            <span class="dimension-trend ${trendClass}">${trendIcon ? `<i data-lucide="${trendIcon}" style="width:14px;height:14px;"></i>` : ''} ${trendText}</span>
                        </div>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        function updateTotalScore() {
            const total = getTotalScore();
            document.getElementById('totalScoreValue').textContent = total;
            const circumference = 2 * Math.PI * 78;
            document.getElementById('scoreRingProgress').style.strokeDashoffset = circumference - (total / 100) * circumference;

            // Show/hide CTA card based on score
            const ctaCard = document.getElementById('ctaCard');
            ctaCard.style.display = total <= 5 ? 'block' : 'none';
        }

        // ========================================
        // TAB NAVIGATION
        // ========================================
        function showTab(tabName, btn) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            btn.classList.add('active');
        }

        // ========================================
        // HELP-LINK SCROLL STATE (back-button restore)
        // ========================================
        function saveScrollState(event) {
            const state = {
                category: activeCategory,
                scrollY: window.scrollY,
                detailScrollY: document.getElementById('detailView') ? document.getElementById('detailView').scrollTop : 0
            };
            sessionStorage.setItem('helpLinkReturn', JSON.stringify(state));
            // Let the default <a> navigation proceed
        }

        function restoreScrollState() {
            const saved = sessionStorage.getItem('helpLinkReturn');
            if (!saved) return;
            sessionStorage.removeItem('helpLinkReturn');
            try {
                const state = JSON.parse(saved);
                if (state.category) {
                    openDimension(state.category);
                    requestAnimationFrame(() => {
                        const detailView = document.getElementById('detailView');
                        if (detailView && state.detailScrollY) {
                            detailView.scrollTop = state.detailScrollY;
                        }
                        window.scrollTo(0, state.scrollY || 0);
                    });
                }
            } catch(e) { /* ignore parse errors */ }
        }

        // ========================================
        // DETAIL VIEW & ASSESSMENT
        // ========================================
        function openDimension(key) {
            activeCategory = key;
            const cat = CATEGORIES[key];
            document.getElementById('detailTitle').textContent = cat.name;
            renderCategoryContent(key);
            document.getElementById('detailView').classList.add('active');
        }

        function closeDetailView() {
            activeCategory = null;
            document.getElementById('detailView').classList.remove('active');
        }

        function renderCategoryContent(catKey) {
            const category = CATEGORIES[catKey];
            const content = document.getElementById('detailContent');
            content.innerHTML = '';

            // Category total score with change (using session baseline)
            const score = currentData.scores[catKey] || 0;
            const score100 = Math.round(score * 10);
            const baselineScore = sessionStartScores[catKey];
            const baselineScore100 = (baselineScore !== undefined && baselineScore !== null) ? Math.round(baselineScore * 10) : 0;
            const trend = score100 - baselineScore100;
            const trendClass = trend > 0 ? 'trend-up' : trend < 0 ? 'trend-down' : 'trend-neutral';
            const trendIcon = trend > 0 ? 'trending-up' : trend < 0 ? 'trending-down' : '';
            const trendText = trend !== 0 ? (trend > 0 ? `+${trend}` : `${trend}`) : '';

            // Traffic light ring color based on score
            const ringColor = score100 <= 0 ? 'var(--color-border)' : score100 <= 25 ? '#d32f2f' : score100 < 50 ? '#f57c00' : score100 < 75 ? '#7cb342' : '#43a047';
            const catCircumference = 2 * Math.PI * 54;
            const catDashoffset = catCircumference - (score100 / 100) * catCircumference;

            content.innerHTML += `
                <div class="category-score-header" style="text-align:center;padding:20px 16px;margin-bottom:20px;background:var(--color-card);border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                    <div style="position:relative;width:120px;height:120px;margin:0 auto 12px;">
                        <svg width="120" height="120" viewBox="0 0 120 120" style="transform:rotate(-90deg);">
                            <circle cx="60" cy="60" r="54" fill="none" stroke="var(--color-border)" stroke-width="8"/>
                            <circle id="catScoreRing" cx="60" cy="60" r="54" fill="none" stroke="${ringColor}" stroke-width="8" stroke-linecap="round" stroke-dasharray="${catCircumference}" stroke-dashoffset="${catDashoffset}" style="transition:stroke-dashoffset 1s ease-out,stroke 0.5s ease;"/>
                        </svg>
                        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;">
                            <div style="font-size:1.8rem;font-weight:700;color:var(--color-text);line-height:1;"><span id="catScoreValue">${score100}</span></div>
                            <div style="font-size:0.7rem;color:var(--color-text-muted);">/100</div>
                        </div>
                    </div>
                    <div style="font-size:0.9rem;color:var(--color-text-muted);">Total ${category.name} Score</div>
                    ${trend !== 0 ? `<div class="dimension-trend ${trendClass}" style="margin-top:8px;font-size:0.85rem;display:inline-flex;align-items:center;gap:4px;"><i data-lucide="${trendIcon}" style="width:16px;height:16px;"></i> ${trendText}</div>` : ''}
                </div>
            `;

            // Show EITHER motivating CTA (when not started) OR Section Breakdown (when started)
            if (score100 === 0) {
                // Show CTA when category is not started
                const ctaMessages = {
                    medical: { title: "Know your numbers", text: "Enter your profile and see which health screenings are recommended for your age, sex, and healthcare system — then track which you've completed." },
                    nutrition: { title: "How well does your diet support longevity?", text: "Just 2 minutes. Discover your nutrition strengths and find easy wins for a healthier life." },
                    energy: { title: "Measure your fitness for longevity", text: "Enter your VO2max and test your strength. These are among the most powerful predictors of how long and how well you'll live." },
                    sleep: { title: "Sleep is your superpower", text: "Assess your sleep duration, regularity, and quality — the three pillars of restorative sleep. Optionally add your wearable sleep score." },
                    wellbeing: { title: "Measure what matters most", text: "Based on Seligman's PERMA framework. Assess your positive emotions, engagement, relationships, meaning, accomplishment, and stress balance — all linked to longevity." },
                    mindset: { title: "Your mindset shapes your health", text: "Just 1 minute. Assess your change readiness, grit, growth mindset, and commitment to prevention — the psychological drivers of lasting health behavior." }
                };
                const cta = ctaMessages[catKey] || { title: "Get started", text: "Answer a few questions to see your score." };
                content.innerHTML += `
                    <div class="detail-cta">
                        <div class="detail-cta-title"><i data-lucide="lightbulb" style="width:18px;height:18px;"></i> ${cta.title}</div>
                        <div class="detail-cta-text">${cta.text}</div>
                        <div style="margin-top:12px;font-size:0.8rem;color:var(--color-text-muted);line-height:1.5;">
                            Curious about the science? Tap the <span style="display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;background:var(--color-teal);color:white;border-radius:50%;font-size:0.55rem;font-weight:700;vertical-align:middle;">?</span> icons for research-backed insights.
                        </div>
                    </div>
                `;
            } else {
                // Show Section Breakdown when assessment has started
                let breakdownHTML = `<div class="section-breakdown">
                    <div class="section-breakdown-title">Section Breakdown</div>`;

                let secNumber = 0;
                Object.keys(category.sections).forEach(secKey => {
                    const section = category.sections[secKey];
                    const sectionScore = calculateSectionScore(catKey, secKey);
                    const weightedMax = section.weight * 10;
                    const weightedScore = (sectionScore / 10) * weightedMax;
                    const percentage = (sectionScore / 10) * 100;
                    secNumber++;

                    // Determine badge: "Room to grow" if low score
                    const badge = percentage > 0 && percentage <= 25 ? '<span class="room-to-grow">Room to grow</span>' : '';

                    breakdownHTML += `
                        <div class="section-breakdown-item">
                            <span class="section-breakdown-number">${secNumber}</span>
                            <div class="section-breakdown-info">
                                <div class="section-breakdown-name">
                                    ${section.title}
                                    ${badge}
                                </div>
                                <div class="section-breakdown-bar">
                                    <div class="section-breakdown-fill" id="secFill-${secKey}" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                            <div class="section-breakdown-score" id="secBreakScore-${secKey}">${Math.round(percentage)}%</div>
                        </div>`;

                    // Render sub-scores (Cardiovascular / Metabolic) if section defines them
                    if (section.subScores) {
                        breakdownHTML += `<div class="subscore-group">`;
                        Object.keys(section.subScores).forEach(subKey => {
                            const sub = section.subScores[subKey];
                            const subPct = calculateSubScore(catKey, secKey, subKey);
                            const hasData = subPct >= 0;
                            const displayPct = hasData ? Math.round(subPct) : 0;
                            const iconName = sub.icon || 'activity';
                            const fillClass = subKey === 'cardiovascular' ? 'cardio' : 'metabolic';
                            const label = hasData ? `${displayPct}%` : '—';
                            const helpBadge = sub.helpLink ? `<a href="${sub.helpLink}" class="help-link" onclick="saveScrollState(event)" title="Evidence & FAQ">?</a>` : '';

                            breakdownHTML += `
                                <div class="subscore-item">
                                    <i data-lucide="${iconName}" class="subscore-icon"></i>
                                    <div class="subscore-info">
                                        <div class="subscore-name">${sub.label} ${helpBadge}</div>
                                        <div class="subscore-bar">
                                            <div class="subscore-fill ${fillClass}" style="width: ${displayPct}%"></div>
                                        </div>
                                    </div>
                                    <div class="subscore-score">${label}</div>
                                </div>`;
                        });
                        breakdownHTML += `</div>`;
                    }
                });
                breakdownHTML += `</div>`;
                content.innerHTML += breakdownHTML;

                // Score-based insight card (shows after completing assessment)
                if (category.scoreInsights) {
                    const pct = score100;
                    let insight = null;
                    let insightStyle = {};

                    // Find weakest subsection for dynamic middle-range messages
                    let weakestSec = null, weakestScore = Infinity;
                    Object.keys(category.sections).forEach(sk => {
                        const ss = calculateSectionScore(catKey, sk);
                        if (ss < weakestScore) { weakestScore = ss; weakestSec = { key: sk, title: category.sections[sk].title, score: ss }; }
                    });

                    // Traffic light colors: red (<25%), amber (25-49%), yellow-green (50-74%), green (75%+)
                    const trafficColors = {
                        red: { bg: '#fce4ec', border: '#e57373', dot: '#d32f2f' },
                        amber: { bg: '#fff3e0', border: '#ffb74d', dot: '#f57c00' },
                        yellowGreen: { bg: '#f1f8e9', border: '#aed581', dot: '#7cb342' },
                        green: { bg: '#e8f5e9', border: '#81c784', dot: '#43a047' }
                    };

                    if (pct > 0 && pct <= 25 && category.scoreInsights.low) {
                        insight = category.scoreInsights.low;
                        insightStyle = trafficColors.red;
                    } else if (pct > 25 && pct < 50 && category.scoreInsights.belowAvg) {
                        const tpl = category.scoreInsights.belowAvg;
                        insight = { title: tpl.title, text: tpl.text.replace('{section}', weakestSec ? weakestSec.title : 'one area'), link: tpl.link };
                        insightStyle = trafficColors.amber;
                    } else if (pct >= 50 && pct < 75 && category.scoreInsights.aboveAvg) {
                        const tpl = category.scoreInsights.aboveAvg;
                        insight = { title: tpl.title, text: tpl.text.replace('{section}', weakestSec ? weakestSec.title : 'one area'), link: tpl.link };
                        insightStyle = trafficColors.yellowGreen;
                    } else if (pct >= 75 && category.scoreInsights.high) {
                        insight = category.scoreInsights.high;
                        insightStyle = trafficColors.green;
                    }

                    if (insight) {
                        content.innerHTML += `
                            <a href="${insight.link}" class="score-insight-card" onclick="saveScrollState(event)" style="display:block;margin-bottom:20px;padding:14px 16px;background:${insightStyle.bg};border-radius:10px;border:1px solid ${insightStyle.border};text-decoration:none;color:var(--color-text);">
                                <div style="font-weight:600;font-size:0.9rem;margin-bottom:6px;display:flex;align-items:center;gap:8px;">
                                    <span class="coaching-symbol">✦</span>
                                    <span>${insight.title}</span>
                                </div>
                                <div style="font-size:0.82rem;color:var(--color-text-muted);margin-left:36px;">${insight.text}</div>
                            </a>`;
                    }
                }
            }

            lucide.createIcons();

            let stepNumber = 0;
            Object.keys(category.sections).forEach(secKey => {
                const section = category.sections[secKey];
                const answers = currentData.answers[catKey]?.[secKey] || {};
                const sectionScore = calculateSectionScore(catKey, secKey);
                const weightedMax = section.weight * 10;
                const weightedScore = (sectionScore / 10) * weightedMax;
                const percentage = (sectionScore / 10) * 100;
                stepNumber++;

                const isNotStarted = sectionScore === 0;
                const secScoreClass = isNotStarted ? 'not-started' : trafficClass(percentage);

                let html = `<div class="assessment-section">
                    <div class="section-header">
                        <span class="step-number">${stepNumber}</span>
                        <span class="section-title-text">${section.title}</span>
                        <span class="section-score-weighted ${secScoreClass}" id="secScore-${secKey}">
                            <span class="current">${Math.round(percentage)}%</span>
                        </span>
                    </div>`;

                if (section.link) {
                    html += `<div class="intro-section">
                        ${section.description ? `<p>${section.description}</p>` : ''}
                        <a href="${section.link.url}" class="intro-link">${section.link.text}</a>
                    </div>`;
                } else if (section.description) {
                    html += `<p style="font-size:0.85rem;color:var(--color-text-muted);margin-bottom:16px;">${section.description}</p>`;
                }

                // Dynamic screening section: render checkboxes from SCREENING_GUIDELINES
                if (section.dynamic === 'screenings') {
                    const demo = getDemographics();
                    const screenings = getRelevantScreenings(demo.country, demo.age, demo.sex, demo.smoking);

                    if (!demo.age || !demo.sex || !demo.country) {
                        html += `<div class="demographics-prompt" style="display:flex;align-items:flex-start;gap:10px;padding:12px 16px;background:#fff8e1;border-radius:8px;margin-bottom:16px;">
                            <i data-lucide="alert-circle" style="width:18px;height:18px;flex-shrink:0;color:#f57c00;margin-top:1px;"></i>
                            <span style="font-size:0.85rem;color:var(--color-text-muted);">Complete your year of birth, sex, and healthcare system above to see personalized screening recommendations.</span>
                        </div>`;
                    } else if (screenings.length === 0) {
                        html += `<p style="font-size:0.85rem;color:var(--color-text-muted);">No screenings found for your profile. This may be a data gap — consult your healthcare provider.</p>`;
                    } else {
                        const completedCount = screenings.filter(s => { const v = answers['screen_' + s.id]; return Array.isArray(v) && v.length > 0; }).length;
                        const systemLabel = demo.country === 'de' ? 'Germany' : demo.country === 'us' ? 'United States' : demo.country === 'eu' ? 'EU' : 'Other';
                        const systemFaqLink = 'medical-evidence.html#q-system-' + demo.country;
                        html += `<div style="font-size:0.8rem;color:var(--color-text-muted);margin-bottom:12px;padding:8px 12px;background:var(--color-bg);border-radius:8px;">
                            <strong>${screenings.length} screenings</strong> recommended for your profile (age ${demo.age}, ${demo.sex}, <a href="${systemFaqLink}" onclick="saveScrollState(event)" style="color:var(--color-teal);text-decoration:underline;">${systemLabel} guidelines</a>).
                            ${completedCount > 0 ? `<br><span style="color:var(--color-teal);">✓ ${completedCount} of ${screenings.length} up to date</span>` : ''}
                        </div>`;

                        screenings.forEach(s => {
                            const qId = 'screen_' + s.id;
                            const isChecked = Array.isArray(answers[qId]) && answers[qId].length > 0;
                            const qHelpLink = s.helpLink ? `<a href="${s.helpLink}" class="help-link" onclick="saveScrollState(event)">?</a>` : '';
                            html += `<div class="question-item" style="padding:10px 0;border-bottom:1px solid var(--color-border);">
                                <div class="question-label" style="margin-bottom:2px;">${s.name}${qHelpLink}</div>
                                <div class="question-hint" style="margin-bottom:6px;">${s.desc} · <em>${s.freq}</em> · ${s.source}</div>
                                <div class="checkbox-group">
                                    <div class="checkbox-option ${isChecked ? 'selected' : ''}" onclick="toggleScreening('${catKey}','${secKey}','${qId}','done',this)">
                                        <input type="checkbox" ${isChecked ? 'checked' : ''}><label>Up to date</label>
                                    </div>
                                </div>
                            </div>`;
                        });
                    }
                    html += `</div>`;
                    content.innerHTML += html;
                    lucide.createIcons();
                    return; // Skip the regular question loop for this section
                }

                let lastGroup = null;
                section.questions.forEach(q => {
                    // Hide age-gated questions completely if user is below minimum age (or age unknown)
                    if (q.ageMin) {
                        const d = getDemographics();
                        if (d.age === null || d.age < q.ageMin) return;
                    }
                    // Group labels for blood markers
                    if (q.group && q.group !== lastGroup) {
                        lastGroup = q.group;
                        const groupLabels = {
                            'cardiovascular': 'Cardiovascular Markers',
                            'shared': 'Shared Markers (CV + Metabolic)',
                            'metabolic': 'Metabolic Markers'
                        };
                        if (groupLabels[q.group]) {
                            html += '<div style="font-size:0.82rem;font-weight:600;color:var(--color-teal);text-transform:uppercase;letter-spacing:0.05em;margin:18px 0 6px 0;padding-bottom:4px;border-bottom:1px solid rgba(0,0,0,0.08);">' + groupLabels[q.group] + '</div>';
                        }
                    }
                    const value = answers[q.id];
                    const qHelpLink = q.helpLink ? `<a href="${q.helpLink}" class="help-link" onclick="saveScrollState(event)">?</a>` : '';
                    html += `<div class="question-item"><div class="question-label">${q.question}${qHelpLink}</div>`;
                    if (q.hint) html += `<div class="question-hint">${q.hint}</div>`;

                    if (q.type === 'slider') {
                        const currentValue = value !== undefined ? value : q.min;
                        html += `<div class="slider-container">
                            <input type="range" class="slider-input" min="${q.min}" max="${q.max}" value="${currentValue}"
                                data-cat="${catKey}" data-sec="${secKey}" data-q="${q.id}" oninput="updateSlider(this)">
                            <div class="slider-value" id="val-${catKey}-${secKey}-${q.id}">${currentValue}</div>
                        </div>`;
                    } else if (q.type === 'radio') {
                        html += `<div class="radio-group">`;
                        q.options.forEach(opt => {
                            const isSelected = value !== null && value === opt.value;
                            const points = opt.points !== undefined ? `<span class="radio-points">${opt.points} pts</span>` : '';
                            const optHelp = opt.helpLink ? `<a href="${opt.helpLink}" class="help-link" onclick="event.stopPropagation();saveScrollState(event);" style="margin-left:auto;font-size:0.75rem;">?</a>` : '';
                            html += `<div class="radio-option ${isSelected ? 'selected' : ''}" onclick="selectRadio('${catKey}','${secKey}','${q.id}','${opt.value}',this)">
                                <input type="radio" ${isSelected ? 'checked' : ''}><label>${opt.label}</label>${points}${optHelp}</div>`;
                        });
                        html += `</div>`;
                    } else if (q.type === 'checkbox') {
                        html += `<div class="checkbox-group">`;
                        q.options.forEach(opt => {
                            const isSelected = Array.isArray(value) && value.includes(opt.value);
                            const evidence = opt.evidence ? `<span class="evidence-tag">${opt.evidence}</span>` : '';
                            html += `<div class="checkbox-option ${isSelected ? 'selected' : ''}" onclick="toggleCheckbox('${catKey}','${secKey}','${q.id}','${opt.value}',this)">
                                <input type="checkbox" ${isSelected ? 'checked' : ''}><label>${opt.label}</label>${evidence}</div>`;
                        });
                        html += `</div>`;
                    } else if (q.type === 'number') {
                        const currentValue = value !== null && value !== undefined ? value : '';
                        const demo = getDemographics();

                        html += '<div class="number-input-group">' +
                            '<input type="number" class="number-input" min="' + q.min + '" max="' + q.max + '" step="' + q.step + '" value="' + currentValue + '"' +
                            ' data-cat="' + catKey + '" data-sec="' + secKey + '" data-q="' + q.id + '"' +
                            ' oninput="updateNumber(this)" placeholder="Enter value">' +
                            '<span class="number-unit">' + (q.unit || '') + '</span></div>';

                        // Cooper Test calculator
                        if (q.cooperCalc) {
                            html += '<div class="cooper-calc">' +
                                '<div class="cooper-calc-title"><i data-lucide="calculator" style="width:16px;height:16px;"></i> Cooper 12-Min Run Calculator</div>' +
                                '<div class="cooper-calc-row">' +
                                '<input type="number" class="number-input" id="cooperDist" min="400" max="5000" step="1" placeholder="Distance in meters" style="flex:1;">' +
                                '<button class="cooper-calc-btn" onclick="calcCooper()">Calculate</button></div>' +
                                '<div class="cooper-calc-result" id="cooperResult"></div></div>';
                        }

                        // Linear score display for wearable-style inputs (0-100 → 0-100%)
                        if (q.inputMin !== undefined && q.inputMax !== undefined && !q.normsTable) {
                            html += '<div id="normRating-' + q.id + '">';
                            if (currentValue !== '' && currentValue !== null) {
                                const v = parseFloat(currentValue);
                                // Out-of-range check
                                if (v < q.min || v > q.max) {
                                    html += '<div class="norm-rating" style="color:var(--color-red);"><i data-lucide="alert-triangle" style="width:14px;height:14px;"></i> Value out of possible range (' + q.min + '–' + q.max + ' ' + (q.unit||'') + ')</div>';
                                } else {
                                    let pct = Math.round(((v - q.inputMin) / (q.inputMax - q.inputMin)) * 100);
                                    pct = Math.max(0, Math.min(100, pct));
                                    pct = Math.round(applyEdgeBarriers(pct, v, q, null));
                                    html += '<div class="norm-rating"><span class="norm-category">Score: ' + pct + '%</span></div>';
                                    // Edge barrier warning
                                    if (q.edgeFloor !== undefined && v < q.edgeFloor) {
                                        html += '<div class="norm-rating" style="color:var(--color-amber);font-size:0.82rem;margin-top:2px;"><i data-lucide="alert-circle" style="width:13px;height:13px;"></i> ' + q.edgeFloorLabel + '</div>';
                                    }
                                    if (q.edgeCeiling !== undefined && v > q.edgeCeiling) {
                                        html += '<div class="norm-rating" style="color:var(--color-amber);font-size:0.82rem;margin-top:2px;"><i data-lucide="alert-circle" style="width:13px;height:13px;"></i> ' + q.edgeCeilingLabel + '</div>';
                                    }
                                }
                            }
                            html += '</div>';
                        }

                        // Gender-specific linear score display (e.g. HDL, WHR)
                        if (q.genderScoring) {
                            html += '<div id="normRating-' + q.id + '">';
                            if (currentValue !== '' && currentValue !== null && demo.sex) {
                                const v = parseFloat(currentValue);
                                // Out-of-range check
                                if (v < q.min || v > q.max) {
                                    html += '<div class="norm-rating" style="color:var(--color-red);"><i data-lucide="alert-triangle" style="width:14px;height:14px;"></i> Value out of possible range (' + q.min + '–' + q.max + ' ' + (q.unit||'') + ')</div>';
                                } else {
                                    const bounds = q.genderScoring[demo.sex] || q.genderScoring['male'];
                                    let pct = Math.round(((v - bounds.inputMin) / (bounds.inputMax - bounds.inputMin)) * 100);
                                    pct = Math.max(0, Math.min(100, pct));
                                    pct = Math.round(applyEdgeBarriers(pct, v, q, bounds));
                                    html += '<div class="norm-rating"><span class="norm-category">Score: ' + pct + '%</span></div>';
                                    // Edge barrier warning
                                    if (q.edgeCeiling !== undefined && v > q.edgeCeiling) {
                                        html += '<div class="norm-rating" style="color:var(--color-amber);font-size:0.82rem;margin-top:2px;"><i data-lucide="alert-circle" style="width:13px;height:13px;"></i> ' + q.edgeCeilingLabel + '</div>';
                                    }
                                }
                            } else if (!demo.sex) {
                                html += '<div class="demographics-prompt"><i data-lucide="alert-circle" style="width:16px;height:16px;flex-shrink:0;"></i> Enter your biological sex in the Medical section to see your personalized rating.</div>';
                            }
                            html += '</div>';
                        }

                        // Norm rating container (updated in-place by updateNormDisplay)
                        if (q.normsTable) {
                            html += '<div id="normRating-' + q.id + '">';
                            if (currentValue !== '' && demo.age !== null && demo.sex) {
                                const table = q.normsTable === 'VO2MAX_NORMS' ? VO2MAX_NORMS : q.normsTable === 'PUSHUP_NORMS' ? PUSHUP_NORMS : q.normsTable === 'CHAIRSTAND_NORMS' ? CHAIRSTAND_NORMS : null;
                                if (table) {
                                    html += buildNormRatingHTML(q, table, demo, currentValue);
                                }
                            } else if (demo.age === null || !demo.sex) {
                                html += '<div class="demographics-prompt"><i data-lucide="alert-circle" style="width:16px;height:16px;flex-shrink:0;"></i> Enter your year of birth and sex in the Medical section to see your personalized rating.</div>';
                            }
                            html += '</div>';
                        }

                        // Coaching will be in a separate Coach view — not in the score section
                    }
                    html += `</div>`;
                });

                if (section.footerLink) {
                    html += `<div class="intro-section" style="margin-top:12px;">
                        ${section.footerLink.description ? `<p>${section.footerLink.description}</p>` : ''}
                        <a href="${section.footerLink.url}" class="intro-link">${section.footerLink.text}</a>
                    </div>`;
                }

                html += `</div>`;
                content.innerHTML += html;
            });

            // Bottom CTAs (show when user has answered at least one question)
            const catScore = currentData.scores[catKey] || 0;
            if (catScore > 0) {
                const isBelow50 = Math.round(catScore * 10) < 50;
                const upgradeTitle = isBelow50
                    ? 'Start your health journey'
                    : 'Take your health to the next level';
                const upgradeText = isBelow50
                    ? 'Get personalized coaching based on your scores. Your AI health coach identifies your barriers and builds a step-by-step plan to develop healthier habits.'
                    : 'You\'re building strong habits. A personalized coaching plan helps you optimize further and stay consistent — even through life\'s disruptions.';

                content.innerHTML += `
                    <div style="margin-top:28px;display:flex;flex-direction:column;gap:12px;">
                        <!-- Upgrade CTA -->
                        <a href="#" style="display:block;padding:18px;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);border-radius:14px;text-decoration:none;color:white;border:1px solid rgba(255,255,255,0.1);">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                                <span class="coaching-symbol">✦</span>
                                <span style="font-weight:700;font-size:0.95rem;">${upgradeTitle}</span>
                            </div>
                            <div style="font-size:0.82rem;color:rgba(255,255,255,0.7);margin-bottom:14px;">${upgradeText}</div>
                            <div style="display:flex;flex-wrap:wrap;gap:8px;">
                                <span style="display:inline-flex;align-items:center;gap:4px;padding:8px 14px;background:var(--color-orange);border-radius:8px;font-size:0.82rem;font-weight:600;color:white;">
                                    Download App
                                </span>
                                <span style="display:inline-flex;align-items:center;gap:4px;padding:8px 14px;background:rgba(255,255,255,0.12);border-radius:8px;font-size:0.82rem;color:rgba(255,255,255,0.85);border:1px solid rgba(255,255,255,0.2);">
                                    from $9.99/month
                                </span>
                            </div>
                        </a>

                        <!-- Share CTA -->
                        <a href="#" onclick="shareAssessment(event)" style="display:flex;align-items:center;gap:12px;padding:14px 16px;background:var(--color-card);border-radius:12px;text-decoration:none;color:var(--color-text);border:1px solid var(--color-border);">
                            <span style="display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:50%;background:var(--color-orange);flex-shrink:0;">
                                <i data-lucide="share-2" style="width:18px;height:18px;color:white;"></i>
                            </span>
                            <div>
                                <div style="font-weight:600;font-size:0.9rem;">Invite others to take the test</div>
                                <div style="font-size:0.78rem;color:var(--color-text-muted);">Help someone you care about discover their health score</div>
                            </div>
                        </a>
                    </div>`;

                lucide.createIcons();
            }
        }

        // ========================================
        // EVENT HANDLERS
        // ========================================
        function shareAssessment(event) {
            event.preventDefault();
            const shareUrl = window.location.origin + window.location.pathname;
            const shareText = 'Discover your longevity score — a free, science-backed health assessment covering nutrition, fitness, sleep, wellbeing, and mindset.';
            if (navigator.share) {
                navigator.share({ title: 'LongevityPath Assessment', text: shareText, url: shareUrl });
            } else if (navigator.clipboard) {
                navigator.clipboard.writeText(shareUrl).then(() => {
                    const btn = event.currentTarget;
                    const origText = btn.querySelector('div > div:first-child').textContent;
                    btn.querySelector('div > div:first-child').textContent = 'Link copied!';
                    setTimeout(() => { btn.querySelector('div > div:first-child').textContent = origText; }, 2000);
                });
            }
        }

        function updateSlider(el) {
            const { cat, sec, q } = el.dataset;
            document.getElementById(`val-${cat}-${sec}-${q}`).textContent = el.value;
            currentData.answers[cat][sec][q] = parseFloat(el.value);
            updateScoresAndUI();
        }

        function selectRadio(catKey, secKey, qId, value, el) {
            el.parentElement.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            el.querySelector('input').checked = true;
            currentData.answers[catKey][secKey][qId] = value;
            updateScoresAndUI();
        }

        function toggleCheckbox(catKey, secKey, qId, value, el) {
            const checkbox = el.querySelector('input');
            checkbox.checked = !checkbox.checked;
            el.classList.toggle('selected', checkbox.checked);
            if (!Array.isArray(currentData.answers[catKey][secKey][qId])) currentData.answers[catKey][secKey][qId] = [];
            if (checkbox.checked) currentData.answers[catKey][secKey][qId].push(value);
            else currentData.answers[catKey][secKey][qId] = currentData.answers[catKey][secKey][qId].filter(v => v !== value);
            updateScoresAndUI();
        }

        function toggleScreening(catKey, secKey, qId, value, el) {
            const checkbox = el.querySelector('input');
            checkbox.checked = !checkbox.checked;
            el.classList.toggle('selected', checkbox.checked);
            // Ensure sec2 answers object exists for dynamic screenings
            if (!currentData.answers[catKey]) currentData.answers[catKey] = {};
            if (!currentData.answers[catKey][secKey]) currentData.answers[catKey][secKey] = {};
            if (checkbox.checked) currentData.answers[catKey][secKey][qId] = [value];
            else currentData.answers[catKey][secKey][qId] = [];
            updateScoresAndUI();
        }

        function toggleHabit(el) {
            el.classList.toggle('checked');
            const icon = el.querySelector('i');
            icon.style.display = el.classList.contains('checked') ? 'block' : 'none';
        }

        function updateNumber(el) {
            const { cat, sec, q } = el.dataset;
            const val = el.value === '' ? null : parseFloat(el.value);
            const prevScore100 = Math.round((currentData.scores[cat] || 0) * 10);
            currentData.answers[cat][sec][q] = val;
            updateScoresAndUI(true); // skip full detail re-render
            const newScore100 = Math.round((currentData.scores[cat] || 0) * 10);
            // Layout change (CTA↔breakdown): need full re-render with scroll restore
            if ((prevScore100 === 0) !== (newScore100 === 0) && activeCategory) {
                const dv = document.getElementById('detailView');
                const st = dv.scrollTop;
                renderCategoryContent(activeCategory);
                requestAnimationFrame(() => { dv.scrollTop = st; });
            } else {
                updateDetailScoresInPlace(cat);
                updateNormDisplay(cat, sec, q);
            }
        }

        function calcCooper() {
            const dist = parseFloat(document.getElementById('cooperDist').value);
            if (!dist || dist < 400) { document.getElementById('cooperResult').style.display = 'block'; document.getElementById('cooperResult').textContent = 'Enter a valid distance (400-5000m)'; return; }
            const vo2 = Math.round(((dist - 504.9) / 44.73) * 10) / 10;
            document.getElementById('cooperResult').style.display = 'block';
            document.getElementById('cooperResult').innerHTML = 'Estimated VO2max: <strong>' + vo2 + ' ml/kg/min</strong>';
            // Auto-fill the VO2max input
            const vo2Input = document.querySelector('[data-q="E1_vo2"]');
            if (vo2Input) { vo2Input.value = vo2; updateNumber(vo2Input); }
        }

        // In-place score update (no DOM rebuild — keeps inputs, focus, scroll)
        function updateDetailScoresInPlace(catKey) {
            const category = CATEGORIES[catKey];
            const score = currentData.scores[catKey] || 0;
            const score100 = Math.round(score * 10);
            const catEl = document.getElementById('catScoreValue');
            if (catEl) catEl.textContent = score100;

            // Update category ring
            const catRing = document.getElementById('catScoreRing');
            if (catRing) {
                const circ = 2 * Math.PI * 54;
                catRing.style.strokeDashoffset = circ - (score100 / 100) * circ;
                catRing.style.stroke = score100 <= 0 ? 'var(--color-border)' : score100 <= 25 ? '#d32f2f' : score100 < 50 ? '#f57c00' : score100 < 75 ? '#7cb342' : '#43a047';
            }

            Object.keys(category.sections).forEach(secKey => {
                const section = category.sections[secKey];
                const sectionScore = calculateSectionScore(catKey, secKey);
                const weightedMax = section.weight * 10;
                const weightedScore = (sectionScore / 10) * weightedMax;
                const percentage = (sectionScore / 10) * 100;
                const isNotStarted = sectionScore === 0;
                const secColor = isNotStarted ? 'not-started' : trafficClass(percentage);
                // Section header score
                const secEl = document.getElementById('secScore-' + secKey);
                if (secEl) {
                    secEl.className = 'section-score-weighted ' + secColor;
                    const cur = secEl.querySelector('.current');
                    if (cur) cur.textContent = Math.round(percentage) + '%';
                }
                // Breakdown bar
                const fillEl = document.getElementById('secFill-' + secKey);
                if (fillEl) {
                    fillEl.style.width = percentage + '%';
                }
                // Breakdown score text
                const bsEl = document.getElementById('secBreakScore-' + secKey);
                if (bsEl) bsEl.textContent = Math.round(percentage) + '%';
            });
        }

        // Update norm rating display for a specific number input (no re-render)
        function updateNormDisplay(catKey, secKey, qId) {
            const q = CATEGORIES[catKey].sections[secKey].questions.find(x => x.id === qId);
            if (!q) return;
            const container = document.getElementById('normRating-' + qId);
            if (!container) return;
            const value = currentData.answers[catKey]?.[secKey]?.[qId];

            // Linear-scored inputs (e.g. wearable sleep score 0-100)
            if (q.inputMin !== undefined && q.inputMax !== undefined && !q.normsTable && !q.genderScoring) {
                if (value !== null && value !== undefined && value !== '') {
                    const v = parseFloat(value);
                    if (v < q.min || v > q.max) {
                        container.innerHTML = '<div class="norm-rating" style="color:var(--color-red);"><i data-lucide="alert-triangle" style="width:14px;height:14px;"></i> Value out of possible range (' + q.min + '–' + q.max + ' ' + (q.unit||'') + ')</div>';
                    } else {
                        let pct = Math.round(((v - q.inputMin) / (q.inputMax - q.inputMin)) * 100);
                        pct = Math.max(0, Math.min(100, pct));
                        pct = Math.round(applyEdgeBarriers(pct, v, q, null));
                        let html = '<div class="norm-rating"><span class="norm-category">Score: ' + pct + '%</span></div>';
                        if (q.edgeFloor !== undefined && v < q.edgeFloor) {
                            html += '<div class="norm-rating" style="color:var(--color-amber);font-size:0.82rem;margin-top:2px;"><i data-lucide="alert-circle" style="width:13px;height:13px;"></i> ' + q.edgeFloorLabel + '</div>';
                        }
                        if (q.edgeCeiling !== undefined && v > q.edgeCeiling) {
                            html += '<div class="norm-rating" style="color:var(--color-amber);font-size:0.82rem;margin-top:2px;"><i data-lucide="alert-circle" style="width:13px;height:13px;"></i> ' + q.edgeCeilingLabel + '</div>';
                        }
                        container.innerHTML = html;
                    }
                    lucide.createIcons();
                } else {
                    container.innerHTML = '';
                }
                return;
            }

            // Gender-specific linear scoring (e.g. HDL, WHR)
            if (q.genderScoring) {
                const demo = getDemographics();
                if (value !== null && value !== undefined && value !== '' && demo.sex) {
                    const v = parseFloat(value);
                    if (v < q.min || v > q.max) {
                        container.innerHTML = '<div class="norm-rating" style="color:var(--color-red);"><i data-lucide="alert-triangle" style="width:14px;height:14px;"></i> Value out of possible range (' + q.min + '–' + q.max + ' ' + (q.unit||'') + ')</div>';
                    } else {
                        const bounds = q.genderScoring[demo.sex] || q.genderScoring['male'];
                        let pct = Math.round(((v - bounds.inputMin) / (bounds.inputMax - bounds.inputMin)) * 100);
                        pct = Math.max(0, Math.min(100, pct));
                        pct = Math.round(applyEdgeBarriers(pct, v, q, bounds));
                        let html = '<div class="norm-rating"><span class="norm-category">Score: ' + pct + '%</span></div>';
                        if (q.edgeCeiling !== undefined && v > q.edgeCeiling) {
                            html += '<div class="norm-rating" style="color:var(--color-amber);font-size:0.82rem;margin-top:2px;"><i data-lucide="alert-circle" style="width:13px;height:13px;"></i> ' + q.edgeCeilingLabel + '</div>';
                        }
                        container.innerHTML = html;
                    }
                    lucide.createIcons();
                } else if (!getDemographics().sex) {
                    container.innerHTML = '<div class="demographics-prompt"><i data-lucide="alert-circle" style="width:16px;height:16px;flex-shrink:0;"></i> Enter your biological sex in the Medical section to see your personalized rating.</div>';
                    lucide.createIcons();
                } else {
                    container.innerHTML = '';
                }
                return;
            }

            if (!q.normsTable) return;
            const demo = getDemographics();
            if (value !== null && value !== undefined && value !== '' && demo.age !== null && demo.sex) {
                const table = q.normsTable === 'VO2MAX_NORMS' ? VO2MAX_NORMS : q.normsTable === 'PUSHUP_NORMS' ? PUSHUP_NORMS : q.normsTable === 'CHAIRSTAND_NORMS' ? CHAIRSTAND_NORMS : null;
                if (table) {
                    container.innerHTML = buildNormRatingHTML(q, table, demo, value);
                }
            } else if (demo.age === null || !demo.sex) {
                container.innerHTML = '<div class="demographics-prompt"><i data-lucide="alert-circle" style="width:16px;height:16px;flex-shrink:0;"></i> Enter your year of birth and sex in the Medical section to see your personalized rating.</div>';
                lucide.createIcons();
            } else {
                container.innerHTML = '';
            }
        }

        function updateScoresAndUI(skipDetailRerender) {
            calculateAllScores();
            saveData();
            renderDimensions();
            updateTotalScore();
            if (activeCategory && !skipDetailRerender) renderCategoryContent(activeCategory);
        }

        // ========================================
        // SWIPE GESTURE
        // ========================================
        function initSwipeGesture() {
            let touchStartX = 0, touchStartY = 0, touchCurrentX = 0;
            const detailView = document.getElementById('detailView');

            detailView.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; touchStartY = e.touches[0].clientY; }, { passive: true });
            detailView.addEventListener('touchmove', e => {
                if (!detailView.classList.contains('active')) return;
                touchCurrentX = e.touches[0].clientX;
                const diffX = touchCurrentX - touchStartX;
                const diffY = Math.abs(e.touches[0].clientY - touchStartY);
                if (diffX > 0 && diffX > diffY && touchStartX < 50) {
                    detailView.style.transform = `translateX(${Math.min(diffX, 100)}px)`;
                    detailView.style.transition = 'none';
                }
            }, { passive: true });
            detailView.addEventListener('touchend', e => {
                const diffX = touchCurrentX - touchStartX;
                detailView.style.transition = 'transform 0.3s ease-out';
                if (diffX > 80 && touchStartX < 50) closeDetailView();
                else detailView.style.transform = '';
                touchStartX = 0; touchCurrentX = 0;
            }, { passive: true });
        }

        // ========================================
        // INITIALIZATION
        // ========================================
        async function initApp() {
            // Load question definitions from external JSON (system data, no client data)
            let jsonLoaded = false;
            try {
                const resp = await fetch('questions.json');
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const qData = await resp.json();
                // Merge externally-defined categories into CATEGORIES
                if (qData.categories) {
                    Object.keys(qData.categories).forEach(catKey => {
                        // Deep-merge: copy coaching + other new properties onto existing questions
                        if (CATEGORIES[catKey] && qData.categories[catKey].sections) {
                            Object.keys(qData.categories[catKey].sections).forEach(secKey => {
                                const jsonSec = qData.categories[catKey].sections[secKey];
                                const inlineSec = CATEGORIES[catKey].sections?.[secKey];
                                if (inlineSec && jsonSec.questions) {
                                    jsonSec.questions.forEach(jsonQ => {
                                        const inlineQ = inlineSec.questions?.find(q => q.id === jsonQ.id);
                                        if (inlineQ) {
                                            // Copy any properties from JSON that aren't in inline
                                            Object.keys(jsonQ).forEach(prop => {
                                                inlineQ[prop] = jsonQ[prop];
                                            });
                                        }
                                    });
                                }
                            });
                        }
                    });
                    jsonLoaded = true;
                }
                // Merge screening guidelines
                if (qData.screeningGuidelines) {
                    Object.keys(qData.screeningGuidelines).forEach(key => {
                        SCREENING_GUIDELINES[key] = qData.screeningGuidelines[key];
                    });
                }
                console.log('[LongevityPath] questions.json merged successfully');
            } catch (e) {
                console.warn('[LongevityPath] Could not load questions.json — using inline defaults:', e.message);
                console.warn('[LongevityPath] Coaching features require questions.json (serve via HTTP, not file://)');
            }

            lucide.createIcons();
            loadData();
            // Recalculate all scores on load (picks up formula changes and cross-section inputs)
            calculateAllScores();
            saveData();
            // Capture baseline scores and answers for this session
            sessionStartScores = { ...currentData.scores };
            sessionStartAnswers = snapshotAnswers();
            document.getElementById('userName').textContent = currentData.userName;
            document.getElementById('lastUpdated').textContent = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            renderDimensions();
            updateTotalScore();
            initSwipeGesture();
            // Restore dimension + scroll position after back-navigation from evidence pages
            restoreScrollState();
        }

        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });
    </script>
</body>
</html>
